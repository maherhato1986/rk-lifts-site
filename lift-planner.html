<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RKL Lift Planner â€” MRL (Plan + Section)</title>
  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --soft:#f8fafc;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--soft); color:var(--ink)}
    header{padding:16px 18px;border-bottom:1px solid var(--line); background:#fff}
    header h1{margin:0;font-size:18px}
    header p{margin:6px 0 0;color:var(--muted);font-size:13px}

    .wrap{max-width:1200px;margin:0 auto;padding:16px 18px}
    .grid{display:grid;grid-template-columns: 360px 1fr; gap:14px}
    .panel{
      background:var(--card); border:1px solid var(--line);
      border-radius:14px; padding:14px;
      box-shadow:0 6px 18px rgba(17,24,39,.06);
    }
    .panel h2{margin:0 0 10px;font-size:15px}
    .row{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    .f{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    label{font-size:12px;color:var(--muted)}
    input, select{
      padding:10px 10px; border:1px solid var(--line); border-radius:10px;
      font-size:14px; outline:none; background:#fff
    }
    input:focus, select:focus{border-color:#94a3b8}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:1px solid var(--line); background:#fff; border-radius:12px;
      padding:10px 12px; font-size:13px; cursor:pointer
    }
    button:hover{background:#f3f4f6}
    .note{font-size:12px;color:var(--muted);line-height:1.6;margin-top:10px}

    .canvas{
      background:var(--card); border:1px solid var(--line); border-radius:14px;
      box-shadow:0 6px 18px rgba(17,24,39,.06);
      overflow:hidden;
    }
    .canvas-head{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; border-bottom:1px solid var(--line)
    }
    .badge{font-size:12px;color:var(--muted)}
    .svgs{display:grid; grid-template-columns: 1fr 1fr; gap:0}
    .svgbox{border-left:1px solid var(--line); padding:12px}
    .svgbox:first-child{border-left:none}
    .svgtitle{font-size:13px;margin:0 0 8px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
      .svgs{grid-template-columns:1fr}
      .svgbox{border-left:none;border-top:1px solid var(--line)}
      .svgbox:first-child{border-top:none}
    }
  </style>
</head>

<body>
<header>
  <h1>Ù…Ø®Ø·Ø· Ø§Ù„Ù…ØµØ¹Ø¯ â€” MRL (Plan + Section)</h1>
  <p>SVG Ù…Ø®Ø·Ø· Ù‡Ù†Ø¯Ø³ÙŠ: Walls + Door + Cabin + Rear CW (Plan) + Side CW (Section) + Rails + Buffers + Governor + ØªØµØ¯ÙŠØ± SVG/PDF</p>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Inputs -->
    <div class="panel">
      <h2>Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø®Ø·Ø· (mm)</h2>

      <div class="f">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Project Name)</label>
        <input id="projectName" type="text" value="RKL - MRL Lift Layout">
      </div>

      <div class="row">
        <div class="f">
          <label>Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø¦Ø± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (Shaft W)</label>
          <input id="shaftW" type="number" value="2000" min="1200" step="10">
        </div>
        <div class="f">
          <label>Ø¹Ù…Ù‚ Ø§Ù„Ø¨Ø¦Ø± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (Shaft D)</label>
          <input id="shaftD" type="number" value="1800" min="1200" step="10">
        </div>
      </div>

      <div class="row">
        <div class="f">
          <label>Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ø¨ÙŠÙ†Ø© (Cabin W)</label>
          <input id="cabinW" type="number" value="1100" min="700" step="10">
        </div>
        <div class="f">
          <label>Ø¹Ù…Ù‚ Ø§Ù„ÙƒØ§Ø¨ÙŠÙ†Ø© (Cabin D)</label>
          <input id="cabinD" type="number" value="1400" min="700" step="10">
        </div>
      </div>

      <div class="row">
        <div class="f">
          <label>Ø¹Ø±Ø¶ ÙØªØ­Ø© Ø§Ù„Ø¨Ø§Ø¨ (Door W)</label>
          <input id="doorW" type="number" value="900" min="600" step="10">
        </div>
        <div class="f">
          <label>Ø³Ù…Ø§ÙƒØ© Ø§Ù„Ø¬Ø¯Ø§Ø± (Wall thk)</label>
          <input id="wallT" type="number" value="200" min="100" step="10">
        </div>
      </div>

      <div class="f">
        <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙƒÙˆÙ†ØªØ±ÙˆÙŠØª ÙÙŠ Ø§Ù„Ù…Ù‚Ø·Ø¹ (CW Side - Section)</label>
        <select id="cwSide">
          <option value="right" selected>ÙŠÙ…ÙŠÙ†</option>
          <option value="left">ÙŠØ³Ø§Ø±</option>
        </select>
      </div>

      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

      <div class="row">
        <div class="f">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆÙ‚ÙØ§Øª (Stops)</label>
          <input id="stops" type="number" value="10" min="2" step="1">
        </div>
        <div class="f">
          <label>Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ÙˆØ§Ø­Ø¯ (Floor height)</label>
          <input id="floorH" type="number" value="3600" min="2500" step="10">
        </div>
      </div>
<div class="f">
  <label>Ø§Ù„ÙˆÙ‚ÙØ© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ Ø§Ù„Ù…Ù‚Ø·Ø¹ (Selected Stop)</label>
  <input id="stopPos" type="range" min="1" max="10" value="5" step="1">
  <div style="display:flex;justify-content:space-between;font-size:12px;color:#6b7280">
    <span>1</span>
    <span id="stopPosLabel">5</span>
    <span id="stopPosMax">10</span>
  </div>
</div>

      <div class="row">
        <div class="f">
          <label>Pit (Ø¹Ù…Ù‚ Ø§Ù„Ø­ÙØ±Ø©)</label>
          <input id="pit" type="number" value="1400" min="800" step="10">
        </div>
        <div class="f">
          <label>OH (Overhead)</label>
          <input id="oh" type="number" value="4200" min="2500" step="10">
        </div>
      </div>

      <div class="btns">
        <button id="btnDraw" type="button">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø·Ø·</button>
        <button id="btnExportSVG" type="button">â¬‡ï¸ ØªØµØ¯ÙŠØ± SVG</button>
        <button id="btnExportPDF" type="button">ğŸ§¾ ØªØµØ¯ÙŠØ± PDF A4</button>
      </div>

      <div class="note">
        âœ… Plan: Ø§Ù„ÙƒÙˆÙ†ØªØ±ÙˆÙŠØª Ø®Ù„ÙÙŠ Rear-Center<br>
        âœ… Section: Ø§Ù„ÙƒÙˆÙ†ØªØ±ÙˆÙŠØª Ø¬Ø§Ù†Ø¨ÙŠ ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø± + Rails + Buffers + Governor + MRL Machine Ø¯Ø§Ø®Ù„ OH<br>
        âœ… PDF: A4 Ù…Ø¹ Ø¥Ø·Ø§Ø± + Watermark (logo) + Ref ØªÙ„Ù‚Ø§Ø¦ÙŠ + QR (Ø¥Ø°Ø§ Ù…ÙƒØªØ¨Ø© QR Ù…ÙˆØ¬ÙˆØ¯Ø©)
      </div>
    </div>

    <!-- Output -->
    <div class="canvas">
      <div class="canvas-head">
        <div class="badge" id="badgeInfo">â€”</div>
        <div class="badge">Plan scale: 1px=5mm | Section scale fitted</div>
      </div>

      <div class="svgs">
        <div class="svgbox">
          <p class="svgtitle">Plan View (Rear CW)</p>
          <svg id="svgPlan" width="100%" viewBox="0 0 520 420" xmlns="http://www.w3.org/2000/svg"></svg>
          <div class="hint">Walls + Door + Cabin + Rear CW + Rails + Dimensions</div>
        </div>

        <div class="svgbox">
          <p class="svgtitle">Section View (MRL + Side CW)</p>
          <svg id="svgSec" width="100%" viewBox="0 0 520 420" xmlns="http://www.w3.org/2000/svg"></svg>
          <div class="hint">OH/Travel/Pit + MRL Machine + Sheave + Ropes + Side CW + Rails + Buffers + Governor</div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* =======================
   Helpers
======================= */
const NS = "http://www.w3.org/2000/svg";
function el(name, attrs = {}) {
  const n = document.createElementNS(NS, name);
  for (const [k,v] of Object.entries(attrs)) n.setAttribute(k, String(v));
  return n;
}
function clear(svg){ while(svg.firstChild) svg.removeChild(svg.firstChild); }
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

function centerLine(svg, x1,y1,x2,y2){
  svg.appendChild(el('line',{x1,y1,x2,y2, stroke:"#6b7280", "stroke-width":"1", "stroke-dasharray":"6 4"}));
}

function dimLine(svg, x1,y1,x2,y2, text, textX, textY){
  svg.appendChild(el('line',{x1,y1,x2,y2, stroke:"#111827", "stroke-width":"1"}));
  const a1 = el('path',{d:`M ${x1} ${y1} l 8 -4 l 0 8 z`, fill:"#111827"});
  const a2 = el('path',{d:`M ${x2} ${y2} l -8 -4 l 0 8 z`, fill:"#111827"});
  svg.appendChild(a1); svg.appendChild(a2);

  const t = el('text',{x:textX, y:textY, "font-size":"12", fill:"#111827"});
  t.textContent = text;
  svg.appendChild(t);
}

function hatchDefs(svg){
  const defs = el('defs');

  const pat = el('pattern',{
    id:"hatch", patternUnits:"userSpaceOnUse", width:"8", height:"8", patternTransform:"rotate(45)"
  });
  pat.appendChild(el('line',{x1:"0",y1:"0",x2:"0",y2:"8", stroke:"#cbd5e1", "stroke-width":"2"}));
  defs.appendChild(pat);

  svg.appendChild(defs);
}

function exportSVG(svg, filename){
  const serializer = new XMLSerializer();
  const source = serializer.serializeToString(svg);
  const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

function generateRklRef(){
  const d = new Date();
  const pad = (n, w=2) => String(n).padStart(w,'0');
  const y = d.getFullYear();
  const m = pad(d.getMonth()+1);
  const day = pad(d.getDate());
  const hh = pad(d.getHours());
  const mm = pad(d.getMinutes());
  const ss = pad(d.getSeconds());
  const rnd = pad(Math.floor(Math.random()*1000), 3);
  return `RKL-MRL-${y}${m}${day}-${hh}${mm}${ss}-${rnd}`;
}

/* =======================
   Draw: Plan (Rear CW)
======================= */
function drawPlan(shaftW, shaftD, cabinW, cabinD, doorW, wallT){
  const svg = document.getElementById('svgPlan');
  clear(svg);
  hatchDefs(svg);

  const scale = 5; // 1px=5mm
  const W = 520, H = 420;
  const pad = 46;

  const innerW = shaftW / scale;
  const innerD = shaftD / scale;

  const maxW = W - pad*2;
  const maxH = H - pad*2;
  const f = Math.min(maxW/innerW, maxH/innerD);

  const sW = innerW * f;
  const sD = innerD * f;

  const x0 = (W - sW)/2;
  const y0 = (H - sD)/2;

  const t = (wallT/scale) * f;

  // walls
  svg.appendChild(el('rect',{x:x0 - t, y:y0 - t, width:sW + 2*t, height:sD + 2*t, fill:"url(#hatch)", stroke:"#111827", "stroke-width":"2"}));
  svg.appendChild(el('rect',{x:x0, y:y0, width:sW, height:sD, fill:"#fff", stroke:"#111827", "stroke-width":"2"}));

  // door opening bottom
  const doorPx = (doorW/scale) * f;
  const doorX = x0 + (sW - doorPx)/2;
  const doorY = y0 + sD;
  svg.appendChild(el('line',{x1:doorX, y1:doorY, x2:doorX+doorPx, y2:doorY, stroke:"#fff", "stroke-width":"6"}));
  svg.appendChild(el('line',{x1:doorX, y1:doorY-10, x2:doorX, y2:doorY+10, stroke:"#111827", "stroke-width":"2"}));
  svg.appendChild(el('line',{x1:doorX+doorPx, y1:doorY-10, x2:doorX+doorPx, y2:doorY+10, stroke:"#111827", "stroke-width":"2"}));
  const dlab = el('text',{x:doorX+doorPx/2, y:doorY+28, "font-size":"12", fill:"#111827", "text-anchor":"middle"});
  dlab.textContent = `DOOR ${doorW}mm`;
  svg.appendChild(dlab);

  // cabin centered
  const cW = (cabinW/scale) * f;
  const cD = (cabinD/scale) * f;
  const cx = x0 + (sW - cW)/2;
  const cy = y0 + (sD - cD)/2;

  svg.appendChild(el('rect',{x:cx, y:cy, width:cW, height:cD, fill:"#f8fafc", stroke:"#111827", "stroke-width":"2", rx:"6"}));
  svg.appendChild(el('rect',{x:cx+6, y:cy+6, width:cW-12, height:cD-12, fill:"#fff", stroke:"#cbd5e1", "stroke-width":"1", rx:"4"}));

  // Rear CW (top side)
  const rearMargin = Math.max(10, sD * 0.06);
  const cwWpx = clamp(sW * 0.12, 22, 44);
  const cwDpx = clamp(sD * 0.10, 18, 36);
  const cwX = x0 + (sW - cwWpx)/2;
  const cwY = y0 + rearMargin;

  svg.appendChild(el('rect',{x:cwX, y:cwY, width:cwWpx, height:cwDpx, fill:"#f8fafc", stroke:"#111827", "stroke-width":"2", rx:"4"}));
  const cwt = el('text',{x:cwX+cwWpx/2, y:cwY-6, "font-size":"11", fill:"#111827", "text-anchor":"middle"});
  cwt.textContent = "CW (REAR)";
  svg.appendChild(cwt);

  // rails
  const railStroke = 1.4, railDash = "6 4";
  const cabRailL = cx - 8;
  const cabRailR = cx + cW + 8;
  svg.appendChild(el('line',{x1:cabRailL, y1:y0, x2:cabRailL, y2:y0+sD, stroke:"#6b7280","stroke-width":railStroke,"stroke-dasharray":railDash}));
  svg.appendChild(el('line',{x1:cabRailR, y1:y0, x2:cabRailR, y2:y0+sD, stroke:"#6b7280","stroke-width":railStroke,"stroke-dasharray":railDash}));

  const cwRailL = cwX - 6;
  const cwRailR = cwX + cwWpx + 6;
  svg.appendChild(el('line',{x1:cwRailL, y1:y0, x2:cwRailL, y2:y0+sD*0.45, stroke:"#6b7280","stroke-width":railStroke,"stroke-dasharray":railDash}));
  svg.appendChild(el('line',{x1:cwRailR, y1:y0, x2:cwRailR, y2:y0+sD*0.45, stroke:"#6b7280","stroke-width":railStroke,"stroke-dasharray":railDash}));

  // center lines
  centerLine(svg, x0, y0 + sD/2, x0 + sW, y0 + sD/2);
  centerLine(svg, x0 + sW/2, y0, x0 + sW/2, y0 + sD);

  // dimensions
  dimLine(svg, x0, y0-24, x0+sW, y0-24, `${shaftW} mm`, x0 + sW/2 - 24, y0-30);
  dimLine(svg, x0-24, y0, x0-24, y0+sD, `${shaftD} mm`, x0-40, y0 + sD/2);

  const title = el('text',{x:14,y:18,"font-size":"13",fill:"#111827"});
  title.textContent = "PLAN VIEW (REAR CW)";
  svg.appendChild(title);
}

/* =======================
   Draw: Section (MRL + Side CW + Rails + Buffers + Governor)
======================= */
function drawSection(travel, pit, oh, shaftW, cabinW, cwSide, selectedStop, stops){

  const svg = document.getElementById('svgSec');
  clear(svg);
  hatchDefs(svg);

  const W = 520, H = 420;
  const pad = 46;

  // ===== Factory line weights =====
  const ST_WALL = 2.6;     // shaft wall
  const ST_OBJ  = 2.0;     // cabin/cw/machine
  const ST_DIM  = 1.0;     // dimensions
  const ST_THIN = 1.2;     // ropes/rails
  const DASH_RAIL = "7 5";

  // ===== Scale / Fit =====
  const mmPerPx = 10;
  const totalH = pit + travel + oh;

  const shaftW_raw = shaftW / mmPerPx;
  const totalH_raw = totalH / mmPerPx;

  const usableW = W - pad*2;
  const usableH = H - pad*2;

  // Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§ÙØª Ø¨ØµØ±ÙŠÙ‹Ø§ Ø­ØªÙ‰ Ù…Ø§ ÙŠØµÙŠØ± â€œÙ†Ø­ÙŠÙâ€
  const minShaftPxW = 210;

  const fit = Math.min(usableW / shaftW_raw, usableH / totalH_raw);
  let shaftPxW = shaftW_raw * fit;
  const shaftPxH = totalH_raw * fit;

  // enforce min width (Factory readability)
  const widenFactor = (shaftPxW < minShaftPxW) ? (minShaftPxW / shaftPxW) : 1;
  shaftPxW *= widenFactor;

  const x0 = (W - shaftPxW)/2;
  const yTop = pad;

  // Ø±Ù…Ø²ÙŠ Ù„Ù„Ø¬Ø¯Ø§Ø±
  const wallT = 18;

  // ===== Zones =====
  const pitH_px    = (pit/mmPerPx) * fit;
  const travelH_px = (travel/mmPerPx) * fit;
  const ohH_px     = (oh/mmPerPx) * fit;

  const yTravelTop = yTop + ohH_px;
  const yPitTop    = yTravelTop + travelH_px;
  const yBottom    = yTop + shaftPxH;

  // ===== Shaft walls =====
  svg.appendChild(el('rect',{
    x:x0-wallT, y:yTop, width:shaftPxW+2*wallT, height:shaftPxH,
    fill:"url(#hatch)", stroke:"#111827", "stroke-width":ST_WALL
  }));
  svg.appendChild(el('rect',{
    x:x0, y:yTop, width:shaftPxW, height:shaftPxH,
    fill:"#fff", stroke:"#111827", "stroke-width":ST_WALL
  }));

  // zone separators
  svg.appendChild(el('line',{x1:x0,y1:yTravelTop,x2:x0+shaftPxW,y2:yTravelTop,stroke:"#cbd5e1","stroke-width":"2"}));
  svg.appendChild(el('line',{x1:x0,y1:yPitTop,x2:x0+shaftPxW,y2:yPitTop,stroke:"#cbd5e1","stroke-width":"2"}));
  svg.appendChild(el('line',{x1:x0,y1:yBottom,x2:x0+shaftPxW,y2:yBottom,stroke:"#111827","stroke-width":ST_WALL}));

  // ===== Layout inside shaft =====
  const marginSide = Math.max(12, shaftPxW*0.06);
  const gap = 14;

  const cwW = clamp(shaftPxW*0.10, 18, 34);
  const cwH = clamp(shaftPxH*0.18, 70, 120);

  const cabinW_px = (cabinW/mmPerPx)*fit;
  const cabH = clamp(shaftPxH*0.16, 70, 110);

  const maxCabW = shaftPxW - (marginSide*2) - cwW - gap;
  const cabW = clamp(cabinW_px, 70, maxCabW);

 // ===== Cabin position by selected stop =====
// selectedStop: 1..stops
// top landing = stop 1 (near yTravelTop)
// bottom landing = stop stops (near yPitTop)
const sStops = Math.max(2, Number(stops || 2));
const sStop  = Math.max(1, Math.min(sStops, Number(selectedStop || Math.ceil(sStops/2))));

// Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø²ÙˆÙ„ Ù…Ù† Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ Ø£Ø³ÙÙ„Ù‡Ø§
const tStop = (sStop - 1) / (sStops - 1);

// Ù†ØªØ±Ùƒ Ù‡ÙˆØ§Ù…Ø´ Ø¨Ø³ÙŠØ·Ø© Ø­ØªÙ‰ Ù„Ø§ ØªÙ„Ù…Ø³ Ø§Ù„ÙƒØ§Ø¨ÙŠÙ†Ø© Ø®Ø·ÙˆØ· Ø§Ù„ØªÙ‚Ø³ÙŠÙ…
const topMargin = 28;
const botMargin = 34;

// Ù…Ø±ÙƒØ² Ø§Ù„ÙƒØ§Ø¨ÙŠÙ†Ø© ÙŠØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù€ Travel
const midY = (yTravelTop + topMargin) + tStop * ((yPitTop - botMargin) - (yTravelTop + topMargin));


  let cwX, cabX;
  if(cwSide === 'left'){
    cwX = x0 + marginSide;
    cabX = cwX + cwW + gap;
  }else{
    cabX = x0 + marginSide;
    cwX = x0 + shaftPxW - cwW - marginSide;
  }

  // Ù…Ø±ÙƒØ² Ø§Ù„ÙƒØ§Ø¨ÙŠÙ†Ø© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚ÙØ©
const cabMidY = midY;

// Ù…Ø±ÙƒØ² Ø§Ù„ÙƒÙˆÙ†ØªØ±ÙˆÙŠØª Ø¹ÙƒØ³ Ø§Ù„ÙƒØ§Ø¨ÙŠÙ†Ø© Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù€ Travel
// Ø§Ù†Ø¹ÙƒØ§Ø³ Ø­ÙˆÙ„ Ù…Ù†ØªØµÙ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³ÙØ± (Ø¨ÙŠÙ† yTravelTop Ùˆ yPitTop)
const travelMidY = (yTravelTop + yPitTop) / 2;
const cwMidY = (2 * travelMidY) - cabMidY;

// Y Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø¹Ù†ØµØ±
const cabY = cabMidY - (cabH / 2);
const cwY  = cwMidY  - (cwH  / 2);


  // ===== Rails (Factory style) =====
  // Cabin rails
  const cabRailL = cabX - 8;
  const cabRailR = cabX + cabW + 8;
  svg.appendChild(el('line',{x1:cabRailL,y1:yTravelTop+6,x2:cabRailL,y2:yBottom-6,stroke:"#6b7280","stroke-width":ST_THIN,"stroke-dasharray":DASH_RAIL}));
  svg.appendChild(el('line',{x1:cabRailR,y1:yTravelTop+6,x2:cabRailR,y2:yBottom-6,stroke:"#6b7280","stroke-width":ST_THIN,"stroke-dasharray":DASH_RAIL}));

  // CW rail (single)
  const cwRailX = cwX + cwW/2;
  svg.appendChild(el('line',{x1:cwRailX,y1:yTravelTop+6,x2:cwRailX,y2:yBottom-6,stroke:"#6b7280","stroke-width":ST_THIN,"stroke-dasharray":DASH_RAIL}));

  // ===== Cabin + CW =====
  svg.appendChild(el('rect',{x:cabX,y:cabY,width:cabW,height:cabH,fill:"#f8fafc",stroke:"#111827","stroke-width":ST_OBJ,rx:"6"}));
  const cabLab = el('text',{x:cabX+cabW/2,y:cabY+cabH+16,"font-size":"11",fill:"#111827","text-anchor":"middle"});
  cabLab.textContent="CABIN";
  svg.appendChild(cabLab);

  svg.appendChild(el('rect',{x:cwX,y:cwY,width:cwW,height:cwH,fill:"#f8fafc",stroke:"#111827","stroke-width":ST_OBJ,rx:"4"}));
  const cwLab = el('text',{x:cwX+cwW/2,y:cwY+cwH+16,"font-size":"11",fill:"#111827","text-anchor":"middle"});
  cwLab.textContent="CW";
  svg.appendChild(cwLab);

  // ===== Buffers (pit) =====
  const bufW = 28, bufH = 18;
  const bufTopY = yBottom - 26;

  // Cabin buffer
  const cabBufX = cabX + cabW/2 - bufW/2;
  svg.appendChild(el('rect',{x:cabBufX,y:bufTopY,width:bufW,height:bufH,fill:"#fff",stroke:"#111827","stroke-width":ST_OBJ,rx:"4"}));

  // CW buffer
  const cwBufX = cwX + cwW/2 - bufW/2;
  svg.appendChild(el('rect',{x:cwBufX,y:bufTopY,width:bufW,height:bufH,fill:"#fff",stroke:"#111827","stroke-width":ST_OBJ,rx:"4"}));

  // ===== Machine + Sheave (OH) =====
  const machW = clamp(shaftPxW*0.42, 110, 170);
  const machH = 42;
  const machX = x0 + marginSide;
  const machY = yTop + Math.max(14, ohH_px*0.12);

  svg.appendChild(el('rect',{x:machX,y:machY,width:machW,height:machH,fill:"#fff",stroke:"#111827","stroke-width":ST_OBJ,rx:"6"}));
  const mtxt = el('text',{x:machX+machW/2,y:machY+machH/2+4,"font-size":"11",fill:"#111827","text-anchor":"middle"});
  mtxt.textContent="MRL MACHINE";
  svg.appendChild(mtxt);

  const shR = 15;
  const shX = machX + machW + 22;
  const shY = machY + machH/2;

  svg.appendChild(el('circle',{cx:shX,cy:shY,r:shR,fill:"#fff",stroke:"#111827","stroke-width":ST_OBJ}));
  svg.appendChild(el('circle',{cx:shX,cy:shY,r:3.5,fill:"#111827"}));

  // short rope lead then vertical bundle (Factory ropes)
  const ropeCount = 4;
  const ropeGap = 4;

  const cabRopeAnchorX = cabX + cabW*0.20;
  const cwRopeAnchorX  = cwX + cwW/2;

  for(let i=0;i<ropeCount;i++){
    const off = (i - (ropeCount-1)/2) * ropeGap;

    // to cabin
    svg.appendChild(el('path',{
      d:`M ${shX-8+off} ${shY+shR} L ${cabRopeAnchorX+off} ${shY+shR+16} L ${cabRopeAnchorX+off} ${cabY+cabH}`,
      fill:"none", stroke:"#111827", "stroke-width":ST_THIN
    }));

    // to CW
    svg.appendChild(el('path',{
      d:`M ${shX+8+off} ${shY+shR} L ${cwRopeAnchorX+off} ${shY+shR+16} L ${cwRopeAnchorX+off} ${cwY+cwH}`,
      fill:"none", stroke:"#111827", "stroke-width":ST_THIN
    }));
  }

  // ===== Governor (OH right) + dashed rope =====
  const govR = 13;
  const govX = x0 + shaftPxW - marginSide - 14;
  const govY = yTop + Math.max(18, ohH_px*0.20);

  svg.appendChild(el('circle',{cx:govX,cy:govY,r:govR,fill:"#fff",stroke:"#111827","stroke-width":ST_OBJ}));
  svg.appendChild(el('circle',{cx:govX,cy:govY,r:3,fill:"#111827"}));
  const gtxt = el('text',{x:govX,y:govY-govR-8,"font-size":"10",fill:"#6b7280","text-anchor":"middle"});
  gtxt.textContent="GOV";
  svg.appendChild(gtxt);

  svg.appendChild(el('line',{
    x1:govX, y1:govY+govR,
    x2:govX, y2:yBottom-6,
    stroke:"#111827", "stroke-width":"1.1", "stroke-dasharray":"4 4"
  }));

  // ===== Controller outside =====
  const ctrlW=66, ctrlH=76;
  const ctrlX = x0 + shaftPxW + 18;
  const ctrlY = yTravelTop + 12;

  svg.appendChild(el('rect',{x:ctrlX,y:ctrlY,width:ctrlW,height:ctrlH,fill:"#fff",stroke:"#111827","stroke-width":ST_OBJ,rx:"6"}));
  const k1 = el('text',{x:ctrlX+ctrlW/2,y:ctrlY+30,"font-size":"11",fill:"#111827","text-anchor":"middle"});
  k1.textContent="CTRL";
  svg.appendChild(k1);
  const k2 = el('text',{x:ctrlX+ctrlW/2,y:ctrlY+50,"font-size":"10",fill:"#6b7280","text-anchor":"middle"});
  k2.textContent="Panel";
  svg.appendChild(k2);

  // ===== Dimensions =====
  const dx1 = x0 + shaftPxW + 96;
  const dx2 = x0 + shaftPxW + 120;

  dimLine(svg, dx2, yTop, dx2, yTop+shaftPxH, `${totalH} mm`, dx2+12, yTop+shaftPxH/2);
  dimLine(svg, dx1, yTop, dx1, yTravelTop, `${oh} mm`, dx1+10, yTop+ohH_px/2);
  dimLine(svg, dx1, yTravelTop, dx1, yPitTop, `${travel} mm`, dx1+10, yTravelTop+travelH_px/2);
  dimLine(svg, dx1, yPitTop, dx1, yBottom, `${pit} mm`, dx1+10, yPitTop+pitH_px/2);

  const yDim = yTop + shaftPxH + 26;
  svg.appendChild(el('line',{x1:x0,y1:yDim,x2:x0+shaftPxW,y2:yDim,stroke:"#111827","stroke-width":ST_DIM}));
  svg.appendChild(el('path',{d:`M ${x0} ${yDim} l 8 -4 l 0 8 z`, fill:"#111827"}));
  svg.appendChild(el('path',{d:`M ${x0+shaftPxW} ${yDim} l -8 -4 l 0 8 z`, fill:"#111827"}));
  const wtxt = el('text',{x:x0+shaftPxW/2,y:yDim-6,"font-size":"12",fill:"#111827","text-anchor":"middle"});
  wtxt.textContent = `SHAFT W = ${shaftW} mm`;
  svg.appendChild(wtxt);

  // Labels
  const title = el('text',{x:14,y:18,"font-size":"13",fill:"#111827"});
  title.textContent = "SECTION VIEW (FACTORY STYLE â€¢ MRL â€¢ SIDE CW)";
  svg.appendChild(title);

  const z1 = el('text',{x:x0+8,y:yTop+16,"font-size":"11",fill:"#6b7280"}); z1.textContent="OH"; svg.appendChild(z1);
  const z2 = el('text',{x:x0+8,y:yTravelTop+16,"font-size":"11",fill:"#6b7280"}); z2.textContent="TRAVEL"; svg.appendChild(z2);
  const z3 = el('text',{x:x0+8,y:yPitTop+16,"font-size":"11",fill:"#6b7280"}); z3.textContent="PIT"; svg.appendChild(z3);
}


/* =======================
   Main draw
======================= */
function draw(){
  const shaftW = Number(document.getElementById('shaftW').value);
  const shaftD = Number(document.getElementById('shaftD').value);
  const cabinW = Number(document.getElementById('cabinW').value);
  const cabinD = Number(document.getElementById('cabinD').value);
  const doorW  = Number(document.getElementById('doorW').value);
  const wallT  = Number(document.getElementById('wallT').value);
  const cwSide = document.getElementById('cwSide')?.value || 'right';

  const stops  = Number(document.getElementById('stops').value);
  // Ø¶Ø¨Ø· Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆÙ‚ÙØ§Øª
const slider = document.getElementById('stopPos');
const stopLbl = document.getElementById('stopPosLabel');
const stopMax = document.getElementById('stopPosMax');

if (slider) {
  slider.max = String(Math.max(2, stops));
  if (Number(slider.value) > Number(slider.max)) slider.value = slider.max;
  if (stopLbl) stopLbl.textContent = slider.value;
  if (stopMax) stopMax.textContent = slider.max;
}
const selectedStop = Number(slider?.value || Math.ceil(stops/2));

  const floorH = Number(document.getElementById('floorH').value);
  const pit    = Number(document.getElementById('pit').value);
  const oh     = Number(document.getElementById('oh').value);

  const travel = (Math.max(stops,2)-1) * floorH;

  // guards
  const cabinW2 = clamp(cabinW, 600, shaftW-200);
  const cabinD2 = clamp(cabinD, 600, shaftD-200);
  const doorW2  = clamp(doorW, 600, shaftW-200);
  const wallT2  = clamp(wallT, 100, 400);

  document.getElementById('badgeInfo').textContent =
    `Shaft ${shaftW}Ã—${shaftD} | Cabin ${cabinW2}Ã—${cabinD2} | Door ${doorW2} | Travel ${travel} | Pit ${pit} | OH ${oh} | Section CW ${cwSide}`;

  drawPlan(shaftW, shaftD, cabinW2, cabinD2, doorW2, wallT2);
  drawSection(travel, pit, oh, shaftW, cabinW2, cwSide, selectedStop, stops);

}

/* =======================
   PDF A4 (Watermark + Ref + QR if available)
   Requirements:
   - Logo: /images/logo.png (change if needed)
   - QR lib (optional but recommended): /js/qrcode.min.js
======================= */
function openA4PrintPDF(){
  const projectName = (document.getElementById('projectName')?.value || 'Lift Layout').trim();
  const refNo = generateRklRef();

  const shaftW = document.getElementById('shaftW')?.value || '';
  const shaftD = document.getElementById('shaftD')?.value || '';
  const cabinW = document.getElementById('cabinW')?.value || '';
  const cabinD = document.getElementById('cabinD')?.value || '';
  const doorW  = document.getElementById('doorW')?.value || '';
  const pit    = document.getElementById('pit')?.value || '';
  const oh     = document.getElementById('oh')?.value || '';
  const stops  = document.getElementById('stops')?.value || '';
  const floorH = document.getElementById('floorH')?.value || '';

  const planSVG = document.getElementById('svgPlan');
  const secSVG  = document.getElementById('svgSec');
  if(!planSVG || !secSVG){
    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø®Ø·Ø·Ø§Øª SVG');
    return;
  }

  const planMarkup = planSVG.outerHTML;
  const secMarkup  = secSVG.outerHTML;

  const now = new Date();
  const dateStr = now.toLocaleDateString('en-GB'); // dd/mm/yyyy

  const logoPath = "/images/logo.png";         // ØºÙŠÙ‘Ø±Ù‡ Ø¥Ø°Ø§ Ø´Ø¹Ø§Ø±Ùƒ Ø¨Ù…Ø³Ø§Ø± Ù…Ø®ØªÙ„Ù
  const qrLibPath = "/js/qrcode.min.js";       // Ø¶Ø¹ Ù…ÙƒØªØ¨Ø© QR Ù‡Ù†Ø§ (Ù…Ø³ØªØ­Ø³Ù†)
  const requestUrl = `${location.origin}/quote-request.html?ref=${encodeURIComponent(refNo)}&project=${encodeURIComponent(projectName)}`;

  const w = window.open('', '_blank');
  if(!w){
    alert('Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©. ÙØ¹Ù‘Ù„ Popups.');
    return;
  }

  w.document.open();
  w.document.write(`
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Print A4 - ${escapeHtml(projectName)}</title>
  <style>
    *{ box-sizing:border-box; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    body{ margin:0; font-family: Arial, system-ui, sans-serif; color:#111827; }
    @page{ size:A4; margin:10mm; }

    .page{
      width:190mm; height:277mm;
      padding:10mm;
      position:relative;
      border:1.2px solid #111827;
      overflow:hidden;
      background:#fff;
    }

    /* Watermark */
    .watermark{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      opacity:0.06;
      z-index:0;
    }
    .watermark img{
      width:140mm;
      height:auto;
      filter:grayscale(100%);
    }

    .content{ position:relative; z-index:1; }

    .hdr{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10mm; border-bottom:1px solid #e5e7eb; padding-bottom:6mm;
    }
    .hdr .left{ width:64%; }
    .hdr .right{ width:36%; text-align:left; direction:ltr; }

    .title{ font-size:16px; font-weight:700; margin:0 0 3mm; }
    .sub{ font-size:11px; color:#374151; margin:0; line-height:1.6; }
    .meta{ font-size:11px; color:#111827; margin-top:2mm; line-height:1.65; }
    .meta b{ font-weight:700; }

    .refbox{
      margin-top:3mm;
      border:1px solid #111827;
      border-radius:4mm;
      padding:3mm;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:4mm;
      background:#fff;
    }
    .refbox .ref{ font-size:11px; line-height:1.5; }
    .refbox .ref .big{ font-size:12px; font-weight:700; letter-spacing:0.2px; }
    .qrwrap{
      width:26mm; height:26mm;
      border:1px solid #111827;
      border-radius:3mm;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:2mm;
      background:#fff;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6mm;
      margin-top: 8mm;
    }
    .card{
      border:1px solid #e5e7eb;
      padding:4mm;
      border-radius:4mm;
      background:#fff;
    }
    .card h3{ margin:0 0 3mm; font-size:12px; }
    .card svg{ width:100%; height:auto; display:block; }

    .ftr{
      position:absolute; bottom:6mm; left:10mm; right:10mm;
      display:flex; justify-content:space-between; align-items:center;
      border-top:1px solid #e5e7eb; padding-top:4mm;
      font-size:10px; color:#6b7280;
      z-index:1;
      background:transparent;
    }

    .logoTop img{ width:24mm; height:auto; }
  </style>
</head>
<body>
  <div class="page">
    <div class="watermark">
      <img src="${logoPath}" alt="Watermark Logo" onerror="this.style.display='none'">
    </div>

    <div class="content">
      <div class="hdr">
        <div class="left">
          <p class="title">${escapeHtml(projectName)}</p>
          <p class="sub">MRL Lift Layout â€” (Plan + Section) â€” A4 PDF Output</p>

          <div class="meta">
            <div><b>Date:</b> ${escapeHtml(dateStr)} &nbsp;&nbsp; <b>Ref:</b> ${escapeHtml(refNo)}</div>
            <div><b>Stops:</b> ${escapeHtml(stops)} | <b>Floor H:</b> ${escapeHtml(floorH)} mm</div>
            <div><b>Shaft:</b> ${escapeHtml(shaftW)}Ã—${escapeHtml(shaftD)} mm | <b>Cabin:</b> ${escapeHtml(cabinW)}Ã—${escapeHtml(cabinD)} mm</div>
            <div><b>Door:</b> ${escapeHtml(doorW)} mm | <b>Pit:</b> ${escapeHtml(pit)} mm | <b>OH:</b> ${escapeHtml(oh)} mm</div>
          </div>

          <div class="refbox">
            <div class="ref">
              <div>Reference No.</div>
              <div class="big">${escapeHtml(refNo)}</div>
              <div style="color:#6b7280;font-size:10px;margin-top:1mm;">QR opens request link</div>
            </div>
            <div class="qrwrap">
              <div id="qr"></div>
            </div>
          </div>

          <div style="font-size:10px;color:#6b7280;margin-top:2mm;direction:ltr">
            ${escapeHtml(requestUrl)}
          </div>
        </div>

        <div class="right">
          <div class="logoTop">
            <img src="${logoPath}" alt="RKL Logo" onerror="this.style.display='none'">
          </div>
          <div style="font-size:12px;font-weight:700;">RKL Lifts & Escalators</div>
          <div style="font-size:10px;color:#6b7280;margin-top:2mm;">
            Layout Sheet (A4)<br/>
            Generated from Web Planner
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>PLAN VIEW</h3>
          ${planMarkup}
        </div>

        <div class="card">
          <h3>SECTION VIEW (MRL)</h3>
          ${secMarkup}
        </div>
      </div>
    </div>

    <div class="ftr">
      <div>Ref: ${escapeHtml(refNo)}</div>
      <div>Page 1 / 1</div>
    </div>
  </div>

  <script src="${qrLibPath}"><\/script>
  <script>
    (function(){
      const url = ${JSON.stringify(requestUrl)};
      const el = document.getElementById('qr');

      // Ø¥Ø°Ø§ Ù…ÙƒØªØ¨Ø© QR Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù†ÙˆÙ„Ù‘Ø¯ QR Ù…ÙˆØ«ÙˆÙ‚ 100%
      if(window.QRCode && el){
        new QRCode(el, { text:url, width:96, height:96, correctLevel: QRCode.CorrectLevel.M });
      }else{
        // fallback: Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ù…ÙƒØªØ¨Ø©
        el.innerHTML = '<div style="font-size:9px;line-height:1.3;text-align:center">QR lib missing<br/>/js/qrcode.min.js</div>';
      }

      window.onload = () => { window.focus(); window.print(); };
    })();
  <\/script>
</body>
</html>
  `);
  w.document.close();
}

/* =======================
   Events (bind once)
======================= */
document.getElementById('btnDraw').addEventListener('click', draw);

document.getElementById('btnExportSVG').addEventListener('click', () => {
  exportSVG(document.getElementById('svgPlan'), 'lift-plan.svg');
  exportSVG(document.getElementById('svgSec'), 'lift-section.svg');
});
document.getElementById('stopPos')?.addEventListener('input', () => {
  const lbl = document.getElementById('stopPosLabel');
  const slider = document.getElementById('stopPos');
  if (lbl && slider) lbl.textContent = slider.value;
  draw();
});

document.getElementById('btnExportPDF').addEventListener('click', openA4PrintPDF);

// init
draw();
</script>
</body>
</html>
