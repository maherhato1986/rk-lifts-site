<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>عرض سعر توريد وتركيب مصعد - RKL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f2f4f7;
            margin: 0;
            padding: 20px;
            color: #222;
        }

        .page {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.08);
            padding: 25px 35px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .logo-box {
            text-align: right;
        }

        .logo-box .company-name {
            font-weight: 700;
            font-size: 18px;
        }

        .logo-box .company-sub {
            font-size: 12px;
            color: #666;
        }

        .offer-meta {
            text-align: left;
            font-size: 12px;
            line-height: 1.6;
        }

        h1.title {
            text-align: center;
            font-size: 18px;
            margin: 10px 0 20px;
        }

        .section-title {
            font-weight: 700;
            margin: 18px 0 8px;
            font-size: 14px;
            border-right: 4px solid #0d6efd;
            padding-right: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            vertical-align: top;
        }

        th {
            background: #f7f7f7;
            font-weight: 600;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 12px;
        }

        .editable {
            outline: none;
        }

        .note-box {
            font-size: 12px;
            background: #f8fafc;
            border: 1px dashed #cbd5f5;
            padding: 8px 10px;
            margin-top: 6px;
        }

        .terms p {
            font-size: 12px;
            margin: 4px 0;
            text-align: justify;
        }

        .signature-row {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .btn-print {
            display: inline-block;
            margin: 15px auto 0;
            padding: 8px 18px;
            font-size: 13px;
            background: #0d6efd;
            color: #fff;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .warning {
            color: #b91c1c;
            font-size: 12px;
            margin-bottom: 10px;
        }

        @media print {
            body {
                background: #fff;
                padding: 0;
            }
            .page {
                box-shadow: none;
                margin: 0;
                width: 100%;
            }
            .btn-print {
                display: none;
            }
        }
    </style>
</head>
<body>

<div class="page">

    <div class="header">
        <div class="logo-box editable" contenteditable="true">
            <div class="company-name">آر كي ال RKL للمصاعد والسلالم الكهربائية</div>
            <div class="company-sub">
                السجل التجاري: 1010709355 – الرقم الضريبي: 302250422600003<br/>
                الرياض – حي السليمانية – هاتف: 0114774021 – بريد: admin@rk-lifts.com
            </div>
        </div>
        <div class="offer-meta">
            <div>رقم العرض: <span id="meta_quote_number">—</span></div>
            <div>تاريخ العرض: <span id="meta_date">—</span></div>
        </div>
    </div>

    <h1 class="title">عرض سعر توريد وتركيب وتشغيل مصعد كهربائي</h1>

    <div class="section-title">أولاً: بيانات العميل والمشروع</div>
    <table>
        <tbody>
        <tr>
            <th style="width: 20%;">اسم العميل</th>
            <td id="customer_name" class="editable" contenteditable="true">—</td>
            <th style="width: 20%;">جهة العمل</th>
            <td id="customer_type" class="editable" contenteditable="true">—</td>
        </tr>
        <tr>
            <th>اسم المشروع</th>
            <td id="project_name" class="editable" contenteditable="true">—</td>
            <th>المدينة</th>
            <td id="project_city" class="editable" contenteditable="true">—</td>
        </tr>
        <tr>
            <th>العنوان</th>
            <td id="project_address" colspan="3" class="editable" contenteditable="true">—</td>
        </tr>
        <tr>
            <th>وسائل التواصل</th>
            <td colspan="3" class="editable" contenteditable="true" id="contact_info">—</td>
        </tr>
        </tbody>
    </table>

    <div class="section-title">ثانياً: الملخص الفني للمصعد المقترح</div>
    <div class="two-col">
        <table>
            <tbody>
            <tr>
                <th style="width: 35%;">الماركة / النظام</th>
                <td id="tech_brand" class="editable" contenteditable="true">—</td>
            </tr>
            <tr>
                <th>الحمولة الاسمية</th>
                <td id="tech_capacity" class="editable" contenteditable="true">—</td>
            </tr>
            <tr>
                <th>السرعة</th>
                <td id="tech_speed" class="editable" contenteditable="true">—</td>
            </tr>
            <tr>
                <th>عدد الأدوار (Stops)</th>
                <td id="tech_floors" class="editable" contenteditable="true">—</td>
            </tr>
            <tr>
                <th>عدد المصاعد بنفس المواصفات</th>
                <td id="tech_lifts_count" class="editable" contenteditable="true">—</td>
            </tr>
            <tr>
                <th>تصميم الكابينة الداخلية</th>
                <td id="tech_cabin_design" class="editable" contenteditable="true">—</td>
            </tr>
            <tr>
                <th>تشطيب الأرضية</th>
                <td id="tech_floor_finish" class="editable" contenteditable="true">—</td>
            </tr>
            </tbody>
        </table>

        <table>
            <thead>
            <tr>
                <th colspan="2">مقاسات المقصورة والبئر (يمكن تعديلها)</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <th style="width: 40%;">مقاس الكابينة (mm)</th>
                <td id="dim_cabin" class="editable" contenteditable="true">حسب EN81 أو رسومات العميل</td>
            </tr>
            <tr>
                <th>مقاس البئر (mm)</th>
                <td id="dim_shaft" class="editable" contenteditable="true">—</td>
            </tr>
            <tr>
                <th>الباب (Door)</th>
                <td class="editable" contenteditable="true">—</td>
            </tr>
            <tr>
                <th>Pit / OH</th>
                <td class="editable" contenteditable="true">حسب المعايير أو حسب حالة الموقع</td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="section-title">ثالثاً: قيمة العرض المالي</div>
    <table>
        <thead>
        <tr>
            <th style="width: 35%;">البند</th>
            <th style="width: 20%;">عدد الوحدات</th>
            <th style="width: 20%;">سعر الوحدة</th>
            <th style="width: 25%;">الإجمالي</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="editable" contenteditable="true">
                توريد وتركيب وتشغيل مصعد ركاب كامل حسب المواصفات أعلاه
            </td>
            <td id="price_units">1</td>
            <td id="price_unit_value" class="editable" contenteditable="true">—</td>
            <td id="price_total_value">—</td>
        </tr>
        </tbody>
        <tfoot>
        <tr>
            <th colspan="3">الإجمالي شامل ضريبة القيمة المضافة (%<span id="price_vat_rate">15</span>)</th>
            <th id="price_grand_total">—</th>
        </tr>
        </tfoot>
    </table>

    <div class="note-box editable" contenteditable="true">
        ملاحظة: الأسعار أعلاه مبنية على الأسعار الحالية للمواد والخدمات، وقد تتغير في حال تغير أسعار الصرف أو تكاليف الشحن أو الرسوم الحكومية.
    </div>

    <div class="section-title">رابعاً: جدول الدفعات المقترح</div>
    <table>
        <thead>
        <tr>
            <th style="width: 45%;">البيان</th>
            <th style="width: 15%;">النسبة</th>
            <th style="width: 40%;">المبلغ بالريال السعودي</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="editable" contenteditable="true">عند توقيع العقد</td>
            <td>50%</td>
            <td id="pay_50">—</td>
        </tr>
        <tr>
            <td class="editable" contenteditable="true">عند الانتهاء من الأعمال الميكانيكية</td>
            <td>25%</td>
            <td id="pay_25">—</td>
        </tr>
        <tr>
            <td class="editable" contenteditable="true">بعد الانتهاء من الأعمال الكهربائية والتشغيل</td>
            <td>20%</td>
            <td id="pay_20">—</td>
        </tr>
        <tr>
            <td class="editable" contenteditable="true">عند التسليم النهائي</td>
            <td>5%</td>
            <td id="pay_5">—</td>
        </tr>
        <tr>
            <th>الإجمالي (شامل ضريبة القيمة المضافة)</th>
            <th>100%</th>
            <th id="pay_total">—</th>
        </tr>
        </tbody>
    </table>

    <div class="section-title">خامساً: الشروط العامة</div>
    <div class="terms editable" contenteditable="true">
        <p>1- تشمل الأسعار توريد وتركيب وتشغيل المصعد كاملاً حسب المواصفات المعتمدة، ولا تشمل أية أعمال مدنية أو تعديلات إنشائية ما لم يُنص على ذلك في هذا العرض.</p>
        <p>2- يجب توفير التغذية الكهربائية المطلوبة للمصعد (3 فاز 380V – 60Hz) حتى غرفة الماكينة أو لوحة التحكم من قبل العميل.</p>
        <p>3- مدة التوريد المتوقعة من تاريخ استلام الدفعة الأولى وتأكيد المخططات من قبل الاستشاري هي (8–12) أسبوعاً، حسب حالة المصنع والشحن.</p>
        <p>4- مدة التركيب والتشغيل تعتمد على جاهزية البئر والأعمال المدنية، وبمتوسط (2–4) أسابيع لكل مصعد.</p>
        <p>5- الضمان لمدة (12) شهراً من تاريخ التشغيل الأولي، ويشمل العيوب المصنعية دون سوء الاستخدام أو الإهمال أو التعديلات من طرف ثالث.</p>
        <p>6- يعتبر هذا العرض سارياً لمدة (30) يوماً من تاريخ إصداره ما لم يتم تعديله أو سحبه خطياً من قبل مؤسسة آر كي ال RKL.</p>
    </div>

    <div class="signature-row">
        <div class="editable" contenteditable="true">
            ممثل مؤسسة آر كي ال RKL للمصاعد والسلالم الكهربائية<br/>
            الاسم: _______________________<br/>
            التوقيع: _______________________
        </div>
        <div class="editable" contenteditable="true">
            ممثل العميل الكريم<br/>
            الاسم: _______________________<br/>
            التوقيع: _______________________
        </div>
    </div>

    <button class="btn-print" onclick="window.print()">طباعة / حفظ PDF</button>

    <div id="warn_no_data" class="warning" style="display:none;">
        لم يتم العثور على بيانات عرض أخير (rkl_last_offer). الرجاء العودة إلى صفحة التسعير وحفظ عرض السعر أولاً.
    </div>

</div>

<script>
    function formatCurrency(value, currency) {
        if (value == null || isNaN(value)) return "—";
        const num = Number(value);
        const formatted = num.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        if (currency === "USD") {
            return "USD " + formatted;
        }
        return "SAR " + formatted;
    }

    document.addEventListener("DOMContentLoaded", () => {
        const raw = localStorage.getItem("rkl_last_offer");
        if (!raw) {
            document.getElementById("warn_no_data").style.display = "block";
            return;
        }

        let offer;
        try {
            offer = JSON.parse(raw);
        } catch (e) {
            console.error("Error parsing rkl_last_offer", e);
            document.getElementById("warn_no_data").style.display = "block";
            return;
        }

        // meta
        document.getElementById("meta_quote_number").textContent = offer.quoteNumber || "—";
        const dateStr = offer.project?.date ? offer.project.date.slice(0, 10) : "";
        document.getElementById("meta_date").textContent = dateStr || "—";

        // customer & project
        document.getElementById("customer_name").textContent = offer.customer?.name || "—";
        document.getElementById("customer_type").textContent = offer.customer?.type || "—";
        document.getElementById("project_name").textContent = offer.project?.name || "—";
        document.getElementById("project_city").textContent = offer.customer?.city || "—";

        const addrParts = [
            offer.customer?.city,
            offer.customer?.district,
            offer.customer?.street,
            offer.customer?.address
        ].filter(Boolean);
        document.getElementById("project_address").textContent = addrParts.join(" - ") || "—";

        const contactParts = [
            offer.customer?.mobile ? "جوال: " + offer.customer.mobile : "",
            offer.customer?.email ? "بريد: " + offer.customer.email : ""
        ].filter(Boolean);
        document.getElementById("contact_info").textContent = contactParts.join(" | ") || "—";

        // technical
        document.getElementById("tech_brand").textContent = offer.project?.brandLabel || "—";
        document.getElementById("tech_capacity").textContent = offer.project?.capacity
            ? offer.project.capacity + " kg"
            : "—";
        document.getElementById("tech_speed").textContent = offer.project?.speed
            ? offer.project.speed + " m/s"
            : "—";
        document.getElementById("tech_floors").textContent = offer.project?.floors ?? "—";
        document.getElementById("tech_lifts_count").textContent = offer.project?.liftsCount ?? "—";

        document.getElementById("tech_cabin_design").textContent =
            offer.cabin?.design || "Standard";
        document.getElementById("tech_floor_finish").textContent =
            offer.cabin?.floorFinish || "Standard";

        // dimensions (لو لاحقاً خزناها في offer.dimensions)
        if (offer.dimensions && offer.dimensions.en81) {
            const en = offer.dimensions.en81;
            const cabin = en.cabinSize || "";
            const shaft = en.shaftSize || "";
            if (cabin) document.getElementById("dim_cabin").textContent = cabin;
            if (shaft) document.getElementById("dim_shaft").textContent = shaft;
        }

        // pricing
        const totalWithVat = offer.pricing?.totalWithVat ?? null;
        const currency = offer.pricing?.currency || "SAR";
        const vatRate = offer.pricing?.vatRate ?? 15;

        document.getElementById("price_vat_rate").textContent = vatRate;
        document.getElementById("price_units").textContent = offer.project?.liftsCount ?? 1;
        document.getElementById("price_grand_total").textContent = formatCurrency(totalWithVat, currency);
        document.getElementById("pay_total").textContent = formatCurrency(totalWithVat, currency);

        if (totalWithVat != null && offer.project?.liftsCount) {
            const perLift = Number(totalWithVat) / Number(offer.project.liftsCount);
            document.getElementById("price_unit_value").textContent = formatCurrency(perLift, currency);
            document.getElementById("price_total_value").textContent = formatCurrency(totalWithVat, currency);
        }

        // payments
        if (totalWithVat != null) {
            const t = Number(totalWithVat);
            const p50 = t * 0.50;
            const p25 = t * 0.25;
            const p20 = t * 0.20;
            const p5  = t * 0.05;

            document.getElementById("pay_50").textContent = formatCurrency(p50, currency);
            document.getElementById("pay_25").textContent = formatCurrency(p25, currency);
            document.getElementById("pay_20").textContent = formatCurrency(p20, currency);
            document.getElementById("pay_5").textContent  = formatCurrency(p5,  currency);
        }

        // يمكن مستقبلاً استخدام offer.quoteText في صفحة مستقلة كمقدمة خطاب
        // أو إدراجه في أعلى الصفحة حسب ما تفضل.
    });
</script>

</body>
</html>
