<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>عرض سعر / عقد توريد وتركيب وتشغيل مصعد</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        body {
            font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 20px;
            color: #111827;
        }

        .page {
            max-width: 900px;
            margin: 0 auto 30px auto;
            background: #ffffff;
            box-shadow: 0 0 8px rgba(15,23,42,0.08);
            padding: 25px 35px;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }

        .logo-box {
            text-align: right;
            font-size: 12px;
        }

        .logo-title {
            font-weight: 700;
            font-size: 18px;
        }

        .logo-sub {
            font-size: 11px;
            color: #6b7280;
            line-height: 1.5;
        }

        .offer-meta {
            text-align: left;
            font-size: 11px;
            line-height: 1.6;
        }

        h1.main-title {
            text-align: center;
            font-size: 18px;
            margin: 8px 0 15px;
        }

        .section-title {
            font-weight: 700;
            font-size: 14px;
            margin: 18px 0 8px;
            border-right: 4px solid #2563eb;
            padding-right: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th, td {
            border: 1px solid #d1d5db;
            padding: 6px 8px;
            vertical-align: top;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
        }

        .two-col {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .editable {
            outline: none;
        }

        .small-note {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }

        .terms p {
            font-size: 11.5px;
            margin: 4px 0;
            text-align: justify;
        }

        .signature-row {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .btn-print {
            display: inline-block;
            margin: 10px auto 0;
            padding: 8px 18px;
            font-size: 13px;
            background: #2563eb;
            color: #fff;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .warning {
            color: #b91c1c;
            font-size: 11.5px;
            margin-top: 8px;
        }

        .page-index {
            position: absolute;
            left: 35px;
            bottom: 8px;
            font-size: 11px;
            color: #9ca3af;
        }

        .spec-table th:nth-child(1),
        .spec-table td:nth-child(1) {
            width: 6%;
            text-align: center;
        }

        .spec-table th:nth-child(2),
        .spec-table td:nth-child(2) {
            width: 44%;
        }

        .spec-table th:nth-child(3),
        .spec-table td:nth-child(3) {
            width: 18%;
            text-align: center;
        }

        .spec-table th:nth-child(4),
        .spec-table td:nth-child(4) {
            width: 32%;
        }

        /* صفحة المخطط */
        .diagram-container {
            margin-top: 15px;
            display: flex;
            justify-content: center;
        }

        .shaft {
            position: relative;
            border: 2px solid #4b5563;
            width: 260px;
            height: 340px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
        }

        .cabin {
            border: 2px solid #10b981;
            background: #ecfdf5;
            width: 65%;
            height: 55%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            text-align: center;
        }

        .dim-label {
            position: absolute;
            font-size: 11px;
            color: #111827;
            background: rgba(255,255,255,0.9);
            padding: 1px 4px;
        }

        .dim-top {
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
        }

        .dim-right {
            right: -5px;
            top: 50%;
            transform: translate(100%, -50%) rotate(-90deg);
            transform-origin: left top;
        }

        .caption {
            font-size: 11px;
            text-align: center;
            margin-top: 6px;
            color: #4b5563;
        }

        @media print {
            body {
                background: #ffffff;
                padding: 0;
            }
            .page {
                margin: 0;
                width: 100%;
                box-shadow: none;
                page-break-after: always;
            }
            .btn-print {
                display: none;
            }
        }
    </style>
</head>
<body>
<div class="quote-selector-box" style="
    padding: 15px;
    background: #f8f8f8;
    border-radius: 10px;
    margin: 20px auto;
    max-width: 900px;
    border: 1px solid #ddd;
">
    <label style="font-weight: bold;">اختر عرض سعر من السجل:</label>
    <select id="quote-selector" style="width:100%; padding:10px; margin-top:8px;">
        <option value="">— اختر عرض سعر —</option>
    </select>
</div>

<!-- ================= صفحة 1: تعريف RKL + ملف العميل ================= -->
<div class="page">
    <div class="header">
        <div class="logo-box editable" contenteditable="true">
            <div class="logo-title">آر كي ال RKL للمصاعد والسلالم الكهربائية</div>
            <div class="logo-sub">
                السجل التجاري: 1010709355 – الرقم الضريبي: 302250422600003<br/>
                العنوان: السليمانية – الرياض – هاتف: 0114774021 – بريد: admin@rk-lifts.com
            </div>
        </div>
        <div class="offer-meta">
            <div>رقم العرض: <span class="bind_quote_number">—</span></div>
            <div>تاريخ العرض: <span class="bind_offer_date">—</span></div>
        </div>
    </div>

    <h1 class="main-title">عرض سعر توريد وتركيب وتشغيل مصعد كهربائي</h1>

    <div class="section-title">أولاً: نبذة عن مؤسسة آر كي ال RKL</div>
    <p class="small-note editable" contenteditable="true">
        مؤسسة سعودية متخصصة في توريد وتركيب وصيانة المصاعد والسلالم الكهربائية، تعمل وفق أعلى معايير الجودة
        والسلامة، وتمتلك شراكات مع مصانع عالمية، مع خبرة في تنفيذ مشاريع حكومية وخاصة في مختلف مناطق المملكة.
    </p>

    <div class="section-title">ثانياً: ملف العميل</div>
    <table>
        <tbody>
        <tr>
            <th style="width: 18%;">نوع العميل</th>
            <td class="bind_customer_type">—</td>
            <th style="width: 18%;">اسم العميل</th>
            <td class="bind_customer_name">—</td>
        </tr>
        <tr>
            <th>اسم المخول بالتوقيع</th>
            <td class="bind_contact_person">—</td>
            <th>رقم الهوية / الإقامة</th>
            <td class="bind_id_number">—</td>
        </tr>
        <tr>
            <th>السجل التجاري</th>
            <td class="bind_cr_number">—</td>
            <th>الرقم الضريبي</th>
            <td class="bind_tax_number">—</td>
        </tr>
        <tr>
            <th>المدينة</th>
            <td class="bind_city">—</td>
            <th>الحي</th>
            <td class="bind_district">—</td>
        </tr>
        <tr>
            <th>الشارع</th>
            <td class="bind_street">—</td>
            <th>رقم المبنى</th>
            <td class="bind_building_no">—</td>
        </tr>
        <tr>
            <th>الرمز البريدي</th>
            <td class="bind_postal_code">—</td>
            <th>وصف العنوان المختصر</th>
            <td class="bind_full_address">—</td>
        </tr>
        <tr>
            <th>الجوال</th>
            <td class="bind_mobile">—</td>
            <th>هاتف ثابت</th>
            <td class="bind_phone">—</td>
        </tr>
        <tr>
            <th>البريد الإلكتروني</th>
            <td class="bind_email" colspan="3">—</td>
        </tr>
        <tr>
            <th>وسيلة التواصل المفضلة</th>
            <td class="bind_preferred_contact">—</td>
            <th>ملاحظات داخلية</th>
            <td class="bind_notes">—</td>
        </tr>
        </tbody>
    </table>

    <div class="page-index">Page 1</div>
</div>

<!-- ================= صفحة 2: مشاريع وخبرة RKL ================= -->
<div class="page">
    <div class="header">
        <div class="logo-box">
            <div class="logo-title">مشاريع وخبرة مؤسسة RKL</div>
            <div class="logo-sub">Elevator Installations & Maintenance Projects in Saudi Arabia</div>
        </div>
        <div class="offer-meta">
            <div>العميل: <span class="bind_customer_name">—</span></div>
            <div>المشروع: <span class="bind_project_name">—</span></div>
        </div>
    </div>

    <div class="section-title">١) ملخص خبرة RKL في المملكة</div>
    <p class="small-note editable" contenteditable="true">
        نفذت مؤسسة RKL عددًا من مشاريع المصاعد في مختلف مناطق المملكة، تشمل مباني حكومية، ومجمعات سكنية،
        ومراكز تجارية، ومستشفيات، ومدارس. يوضح الجدول التالي نموذجًا لبعض المشاريع المرجعية، ويمكن تعديله
        حسب متطلبات كل عرض سعر.
    </p>

    <div class="section-title">٢) عينة من مشاريع RKL (قابلة للتعديل)</div>
    <table>
        <thead>
        <tr>
            <th style="width: 6%;">#</th>
            <th style="width: 34%;">اسم المشروع</th>
            <th style="width: 20%;">المدينة</th>
            <th style="width: 20%;">نوع العمل</th>
            <th style="width: 20%;">عدد المصاعد</th>
        </tr>
        </thead>
        <tbody class="editable" contenteditable="true">
        <tr>
            <td>1</td>
            <td>مشروع مصاعد مباني القطاع الشرقي</td>
            <td>الدمام</td>
            <td>توريد وتركيب</td>
            <td>8 مصاعد ركاب</td>
        </tr>
        <tr>
            <td>2</td>
            <td>مشروع مباني تعليم المدينة – الحرة الشرقية</td>
            <td>المدينة المنورة</td>
            <td>استبدال وتحديث</td>
            <td>4 مصاعد ركاب</td>
        </tr>
        <tr>
            <td>3</td>
            <td>مشروع أبراج سكنية خاصة</td>
            <td>الرياض</td>
            <td>توريد وتركيب وصيانة</td>
            <td>10 مصاعد</td>
        </tr>
        </tbody>
    </table>

    <div class="small-note editable" contenteditable="true">
        يمكن لمندوب المبيعات تعديل المشاريع أعلاه أو إضافة مشاريع جديدة لتناسب نوع القطاع (سكني، تجاري، طبي، مدارس، إلخ).
    </div>

    <div class="page-index">Page 2</div>
</div>

<!-- ================= صفحة 3: المواصفات الفنية العامة ================= -->
<div class="page">
    <div class="header">
        <div class="logo-box">
            <div class="logo-title">المواصفات الفنية العامة للمصعد</div>
            <div class="logo-sub">General Specifications</div>
        </div>
        <div class="offer-meta">
            <div>Offer No: <span class="bind_quote_number">—</span></div>
            <div>Date: <span class="bind_offer_date">—</span></div>
        </div>
    </div>

    <div class="section-title">٣) البيانات الفنية الرئيسية</div>
    <table class="spec-table">
        <thead>
        <tr>
            <th>م</th>
            <th>البند</th>
            <th>القيمة</th>
            <th>ملاحظات</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>1</td>
            <td>ماركة المصعد / النظام</td>
            <td class="bind_brand">—</td>
            <td class="editable" contenteditable="true">حسب العرض المعتمد</td>
        </tr>
        <tr>
            <td>2</td>
            <td>نوع الماكينة</td>
            <td class="editable" contenteditable="true">Traction – MRL</td>
            <td>حسب اتفاق المورد</td>
        </tr>
        <tr>
            <td>3</td>
            <td>الحمولة الاسمية (kg)</td>
            <td class="bind_capacity">—</td>
            <td>حسب عدد الأشخاص المطلوب</td>
        </tr>
        <tr>
            <td>4</td>
            <td>السرعة (m/s)</td>
            <td class="bind_speed">—</td>
            <td>ركاب</td>
        </tr>
        <tr>
            <td>5</td>
            <td>عدد التوقفات (Stops)</td>
            <td class="bind_floors">—</td>
            <td>حسب مخططات المشروع</td>
        </tr>
        <tr>
            <td>6</td>
            <td>عدد المصاعد بهذه المواصفات</td>
            <td class="bind_lifts">—</td>
            <td></td>
        </tr>
        <tr>
            <td>7</td>
            <td>مقاس الكابينة (mm)</td>
            <td class="bind_dim_cabin">—</td>
            <td>طبقاً لجدول EN81 أو التصميم المعتمد</td>
        </tr>
        <tr>
            <td>8</td>
            <td>مقاس بئر المصعد (mm)</td>
            <td class="bind_dim_shaft">—</td>
            <td>طبقاً لجدول EN81 أو حالة الموقع</td>
        </tr>
        <tr>
            <td>9</td>
            <td>عمق الحفرة Pit</td>
            <td class="bind_pit">—</td>
            <td></td>
        </tr>
        <tr>
            <td>10</td>
            <td>ارتفاع أعلى البئر OH</td>
            <td class="bind_oh">—</td>
            <td></td>
        </tr>
        <tr>
            <td>11</td>
            <td>تشطيب الكابينة الداخلية</td>
            <td class="bind_cabin_design">Standard</td>
            <td class="editable" contenteditable="true">يمكن تعديلها إلى تصميم خاص</td>
        </tr>
        <tr>
            <td>12</td>
            <td>تشطيب أرضية الكابينة</td>
            <td class="bind_floor_finish">Standard</td>
            <td class="editable" contenteditable="true">جرانيت / رخام حسب الاتفاق</td>
        </tr>
        </tbody>
    </table>

    <div class="page-index">Page 3</div>
</div>
<div class="page">
  <div class="section-title">جدول المصاعد المختارة</div>

  <table id="elevators-items" class="spec-table">
    <thead>
      <tr>
        <th>#</th>
        <th>رقم المصعد</th>
        <th>الحمولة (kg)</th>
        <th>السرعة (m/s)</th>
        <th>عدد التوقفات</th>
        <th>نوع الماكينة</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="page-index">Page X</div>
</div>

<!-- ================= صفحة 4: ميزات الأمان + مخطط المقاسات ================= -->
<div class="page">
    <div class="header">
        <div class="logo-box">
            <div class="logo-title">ميزات الأمان والملحقات</div>
            <div class="logo-sub">Security, Safety & Additional Features</div>
        </div>
        <div class="offer-meta">
            <div>Offer No: <span class="bind_quote_number">—</span></div>
            <div>Date: <span class="bind_offer_date">—</span></div>
        </div>
    </div>

    <div class="section-title">٤) ميزات الأمان القياسية</div>
    <table class="spec-table">
        <thead>
        <tr>
            <th>#</th>
            <th>الميزة</th>
            <th>الكود</th>
            <th>الوصف بالعربية</th>
        </tr>
        </thead>
        <tbody class="editable" contenteditable="true">
        <tr><td>1</td><td>Automatic Rescue Device</td><td>ARD</td><td>جهاز إنقاذ تلقائي عند انقطاع التيار</td></tr>
        <tr><td>2</td><td>Fireman Key</td><td>FIRE</td><td>مفتاح حريق لإرجاع المصعد للدور الأرضي</td></tr>
        <tr><td>3</td><td>Two-way Intercom</td><td>INT</td><td>نظام اتصال داخلي بين الكابينة وغرفة الماكينة</td></tr>
        <tr><td>4</td><td>Emergency Light & Alarm</td><td>EMG</td><td>إنارة وجرس إنذار للطوارئ</td></tr>
        <tr><td>5</td><td>Light Curtain</td><td>DOOR SAFE</td><td>حساسات أمان على باب المصعد</td></tr>
        <tr><td>6</td><td>Overload Protection</td><td>OL</td><td>نظام حماية من زيادة الحمولة</td></tr>
        <tr><td>7</td><td>Speed Governor</td><td>GOV</td><td>منظم سرعة لسلامة الحركة</td></tr>
        <tr><td>8</td><td>Power Saver</td><td>PSAVE</td><td>نظام توفير الطاقة عند الخمول</td></tr>
        </tbody>
    </table>

    <div class="section-title">٥) مخطط استرشادي لمقاسات البئر والكابينة</div>
    <div class="diagram-container">
        <div class="shaft">
            <div class="cabin">
                <span class="bind_dim_cabin">Cabin</span>
            </div>
            <div class="dim-label dim-top">
                عرض البئر: <span class="bind_shaft_width">—</span> mm
            </div>
            <div class="dim-label dim-right">
                عمق البئر: <span class="bind_shaft_depth">—</span> mm
            </div>
        </div>
    </div>
    <div class="caption">
        الأبعاد أعلاه استرشادية فقط، ويجب اعتماد الرسومات التنفيذية (Shop Drawings) من الاستشاري قبل التنفيذ الفعلي.
    </div>

    <div class="page-index">Page 4</div>
</div>

<!-- ================= صفحة 5: القيمة المالية + الدفعات + البنود ================= -->
<div class="page">
    <div class="header">
        <div class="logo-box">
            <div class="logo-title">القيمة المالية وجدول الدفعات</div>
            <div class="logo-sub">Financial Offer & Payment Terms</div>
        </div>
        <div class="offer-meta">
            <div>Offer No: <span class="bind_quote_number">—</span></div>
            <div>Date: <span class="bind_offer_date">—</span></div>
        </div>
    </div>

    <div class="section-title">٦) ملخص القيمة المالية</div>
    <table>
        <thead>
        <tr>
            <th style="width: 40%;">البند</th>
            <th style="width: 15%;">عدد الوحدات</th>
            <th style="width: 20%;">سعر الوحدة</th>
            <th style="width: 25%;">الإجمالي</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="editable" contenteditable="true">
                توريد وتركيب وتشغيل مصعد ركاب كامل حسب المواصفات المذكورة في هذا العرض.
            </td>
            <td class="bind_lifts">1</td>
            <td class="bind_price_per_unit">—</td>
            <td class="bind_total_price">—</td>
        </tr>
        </tbody>
        <tfoot>
        <tr>
            <th colspan="3">
                الإجمالي شامل ضريبة القيمة المضافة (%<span class="bind_vat_rate">15</span>)
            </th>
            <th class="bind_total_with_vat">—</th>
        </tr>
        </tfoot>
    </table>

    <div class="section-title">٧) جدول الدفعات المقترح</div>
    <table>
        <thead>
        <tr>
            <th style="width: 45%;">البيان</th>
            <th style="width: 15%;">النسبة</th>
            <th style="width: 40%;">المبلغ بالريال السعودي</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="editable" contenteditable="true">عند توقيع العقد</td>
            <td>50%</td>
            <td class="bind_pay_50">—</td>
        </tr>
        <tr>
            <td class="editable" contenteditable="true">عند الانتهاء من الأعمال الميكانيكية</td>
            <td>25%</td>
            <td class="bind_pay_25">—</td>
        </tr>
        <tr>
            <td class="editable" contenteditable="true">بعد الانتهاء من الأعمال الكهربائية والتشغيل</td>
            <td>20%</td>
            <td class="bind_pay_20">—</td>
        </tr>
        <tr>
            <td class="editable" contenteditable="true">عند التسليم النهائي للمصعد</td>
            <td>5%</td>
            <td class="bind_pay_5">—</td>
        </tr>
        <tr>
            <th>الإجمالي (شامل ضريبة القيمة المضافة)</th>
            <th>100%</th>
            <th class="bind_total_with_vat">—</th>
        </tr>
        </tbody>
    </table>

    <div class="section-title">٨) بنود رئيسية للعقد (قابلة للتعديل)</div>
    <div class="terms editable" contenteditable="true">
        <p>١- يعتبر هذا العرض جزءًا لا يتجزأ من عقد توريد وتركيب وتشغيل المصعد في حال اعتماده والتوقيع عليه من قبل الطرفين.</p>
        <p>٢- الأسعار الواردة أعلاه بالريال السعودي وتشمل ضريبة القيمة المضافة بنسبة ١٥٪ ما لم يُذكر خلاف ذلك.</p>
        <p>٣- يلتزم الطرف الأول بتوفير التغذية الكهربائية ٣ فاز ٣٨٠ فولت وأعمال البئر والأبواب المدنية حسب المخططات المعتمدة.</p>
        <p>٤- يلتزم الطرف الثاني بتنفيذ الأعمال وفق المواصفات الفنية المعتمدة والشروط الواردة في هذا العرض.</p>
        <p>٥- في حال تأخر الدفعات عن مواعيدها يحق للطرف الثاني إيقاف الأعمال مؤقتًا إلى حين استلام المستحقات دون مسؤولية عن التأخير.</p>
        <p>٦- في حال حدوث أي نزاع - لا قدر الله - تكون ولاية القضاء للمحاكم المختصة في المملكة العربية السعودية.</p>
        <p>٧- يعتبر العرض لاغيًا إذا لم يتم توقيعه وسداد الدفعة الأولى خلال مدة سريان العرض المتفق عليها.</p>
    </div>

    <div class="signature-row">
        <div class="editable" contenteditable="true">
            ممثل مؤسسة آر كي ال RKL للمصاعد والسلالم الكهربائية<br/>
            الاسم: _______________________<br/>
            التوقيع: _______________________
        </div>
        <div class="editable" contenteditable="true">
            ممثل العميل الكريم<br/>
            الاسم: _______________________<br/>
            التوقيع: _______________________
        </div>
    </div>

    <div class="page-index">Page 5</div>
</div>

<!-- زر طباعة عام -->
<div style="text-align:center; margin-top:10px;">
    <button class="btn-print" onclick="window.print()">طباعة / حفظ PDF</button>
    <div id="warn_no_data" class="warning" style="display:none;">
        لم يتم العثور على بيانات عرض أخير (rkl_last_offer). الرجاء العودة إلى نموذج التسعير وحفظ عرض السعر أولاً.
    </div>
</div>

<script>
function renderElevatorItemsTable(quote) {
  const tbody = document.querySelector('#elevators-items tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  const count = quote.liftsCount || 1;

  for (let i = 1; i <= count; i++) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>مصعد ${i}</td>
      <td>${quote.capacityKg || '-'}</td>
      <td>${quote.speedMps || '-'}</td>
      <td>${quote.stops || '-'}</td>
      <td>${quote.machineType || '-'}</td>
    `;
    tbody.appendChild(tr);
  }
}

    function loadStoredQuotes() {
    try {
        return JSON.parse(localStorage.getItem('rkl_quotes') || '[]');
    } catch (e) {
        console.error('خطأ في قراءة LocalStorage', e);
        return [];
    }
}

function populateQuoteSelector() {
    const select = document.getElementById('quote-selector');
    if (!select) return;

    const quotes = loadStoredQuotes();
    select.innerHTML = '<option value="">اختر عرض سعر من السجل...</option>';

    quotes.forEach((q, index) => {
        const dateStr = q.timestamp ? q.timestamp.slice(0, 10) : '---';
        const project = q.projectName || 'بدون اسم مشروع';
        const customer = q.customerName || 'عميل غير محدد';
        const label = `${q.quoteNumber} — ${customer} — ${project} — ${dateStr}`;
        const opt = document.createElement('option');
        opt.value = index;
        opt.textContent = label;
        select.appendChild(opt);
    });
}

    function formatCurrency(value, currency) {
        if (value == null || isNaN(value)) return "—";
        const num = Number(value);
        const formatted = num.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        if (currency === "USD") return "USD " + formatted;
        return "SAR " + formatted;
    }

    function bindText(cls, value) {
        const nodes = document.querySelectorAll("." + cls);
        nodes.forEach(el => {
            el.textContent = (value !== undefined && value !== null && value !== "")
                ? value
                : el.textContent || "—";
        });
    }

    function loadStoredQuotes() {
    try {
        return JSON.parse(localStorage.getItem('rkl_quotes') || '[]');
    } catch (e) {
        console.error("خطأ في قراءة عروض الأسعار", e);
        return [];
    }
}

function populateQuoteSelector() {
    const selector = document.getElementById('quote-selector');
    const quotes = loadStoredQuotes();

    selector.innerHTML = `<option value="">— اختر عرض سعر —</option>`;

    quotes.forEach((q, index) => {
        const label = `${q.quoteNumber} – ${q.projectName || ""} – ${q.customerName || ""}`;
        selector.innerHTML += `<option value="${index}">${label}</option>`;
    });
}

    document.getElementById("quote-selector").addEventListener("change", function () {
    const index = this.value;
    if (index === "") return;

    const quotes = loadStoredQuotes();   // كل عروض الأسعار
    const selected = quotes[index];      // العرض الذي اختاره المستخدم

    if (!selected) return;

    // بعض العروض محفوظة داخل fullOffer، وبعضها بيانات مباشرة
    const offer = selected.fullOffer ? selected.fullOffer : selected;

    fillOfferPage(offer);    // الآن يعرض البيانات الصحيحة
});



    document.addEventListener("DOMContentLoaded", () => {
        const raw = localStorage.getItem("rkl_last_offer");
        if (!raw) {
            document.getElementById("warn_no_data").style.display = "block";
            return;
        }

        let offer;
        try {
            offer = JSON.parse(raw);
        } catch (e) {
            console.error("Error parsing rkl_last_offer", e);
            document.getElementById("warn_no_data").style.display = "block";
            return;
        }

        const customer = offer.customer || {};
        const project  = offer.project  || {};
        const cabin    = offer.cabin    || {};
        const pricing  = offer.pricing  || {};
        const dimsEn81 = (offer.dimensions && offer.dimensions.en81) || {};
        const dimsCustom = (offer.dimensions && offer.dimensions.custom) || {};

        const dateStr = project.date ? project.date.slice(0, 10) : "";

        // رأس العرض
        bindText("bind_quote_number", offer.quoteNumber || "—");
        bindText("bind_offer_date", dateStr || "—");

        // بيانات العميل
        const typeLabel =
            customer.type === "company" ? "شركة / مؤسسة" :
            customer.type === "individual" ? "عميل فردي" : "—";

        bindText("bind_customer_type", typeLabel);
        bindText("bind_customer_name", customer.name || "—");
        bindText("bind_contact_person", customer.contactPerson || "—");
        bindText("bind_id_number", customer.idNumber || "—");
        bindText("bind_cr_number", customer.crNumber || "—");
        bindText("bind_tax_number", customer.taxNumber || "—");
        bindText("bind_city", customer.city || "—");
        bindText("bind_district", customer.district || "—");
        bindText("bind_street", customer.street || "—");
        bindText("bind_building_no", customer.buildingNo || "—");
        bindText("bind_postal_code", customer.postalCode || "—");
        bindText("bind_full_address", customer.address || "—");
        bindText("bind_mobile", customer.mobile || "—");
        bindText("bind_phone", customer.phone || "—");
        bindText("bind_email", customer.email || "—");

        let pref = customer.preferredContact || "";
        if (pref === "mobile") pref = "الجوال";
        else if (pref === "email") pref = "البريد الإلكتروني";
        else if (pref === "whatsapp") pref = "واتساب";
        bindText("bind_preferred_contact", pref || "—");

        bindText("bind_notes", customer.notes || "—");

        // المشروع
        bindText("bind_project_name", project.name || "—");

        // بيانات فنية
        bindText("bind_brand", project.brandLabel || "—");
        if (project.capacityKg != null) {
            bindText("bind_capacity", project.capacityKg + " kg");
        }
        if (project.speedMps != null) {
            bindText("bind_speed", project.speedMps + " m/s");
        }
        bindText("bind_floors", project.floors != null ? project.floors : "—");
        bindText("bind_lifts", project.liftsCount != null ? project.liftsCount : 1);

        bindText("bind_cabin_design", cabin.design || "Standard");
        bindText("bind_floor_finish", cabin.floorFinish || "Standard");

        // أبعاد EN81 أو المخصصة
        let cabinSize = "";
        if (dimsEn81.cabinWidth && dimsEn81.cabinDepth) {
            cabinSize = `${dimsEn81.cabinWidth} x ${dimsEn81.cabinDepth} mm`;
        } else if (dimsCustom.cabinSizeText) {
            cabinSize = dimsCustom.cabinSizeText;
        }
        bindText("bind_dim_cabin", cabinSize);

        let shaftSize = "";
        if (dimsEn81.shaftWidth && dimsEn81.shaftDepth) {
            shaftSize = `${dimsEn81.shaftWidth} x ${dimsEn81.shaftDepth} mm`;
        } else if (dimsCustom.shaftWidth && dimsCustom.shaftDepth) {
            shaftSize = `${dimsCustom.shaftWidth} x ${dimsCustom.shaftDepth} mm`;
        }
        bindText("bind_dim_shaft", shaftSize);

        // لاستخدامها في المخطط
        let shaftWidth = "";
        let shaftDepth = "";
        if (dimsEn81.shaftWidth && dimsEn81.shaftDepth) {
            shaftWidth = dimsEn81.shaftWidth;
            shaftDepth = dimsEn81.shaftDepth;
        } else if (dimsCustom.shaftWidth && dimsCustom.shaftDepth) {
            shaftWidth = dimsCustom.shaftWidth;
            shaftDepth = dimsCustom.shaftDepth;
        } else if (shaftSize.includes("x")) {
            const parts = shaftSize.split("x");
            if (parts.length >= 2) {
                shaftWidth = parts[0].trim();
                shaftDepth = parts[1].trim();
            }
        }
        bindText("bind_shaft_width", shaftWidth || "—");
        bindText("bind_shaft_depth", shaftDepth || "—");

        bindText("bind_pit", dimsEn81.pit || "—");
        bindText("bind_oh", dimsEn81.oh || "—");

        // التسعير
        const currency = pricing.currency || "SAR";
        const totalWithVat = pricing.totalWithVat ?? null;
        const vatRate = pricing.vatRate ?? 15;

        bindText("bind_vat_rate", vatRate);

        if (totalWithVat != null) {
            const liftsCount = project.liftsCount || 1;
            const perLift = Number(totalWithVat) / Number(liftsCount || 1);

            bindText("bind_price_per_unit", formatCurrency(perLift, currency));
            bindText("bind_total_price", formatCurrency(totalWithVat, currency));
            bindText("bind_total_with_vat", formatCurrency(totalWithVat, currency));

            const t = Number(totalWithVat);
            bindText("bind_pay_50", formatCurrency(t * 0.50, currency));
            bindText("bind_pay_25", formatCurrency(t * 0.25, currency));
            bindText("bind_pay_20", formatCurrency(t * 0.20, currency));
            bindText("bind_pay_5",  formatCurrency(t * 0.05,  currency));
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
    populateQuoteSelector();
});
document.getElementById('quote-selector').addEventListener('change', function () {
    const index = this.value;
    if (index === "") return;

    const quotes = loadStoredQuotes();
    const q = quotes[index];
    if (!q) return;

    fillOfferPage(q.fullOffer || q);

});

    function fillOfferPage(offer) {
    if (!offer) return;

    const customer = offer.customer || {};
    const project  = offer.project  || {};
    const cabin    = offer.cabin    || {};
    const pricing  = offer.pricing  || {};
    const dimsEn81 = (offer.dimensions && offer.dimensions.en81) || {};
    const dimsCustom = (offer.dimensions && offer.dimensions.custom) || {};

    const dateStr = project.date ? project.date.slice(0, 10) : "";

    // رأس العرض
    bindText("bind_quote_number", offer.quoteNumber || "—");
    bindText("bind_offer_date", dateStr || "—");

    // بيانات العميل
    const typeLabel =
        customer.type === "company" ? "شركة / مؤسسة" :
        customer.type === "individual" ? "عميل فردي" : "—";

    bindText("bind_customer_type", typeLabel);
    bindText("bind_customer_name", customer.name || "—");
    bindText("bind_contact_person", customer.contactPerson || "—");
    bindText("bind_id_number", customer.idNumber || "—");
    bindText("bind_cr_number", customer.crNumber || "—");
    bindText("bind_tax_number", customer.taxNumber || "—");
    bindText("bind_city", customer.city || "—");
    bindText("bind_district", customer.district || "—");
    bindText("bind_street", customer.street || "—");
    bindText("bind_building_no", customer.buildingNo || "—");
    bindText("bind_postal_code", customer.postalCode || "—");
    bindText("bind_full_address", customer.address || "—");
    bindText("bind_mobile", customer.mobile || "—");
    bindText("bind_phone", customer.phone || "—");
    bindText("bind_email", customer.email || "—");

    // المشروع
    bindText("bind_project_name", project.name || "—");

    bindText("bind_brand", project.brandLabel || "—");
    bindText("bind_capacity", project.capacityKg ? project.capacityKg + " kg" : "—");
    bindText("bind_speed", project.speedMps ? project.speedMps + " m/s" : "—");
    bindText("bind_floors", project.floors ?? "—");
    bindText("bind_lifts", project.liftsCount ?? 1);

    bindText("bind_cabin_design", cabin.design || "Standard");
    bindText("bind_floor_finish", cabin.floorFinish || "Standard");

    // أبعاد
    let cabinSize = dimsEn81.cabinWidth ? 
        `${dimsEn81.cabinWidth} x ${dimsEn81.cabinDepth} mm` :
        (dimsCustom.cabinSizeText || "—");

    bindText("bind_dim_cabin", cabinSize);

    let shaftSize = dimsEn81.shaftWidth ? 
        `${dimsEn81.shaftWidth} x ${dimsEn81.shaftDepth} mm` :
        (dimsCustom.shaftWidth && dimsCustom.shaftDepth ?
            `${dimsCustom.shaftWidth} x ${dimsCustom.shaftDepth} mm` : "—");

    bindText("bind_dim_shaft", shaftSize);

    bindText("bind_shaft_width", dimsEn81.shaftWidth || dimsCustom.shaftWidth || "—");
    bindText("bind_shaft_depth", dimsEn81.shaftDepth || dimsCustom.shaftDepth || "—");
    bindText("bind_pit", dimsEn81.pit || "—");
    bindText("bind_oh", dimsEn81.oh || "—");

    // التسعير
    const currency = pricing.currency || "SAR";
    const totalWithVat = pricing.totalWithVat ?? null;
    const vatRate = pricing.vatRate ?? 15;

    bindText("bind_vat_rate", vatRate);

    if (totalWithVat != null) {
        const lifts = project.liftsCount || 1;
        const perLift = Number(totalWithVat) / Number(lifts);

        bindText("bind_price_per_unit", formatCurrency(perLift, currency));
        bindText("bind_total_price", formatCurrency(totalWithVat, currency));
        bindText("bind_total_with_vat", formatCurrency(totalWithVat, currency));

        bindText("bind_pay_50", formatCurrency(totalWithVat * 0.5, currency));
        bindText("bind_pay_25", formatCurrency(totalWithVat * 0.25, currency));
        bindText("bind_pay_20", formatCurrency(totalWithVat * 0.20, currency));
        bindText("bind_pay_5",  formatCurrency(totalWithVat * 0.05, currency));
    }
}

</script>
function loadSelectedQuote(quoteIndex) {
  const quotes = JSON.parse(localStorage.getItem(QUOTES_STORAGE_KEY) || '[]');
  const quote = quotes[quoteIndex];

  if (!quote) {
    console.warn('عرض السعر غير موجود');
    return;
  }

  // ملف العميل
  document.getElementById('client_name').innerText = quote.customerName || '—';
  document.getElementById('client_type').innerText = quote.customerType || '—';
  document.getElementById('client_mobile').innerText = quote.customerMobile || '—';
  document.getElementById('client_email').innerText = quote.customerEmail || '—';
  document.getElementById('client_address').innerText = quote.customerAddress || '—';

  // بيانات المشروع
  document.getElementById('project_name').innerText = quote.projectName || '—';
  document.getElementById('brand_model').innerText =
    `${quote.brandLabel || ''} / ${quote.capacityKg || ''}kg / ${quote.speedMps || ''}`;

  // ✅ عناصر المصاعد (اللي ناقصة عندك)
  renderElevatorItemsTable(quote);
}

    
</body>
</html>






