<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>عرض سعر مصعد – RKL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 20px;
            color: #111827;
        }

        .page {
            max-width: 900px;
            margin: 0 auto;
            background: #ffffff;
            padding: 30px 40px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);
        }

        .toolbar {
            max-width: 900px;
            margin: 0 auto 10px auto;
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar select {
            padding: 6px 10px;
            font-size: 14px;
        }

        .toolbar button {
            padding: 8px 14px;
            font-size: 14px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #059669;
            color: #ffffff;
        }

        .toolbar button.secondary {
            background: #4b5563;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            margin-bottom: 16px;
        }

        .header-left {
            text-align: left;
            font-size: 12px;
            color: #4b5563;
        }

        .logo-text {
            font-weight: 800;
            font-size: 20px;
            color: #111827;
        }

        .subtitle {
            font-size: 13px;
            color: #6b7280;
        }

        .header-right {
            text-align: right;
            font-size: 12px;
            color: #4b5563;
        }

        .doc-title {
            text-align: center;
            margin: 10px 0 6px 0;
            font-size: 18px;
            font-weight: 700;
        }

        .doc-meta {
            text-align: center;
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 14px;
        }

        .section-title {
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 2px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 4px 16px;
            font-size: 13px;
        }

        .info-label {
            font-weight: 600;
            color: #4b5563;
        }

        .info-row {
            display: flex;
            gap: 4px;
        }

        .info-value {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
            font-size: 13px;
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            text-align: center;
        }

        th {
            background: #f3f4f6;
            font-weight: 600;
        }

        .totals {
            margin-top: 8px;
            font-size: 13px;
            text-align: left;
        }

        .totals span.label {
            font-weight: 600;
            color: #4b5563;
        }

        .notes {
            font-size: 12px;
            color: #4b5563;
            line-height: 1.7;
        }

        .signatures {
            display: grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 30px;
            margin-top: 20px;
            font-size: 13px;
        }

        .sign-box {
            border-top: 1px solid #e5e7eb;
            padding-top: 6px;
        }

        .sign-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .badge {
            display: inline-block;
            font-size: 11px;
            background: #e0f2fe;
            color: #0369a1;
            padding: 2px 6px;
            border-radius: 999px;
            margin-right: 4px;
        }

        @media print {
            body {
                background: #ffffff;
                padding: 0;
            }
            .page {
                box-shadow: none;
                margin: 0;
                max-width: 100%;
                padding: 15mm 17mm;
            }
            .toolbar {
                display: none;
            }
        }
    </style>
</head>
<body>

<div class="toolbar">
    <div>
        <select id="quote-selector">
            <option value="">— اختر عرض سعر من السجل —</option>
        </select>
    </div>
    <div>
        <button type="button" onclick="window.print()">طباعة عرض السعر</button>
    </div>
</div>

<div class="page" id="print-area">
    <div class="header">
        <div class="header-right">
            <div class="logo-text">آر كي ال RKL</div>
            <div class="subtitle">للمصاعد والسلالم الكهربائية</div>
            <div>السجل التجاري: 1010709355</div>
            <div>الرقم الضريبي: 302250422600003</div>
        </div>
        <div class="header-left">
            <div>الهاتف: 0114774021</div>
            <div>البريد الإلكتروني: admin@rk-lifts.com</div>
            <div>العنوان: السليمانية – الرياض</div>
        </div>
    </div>

    <div class="doc-title">عرض سعر توريد وتركيب وتشغيل مصعد/مصاعد</div>
    <div class="doc-meta">
        رقم عرض السعر: <span id="doc-number">—</span> &nbsp; | &nbsp;
        التاريخ: <span id="doc-date">—</span>
    </div>

    <div class="section">
        <div class="section-title">أولاً: بيانات العميل والمشروع</div>
        <div class="info-grid">
            <div class="info-row">
                <div class="info-label">اسم العميل:</div>
                <div class="info-value" id="customer-name">—</div>
            </div>
            <div class="info-row">
                <div class="info-label">اسم المشروع:</div>
                <div class="info-value" id="project-name">—</div>
            </div>
            <div class="info-row">
                <div class="info-label">موقع المشروع:</div>
                <div class="info-value" id="project-location">—</div>
            </div>
            <div class="info-row">
                <div class="info-label">طريقة التواصل:</div>
                <div class="info-value" id="contact-info">—</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">ثانياً: بيانات المصاعد المطلوبة</div>
        <table>
            <thead>
            <tr>
                <th>#</th>
                <th>الماركة / النظام</th>
                <th>الحمولة (kg)</th>
                <th>السرعة (m/s)</th>
                <th>عدد الأدوار</th>
                <th>عدد المصاعد</th>
                <th>الإجمالي شامل الضريبة</th>
            </tr>
            </thead>
            <tbody id="items-body">
            <tr>
                <td>1</td>
                <td id="brand-cell">—</td>
                <td id="capacity-cell">—</td>
                <td id="speed-cell">—</td>
                <td id="floors-cell">—</td>
                <td id="lifts-cell">—</td>
                <td id="total-cell">—</td>
            </tr>
            </tbody>
        </table>

        <div class="totals">
            <div><span class="label">العملة:</span> <span id="currency-label">—</span></div>
            <div><span class="label">نسبة ضريبة القيمة المضافة:</span> <span id="vat-rate-label">—</span></div>
            <div><span class="label">قيمة العرض الإجمالية:</span> <span id="grand-total-label">—</span></div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">ثالثاً: ملاحظات وشروط عامة مختصرة</div>
        <div class="notes" id="notes-block">
            • الأسعار أعلاه مبنية على المواصفات الفنية الخاصة بنظام <span class="badge" id="brand-badge">—</span>،  
            وأي تعديل جوهري في المواصفات أو عدد الأدوار أو موقع المشروع قد يستلزم إعادة تسعير.<br>
            • الأسعار تشمل توريد وتركيب وتشغيل المصاعد المذكورة، ولا تشمل الأعمال المدنية والكهربائية خارج غرفة المصعد
              إلا إذا تم النص على خلاف ذلك في العرض الفني التفصيلي.<br>
            • مدة صلاحية هذا العرض (30) يومًا من تاريخه، ما لم يتم سحبه أو تعديله كتابيًا من قبل مؤسسة RKL.<br>
            • يتـم إصدار عقد توريد وتركيب وتشغيل مصاعد مستقل عند اعتماد هذا العرض ودفع الدفعة المقدمة المتفق عليها.
        </div>
    </div>

    <div class="section signatures">
        <div class="sign-box">
            <div class="sign-title">مع تحيات</div>
            <div>آر كي ال RKL للمصاعد والسلالم الكهربائية</div>
            <div style="margin-top: 25px;">التوقيع والختم:</div>
        </div>
        <div class="sign-box">
            <div class="sign-title">إقرار العميل</div>
            <div>أقر أنا المذكور اسمي أعلاه باستلام عرض السعر هذا والاطلاع على الشروط الواردة فيه.</div>
            <div style="margin-top: 25px;">الاسم: __________________________</div>
            <div>التوقيع: ______________________</div>
            <div>التاريخ: ____ / ____ / _______</div>
        </div>
    </div>
</div>

<script>
    const QUOTES_STORAGE_KEY = 'rkl_quotes';
    const CUSTOMER_STORAGE_KEY = 'rkl_customers';

    function loadJson(key) {
        try {
            return JSON.parse(localStorage.getItem(key) || '[]');
        } catch (e) {
            console.error('Failed to parse localStorage for', key, e);
            return [];
        }
    }

    function formatCurrency(val, currency) {
        if (isNaN(val)) return '—';
        const num = Number(val).toFixed(2);
        return currency === 'USD' ? `${num} USD` : `${num} SAR`;
    }

    function formatDate(isoStr) {
        if (!isoStr) return '—';
        const d = new Date(isoStr);
        if (isNaN(d.getTime())) return '—';
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    function populateQuoteSelector() {
        const select = document.getElementById('quote-selector');
        const quotes = loadJson(QUOTES_STORAGE_KEY);

        if (!quotes.length) {
            select.innerHTML = '<option value="">لا توجد عروض أسعار محفوظة في هذا المتصفح</option>';
            select.disabled = true;
            return;
        }

        select.disabled = false;
        select.innerHTML = '<option value="">— اختر عرض سعر من السجل —</option>';

        quotes.forEach((q, index) => {
            const opt = document.createElement('option');
            const label = `${q.quoteNumber || 'بدون رقم'} – ${q.customerName || ''} – ${formatDate(q.timestamp)}`;
            opt.value = index.toString();
            opt.textContent = label;
            select.appendChild(opt);
        });

        // اختر آخر عرض تلقائيًا
        select.value = (quotes.length - 1).toString();
        applyQuote(quotes.length - 1);
    }

    function findCustomerByName(name) {
        if (!name) return null;
        const customers = loadJson(CUSTOMER_STORAGE_KEY);
        return customers.find(c => c.customer_name === name) || null;
    }

    function applyQuote(index) {
        const quotes = loadJson(QUOTES_STORAGE_KEY);
        const quote = quotes[index];
        if (!quote) return;

        document.getElementById('doc-number').textContent = quote.quoteNumber || '—';
        document.getElementById('doc-date').textContent = formatDate(quote.timestamp);

        const customerName = quote.customerName || '—';
        const projectName = quote.projectName || '—';

        document.getElementById('customer-name').textContent = customerName;
        document.getElementById('project-name').textContent = projectName;

        // محاولة جلب معلومات إضافية للعميل من customer-manager
        const customer = findCustomerByName(quote.customerName);
        if (customer) {
            const addrParts = [
                customer.city,
                customer.district,
                customer.street,
                customer.full_address
            ].filter(Boolean);
            document.getElementById('project-location').textContent = addrParts.join(' - ') || '—';

            const contacts = [
                customer.mobile ? `جوال: ${customer.mobile}` : '',
                customer.phone ? `هاتف: ${customer.phone}` : '',
                customer.email ? `بريد: ${customer.email}` : ''
            ].filter(Boolean);
            document.getElementById('contact-info').textContent = contacts.join(' | ') || '—';
        } else {
            document.getElementById('project-location').textContent = '—';
            document.getElementById('contact-info').textContent = '—';
        }

        document.getElementById('brand-cell').textContent = quote.brandLabel || quote.brandKey || '—';

        // capacity/speed مخزنة لدينا بالنص "630 kg" لذلك نفصل الرقم عن الوحدة للعرض
        document.getElementById('capacity-cell').textContent = quote.capacity || '—';
        document.getElementById('speed-cell').textContent = quote.speed || '—';
        document.getElementById('floors-cell').textContent = quote.floors || '—';
        document.getElementById('lifts-cell').textContent = quote.liftsCount || '—';

        document.getElementById('total-cell').textContent =
            formatCurrency(quote.totalWithVat, quote.currency || 'SAR');

        document.getElementById('currency-label').textContent =
            quote.currency === 'USD' ? 'دولار أمريكي' : 'ريال سعودي';

        document.getElementById('vat-rate-label').textContent =
            (quote.vatRate != null ? quote.vatRate : 15) + ' %';

        document.getElementById('grand-total-label').textContent =
            formatCurrency(quote.totalWithVat, quote.currency || 'SAR');

        document.getElementById('brand-badge').textContent =
            quote.brandLabel || quote.brandKey || 'نظام المصعد';
    }

    (function init() {
        populateQuoteSelector();

        const select = document.getElementById('quote-selector');
        select.addEventListener('change', () => {
            const idx = select.value;
            if (idx === '') return;
            applyQuote(Number(idx));
        });
    })();
</script>

</body>
</html>
