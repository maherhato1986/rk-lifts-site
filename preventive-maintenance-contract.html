<!DOCTYPE html>
<html lang="ar" dir="rtl">


<head>
  <link rel="icon" type="image/png" href="/public/images/logo.png">

<meta charset="UTF-8">
<title>ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ูููุตุงุนุฏ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
 /* ===============================
   ุชุญุณูู ุงููุงุฌูุฉ ุงูุนุงูุฉ
=============================== */
body{
  background:#f3f4f6;
}

.container{
  max-width:1100px;
  margin:30px auto;
  background:#ffffff;
  padding:35px 40px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
}

/* ===============================
   ุงูุนููุงู ุงูุฑุฆูุณู
=============================== */
.page-header{
  text-align:center;
  margin-bottom:35px;
}

.page-header h2{
  font-size:26px;
  font-weight:800;
  color:#0f766e;
}

.page-header p{
  font-size:13px;
  color:#6b7280;
}
  .print-logo{ width:38px }
.print-header{
  margin-bottom: 16px;
}


/* ===============================
   ุงูุฃูุณุงู (Cards)
=============================== */
.section{
  background:#f9fafb;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:25px;
  margin-bottom:25px;
}

.section h3{
  margin:0 0 18px;
  font-size:18px;
  font-weight:700;
  color:#0f766e;
  border-bottom:1px solid #e5e7eb;
  padding-bottom:8px;
}

/* ===============================
   Grid ุงุญุชุฑุงูู
=============================== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:18px 22px;
}

/* ===============================
   ุงูุญููู
=============================== */
label{
  display:block;
  font-size:13px;
  font-weight:600;
  color:#374151;
  margin-bottom:6px;
}

input,
select,
textarea{
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-family:"Cairo",sans-serif;
  font-size:14px;
}

input:focus,
select:focus,
textarea:focus{
  outline:none;
  border-color:#0f766e;
  box-shadow:0 0 0 2px rgba(15,118,110,0.15);
}

textarea{
  min-height:90px;
  resize:vertical;
}

/* ===============================
   ุฃุฒุฑุงุฑ
=============================== */
button{
  background:#0f766e;
  color:#fff;
  border:none;
  padding:10px 18px;
  border-radius:10px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:0.25s;
}

button:hover{
  background:#115e59;
}

/* ===============================
   ุจูุงูุงุช ุงูุนููู
=============================== */
#customerInfo{
  background:#ecfeff;
  border:1px dashed #0f766e;
  padding:15px 18px;
  border-radius:10px;
  font-size:14px;
}

#customerInfo .user-data{
  color:#0f766e;
  font-weight:700;
}

/* ===============================
   ุฌุฏูู ุงูุณุฌู
=============================== */
table{
  border-radius:10px;
  overflow:hidden;
  font-size:13px;
}

thead{
  background:#0f766e;
  color:#fff;
}

thead th{
  font-weight:600;
}

tbody tr:nth-child(even){
  background:#f9fafb;
}

/* ===============================
   ุชุญุณูู ุงูุทุจุงุนุฉ
=============================== */
@media print{
  body{
    background:#fff;
  }

  /* ===============================
     ุดุนุงุฑ ุดูุงู ุฃุซูุงุก ุงูุทุจุงุนุฉ
  =============================== */
  body::before{
    content:"";
    position:fixed;
    top:50%;
    left:50%;
    width:420px;
    height:420px;
    background:url('/public/images/logo.png') no-repeat center center;
    background-size:contain;
    opacity:0.05;   /* ุฏุฑุฌุฉ ุงูุดูุงููุฉ */
    transform:translate(-50%, -50%);
    z-index:-1;
  }

  .container{
    box-shadow:none;
    border-radius:0;
    padding:0;
  }

  .section{
    border:none;
    background:#fff;
    padding:0;
  }
}
.cover-title{
  font-size:28px;
  letter-spacing:0.5px;
}
.cover-line{
  width:120px;
  height:2px;
  background:#0f766e;
  margin:14px auto 25px;
}
.contract p{
  margin: 4px 0;
}
.contract p strong{
  color:#0f766e;
}
.contract-value{
  background:#f8fafc;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:18px;
  margin:25px 0;
}
.contract-value b{
  color:#0f766e;
}

  .contract-summary{
  background:#f8fafc;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:18px 20px;
  margin:22px 0;
}

.contract-summary h4{
  margin:0 0 14px;
  text-align:center;
  font-size:16px;
  font-weight:700;
  color:#0f766e;
  border-bottom:1px solid #e5e7eb;
  padding-bottom:8px;
}

.contract-summary table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

.contract-summary td{
  padding:8px 6px;
}

.contract-summary tr:not(:last-child){
  border-bottom:1px dashed #e5e7eb;
}

.contract-summary .label{
  color:#374151;
}

.contract-summary .value{
  text-align:left;
  font-weight:600;
}

.contract-summary .total{
  font-size:15px;
  font-weight:800;
  color:#0f766e;
}

.contract-summary .words{
  margin-top:10px;
  font-size:13px;
  color:#374151;
}

/* =================================================
   Mobile Responsive Support โ RKL
================================================= */

/* ููุน ุชูุจูุฑ iOS ุฏุงุฎู ุงูุญููู */
input,
select,
textarea,
button {
  font-size: 16px;
  touch-action: manipulation;
}

/* ูู ุงูุฌุฏุงูู ููุชูุฑูุฑ ุงูุฃููู */
.table-wrap {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* ===============================
   Mobile Layout
=============================== */
@media (max-width: 768px) {

  /* ุงูุญุงููุฉ ุงูุฑุฆูุณูุฉ */
  .container {
    margin: 10px auto;
    padding: 16px 14px;
    border-radius: 10px;
  }

  /* ุงูุนููุงู */
  .page-header {
    margin-bottom: 20px;
  }

  .page-header h2 {
    font-size: 20px;
    line-height: 1.4;
  }

  .page-header p {
    font-size: 12px;
  }

  /* ุงููุฑูุช */
  .section {
    padding: 16px;
    margin-bottom: 18px;
  }

  .section h3 {
    font-size: 16px;
    margin-bottom: 14px;
  }

  /* ุงูููุงุฐุฌ โ ุนููุฏ ูุงุญุฏ */
  .grid {
    grid-template-columns: 1fr !important;
    gap: 12px;
  }

  /* ุงูุญููู */
  label {
    font-size: 12px;
  }

  input,
  select,
  textarea {
    padding: 12px;
    font-size: 16px;
  }

  textarea {
    min-height: 110px;
  }

  /* ุงูุฃุฒุฑุงุฑ */
  button {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    border-radius: 10px;
  }

  /* ุฃุฒุฑุงุฑ ูุชุนุฏุฏุฉ */
  .actions {
    flex-direction: column;
    gap: 8px;
  }

  /* ุงูุฌุฏุงูู */
  table {
    min-width: 780px;
  }

  /* ูุฑุงุฌุนุฉ ุงูุนูุฏ */
  #reviewBox p {
    font-size: 14px;
    line-height: 1.6;
  }

  /* ุชุฑููุณุฉ ุงูุทุจุงุนุฉ ุฏุงุฎู ุงููุนุงููุฉ */
  .print-header h1 {
    font-size: 18px;
  }
}

/* ===============================
   Small Phones
=============================== */
@media (max-width: 420px) {

  .page-header h2 {
    font-size: 18px;
  }

  .section h3 {
    font-size: 15px;
  }

  button {
    font-size: 14px;
  }
}


</style>
</head>

<body>
 

<div class="container">

<div class="page-header">


  <div class="header-text">
    <h2>ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ูููุตุงุนุฏ</h2>
<p>ูููุฐุฌ ุฅุนุฏุงุฏ ูุชูููุฏ ุนูุฏ ุตูุงูุฉ ุงุญุชุฑุงูู</p>

    <p>ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ</p>
    <p class="small">
      ุงูุณุฌู ุงูุชุฌุงุฑู: 1010709355 | ูุงุชู: 0114774021
    </p>
  </div>
</div>

<!-- ================== ุจูุงูุงุช ุงูุนููู ================== -->
<div class="section">
  <h3>ุฃููุงู: ุจูุงูุงุช ุงูุนููู</h3>

  <div class="grid" style="align-items:end">
    <div>
      <label>ุงุฎุชูุงุฑ ุงูุนููู</label>
      <select id="customerSelect">
        <option value="">-- ุงุฎุชุฑ ุงูุนููู --</option>
      </select>
      <div style="margin-top:8px;font-size:12px;color:#6b7280">
        ุฅุฐุง ูู ูุธูุฑ ุนูููู ููุงุ ุชุฃูุฏ ุฃูู ูุญููุธ ูู ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุนููุงุก.
      </div>
    </div>

    <div>
      <label>ุจูุงูุงุช ุงูุนููู</label>
      <div id="customerInfo">โ</div>
    </div>
  </div>
</div>

<!-- ================== ุจูุงูุงุช ุงููุตุงุนุฏ ================== -->
<div class="section">
  <h3>ุซุงููุงู: ุจูุงูุงุช ุงููุตุงุนุฏ</h3>

  <div class="grid">
    <div>
      <label>ุนุฏุฏ ุงููุตุงุนุฏ</label>
      <input id="lifts" type="number" min="1">
    </div>

    <div>
      <label>ููุน ุงููุตุนุฏ</label>
      <select id="elevatorType">
        <option value="passenger">ุฑูุงุจ</option>
        <option value="service">ุฎุฏูุฉ</option>
        <option value="panoramic">ุจุงููุฑุงูู</option>
      </select>
    </div>
<div>
  <label>ุงุณู ุงููุดุฑูุน</label>
  <input id="projectName" type="text" placeholder="ูุซุงู: ูุดุฑูุน ุงูุนุฌูููู ุงููุงุจุถุฉ - ุงูุฏูุงู">
</div>

<div>
  <label>ูููุน ุงููุดุฑูุน</label>
  <input id="projectLocation" type="text" placeholder="ูุซุงู: ุงูุฏูุงู - ุญู ... / ุฑุงุจุท ุฎุฑุงุฆุท">
</div>

    <div>
      <label>ูุงุฑูุฉ ุงููุตุนุฏ</label>
      <select id="brandSelect" onchange="toggleOtherBrand()">
        <option value="">-- ุงุฎุชุฑ --</option>
        <option value="Otis">Otis</option>
        <option value="KONE">KONE</option>
        <option value="WITTUR">WITTUR</option>
        <option value="Mitsubishi">Mitsubishi</option>
        <option value="Schindler">Schindler</option>
        <option value="Fuji">Fuji</option>
        <option value="Local">ุชุฌููุน ูุญูู</option>
        <option value="Other">ุฃุฎุฑู</option>
      </select>
    </div>

    <div id="otherBrandBox" style="display:none">
      <label>ุงุณู ุงููุงุฑูุฉ / ุงูุชูุถูุญ</label>
      <input id="brandOther" placeholder="ูุซุงู: ูุตุนุฏ ุฑูุงุจ โ ูุดุฑูุน ุจุฑุฌ ุงูุณูุงู">
    </div>

    <div>
      <label>ุญูููุฉ ุงููุตุนุฏ (ูุฌู)</label>
      <select id="capacity">
        <option value="">-- ุงุฎุชุฑ --</option>
        <option value="3000">150 โ 320</option>
        <option value="3500">350 โ 550</option>
        <option value="4000">600 โ 900</option>
        <option value="4500">901 โ 1100</option>
        <option value="5000">1101 โ 1500</option>
        <option value="5500">1501 โ 1750</option>
      </select>
    </div>

    <div>
      <label>ุนุฏุฏ ุงูุทูุงุจู</label>
      <input id="floors" type="number" min="1">
    </div>

    <div>
      <label>ููุน ุงููุจูู</label>
      <select id="building">
        <option value="private">ุฎุงุต</option>
        <option value="government">ุญูููู</option>
      </select>
    </div>
  </div>
</div>

<!-- ================== ููุน ุงูุฎุฏูุฉ ================== -->
<div class="section">
  <h3>ุซุงูุซุงู: ููุน ุงูุฎุฏูุฉ</h3>

  <div class="grid">
    <div>
   <select id="serviceType" onchange="toggleServiceType()">
  <option value="annual" selected>ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ุณููู</option>
  <option value="once">ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ</option>
  <option value="supply_install">ุชูุฑูุฏ + ุชุฑููุจ + ุชุดุบูู ูุทุน ุบูุงุฑ</option>
</select>


    <div>
      <label>ููุงุญุธุฉ</label>
      <div style="background:#ecfeff;border:1px dashed #0f766e;padding:12px;border-radius:10px;font-size:13px">
        ุนูุฏ ุงุฎุชูุงุฑ "ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ" ุณูุชู ุนุฑุถ ูููุฐุฌ ูุชุทูุจุงุช ุงูุฒูุงุฑุฉ ูุฅุฎูุงุก ุฅุนุฏุงุฏุงุช ุงูุนูุฏ ุงูุณููู.
      </div>
    </div>
  </div>
</div>

<!-- ================== ุตูุฏูู ุงูุนูุฏ ุงูุณููู (ูุธูุฑ ููุท ุนูุฏ annual) ================== -->
<div id="annualBox">




  <!-- ================== ุฅุนุฏุงุฏุงุช ุงูุนูุฏ ุงูุณููู ================== -->
  <div class="section">
    <h3>ุฑุงุจุนุงู: ุฅุนุฏุงุฏุงุช ุงูุนูุฏ ุงูุณููู</h3>

    <div id="editableContract" class="contract">
      <div class="grid">
        <div>
          <label>ูุบุฉ ุงูุนูุฏ</label>
          <select id="lang">
            <option value="">-- ุงุฎุชุฑ --</option>
            <option value="ar">ุนุฑุจู</option>
            <option value="en">English</option>
            <option value="both">ุนุฑุจู + English</option>
          </select>
        </div>

        <div>
          <label>ุชุงุฑูุฎ ุงูุนูุฏ</label>
          <input id="contractDate" type="date">
        </div>

        <div>
          <label>ูุฏุฉ ุงูุนูุฏ</label>
          <select id="duration">
            <option value="1">ุณูุฉ ูุงุญุฏุฉ</option>
          </select>
        </div>

        <div>
          <label>ูุฏููุฉ ุงููุดุฑูุน</label>
          <select id="projectCity">
            <option value="riyadh">ุงูุฑูุงุถ</option>
            <option value="near">ูุฏู ูุฑูุจุฉ ูู ุงูุฑูุงุถ</option>
            <option value="medium">ูุฏู ูุชูุณุทุฉ ุงูุจุนุฏ</option>
            <option value="far">ูุฏู ุจุนูุฏุฉ</option>
            <option value="remote">ูุฏู ูุงุฆูุฉ</option>
          </select>
        </div>

        <div>
          <label>ุชุฌุฏูุฏ ุชููุงุฆู</label>
          <select id="renewal">
            <option value="yes">ูุนู</option>
            <option value="no">ูุง</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== ูุทุงู ุงูุตูุงูุฉ (ุงูุนูุฏ ุงูุณููู) ================== -->
  <div class="section">
    <h3>ุฎุงูุณุงู: ูุทุงู ุงูุตูุงูุฉ (ุงูุนูุฏ ุงูุณููู)</h3>

    <div class="grid">
      <div>
        <label>ุนุฏุฏ ุงูุฒูุงุฑุงุช ุงูุฏูุฑูุฉ</label>
        <select id="visits">
          <option value="monthly">ุฒูุงุฑุฉ ุดูุฑูุฉ</option>
          <option value="bimonthly">ุฒูุงุฑุฉ ูู ุดูุฑูู</option>
        </select>
      </div>

      <div>
        <label>ุชุฏุฑูุจ ุฅููุงุฐ ุงููุญุชุฌุฒูู</label>
        <select id="training">
          <option value="yes">ูุนู</option>
          <option value="no">ูุง</option>
        </select>
      </div>

      <div>
        <label>ูุทุน ุงูุบูุงุฑ</label>
        <select id="spareParts">
          <option value="excluded">ุบูุฑ ูุดูููุฉ</option>
          <option value="included">ูุดูููุฉ (ุจุนุฑุถ ุฎุงุต)</option>
        </select>
      </div>

      <div>
        <label>ุฎุฏูุฉ ุงูุทูุงุฑุฆ</label>
        <select id="emergency">
          <option value="normal">ุฃููุงุช ุงูุฏูุงู</option>
          <option value="extended">ุฎุงุฑุฌ ุงูุฏูุงู (ุฅุถุงูู)</option>
        </select>
      </div>
    </div>

    <label style="margin-top:15px">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
    <textarea id="notes"></textarea>
  </div>

</div>
<div id="onceBox" style="display:none">

  <div class="section">
    <h3>ุฑุงุจุนุงู: ูุชุทูุจุงุช ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ</h3>

    <div class="grid">
      <div>
        <label>ููุน ุงูุฒูุงุฑุฉ</label>
        <select id="onceVisitType">
          <option value="">-- ุงุฎุชุฑ --</option>
          <option value="inspection">ูุญุต ูุชุดุฎูุต</option>
          <option value="repair">ุตูุงูุฉ/ุฅุตูุงุญ</option>
          <option value="rescue">ุงุญุชุฌุงุฒ/ุฅููุงุฐ</option>
        </select>
      </div>

      <div>
        <label>ุชุงุฑูุฎ ุงูุฒูุงุฑุฉ ุงูููุชุฑุญ</label>
        <input id="onceDate" type="date">
      </div>

      <div>
        <label>ุงูุฃููููุฉ</label>
        <select id="onceUrgency">
          <option value="normal">ุนุงุฏู</option>
          <option value="urgent">ูุณุชุนุฌู</option>
        </select>
      </div>

      <div>
        <label>ูู ููุฌุฏ ุชููู ูุงููุ</label>
        <select id="onceStopped">
          <option value="no">ูุง</option>
          <option value="yes">ูุนู</option>
        </select>
      </div>

      <div style="grid-column:1/-1">
        <label>ูุตู ุงููุดููุฉ / ุงููุทููุจ</label>
        <textarea id="onceIssue" placeholder="ุงูุชุจ ูุตู ูุฎุชุตุฑ ูููุดููุฉ ุฃู ุงููุทููุจ..."></textarea>
      </div>

      <div>
        <label>ุณุนุฑ ุงูุฒูุงุฑุฉ (ูุจู ุงูุถุฑูุจุฉ) โ ูุฏูู</label>
        <input id="oncePrice" type="number" min="0" step="0.01" placeholder="ูุซุงู: 450">
      </div>
    </div>

  </div>

</div>
<div id="supplyInstallBox" style="display:none">

  <div class="section">
    <h3>ุฑุงุจุนุงู: ุชูุฑูุฏ ูุชุฑููุจ ูุชุดุบูู ูุทุน ุบูุงุฑ</h3>

    <div class="grid">

      <div>
        <label>ููุน ุงูุนูู</label>
      <select id="supplyType" onchange="toggleOperationMode()">
  <option value="">-- ุงุฎุชุฑ --</option>
  <option value="supply">ุชูุฑูุฏ ููุท</option>
  <option value="supply_install">ุชูุฑูุฏ + ุชุฑููุจ</option>
  <option value="supply_install_commission">ุชูุฑูุฏ + ุชุฑููุจ + ุชุดุบูู</option>
  <option value="commission_only">ุชุดุบูู ุจุฏูู ูุทุน ุบูุงุฑ</option>
</select>

      </div>
<div id="operationModeBox" style="display:none">
  <label>ููุน ุงูุชุดุบูู</label>
  <select id="operationMode">
    <option value="">-- ุงุฎุชุฑ --</option>
    <option value="first_time">ุชุดุบูู ูุฃูู ูุฑุฉ</option>
    <option value="reset">ุฅุนุงุฏุฉ ุถุจุท / ุฅุนุงุฏุฉ ุจุฑูุฌุฉ</option>
  </select>
</div>

      <div>
        <label>ุชุงุฑูุฎ ุงูุชูููุฐ ุงููุชููุน</label>
        <input type="date" id="supplyDate">
      </div>

      <div>
        <label>ูู ุงููุตุนุฏ ูุชูููุ</label>
        <select id="supplyStopped">
          <option value="no">ูุง</option>
          <option value="yes">ูุนู</option>
        </select>
      </div>

      <div style="grid-column:1/-1">
        <label>ูุตู ูุทุน ุงูุบูุงุฑ ุงููุทููุจุฉ</label>
        <textarea id="supplyDescription"
          placeholder="ูุซุงู: ุงูููุฑุชุฑ โ ูุฑุช ููุชุฑูู โ ุฃุฒุฑุงุฑ โ ุดุงุดุงุช โ ุจุทุงุฑูุงุช..."></textarea>
      </div>

      <div>
        <label>ูููุฉ ุงูุชูุฑูุฏ (ูุจู ุงูุถุฑูุจุฉ)</label>
        <input id="supplyMaterialPrice" type="number" min="0">
      </div>

      <div>
        <label>ูููุฉ ุงูุชุฑููุจ ูุงูุชุดุบูู (ูุจู ุงูุถุฑูุจุฉ)</label>
        <input id="supplyLaborPrice" type="number" min="0">
      </div>

      <!-- โ ุงูุฅุถุงูุงุช -->
      <div style="grid-column:1/-1">
        <label>ุฎูุงุฑุงุช ุฅุถุงููุฉ</label>
        <div style="display:flex;gap:16px;flex-wrap:wrap;
          border:1px solid #e5e7eb;padding:12px;border-radius:10px;background:#fff">
          
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="includeCommissioning">
            ูุดูู ุจุฑูุฌุฉ / ุชุดุบูู ุงููุธุงู
          </label>

          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="excludeFutureMaintenance" checked>
            ูุง ูุดูู ุตูุงูุฉ ูุณุชูุจููุฉ
          </label>
        </div>
      </div>

    </div>
  </div>
</div>



</div>
<button onclick="previewPricing()" style="margin-top:10px;background:#2563eb">
  ๐ ุนุฑุถ ุงูุญุณุจุฉ
</button>

<button id="saveBtn" onclick="saveContract()" style="margin-top:10px;display:none">
  ๐พ ุงุนุชูุงุฏ ูุญูุธ ุงูุนูุฏ
</button>


<!-- ================== ูุฑุงุฌุนุฉ ุงูุนูุฏ ================== -->
<div class="section" id="reviewSection" style="display:none">
<h3>ุฎุงูุณุงู: ูุฑุงุฌุนุฉ ุงูุนูุฏ</h3>
<div class="review-box" id="reviewBox"></div>

</div>

</div>
<!-- ================== ุณุฌู ุงูุฎุฏูุงุช ================== -->
<div class="section">
  <h3>ุณุฌู ุงูุตูุงูุฉ (ุนููุฏ ุณูููุฉ + ุฒูุงุฑุงุช ููุฑุฉ ูุงุญุฏุฉ)</h3>

  <!-- ุฌุฏูู ุงูุนููุฏ ุงูุณูููุฉ -->
  <h4 style="margin:10px 0;color:#0f766e">ุฃ) ุงูุนููุฏ ุงูุณูููุฉ ุงููุนุชูุฏุฉ</h4>
  <div class="table-wrap">
    <table border="1" width="100%" cellpadding="8" style="border-collapse:collapse">
      <thead style="background:#f3f4f6">
        <tr>
          <th>#</th>
          <th>ุฑูู ุงูุนูุฏ</th>
          <th>ุงูุนููู</th>
          <th>ุนุฏุฏ ุงููุตุงุนุฏ</th>
          <th>ูููุฉ ุงูุนูุฏ</th>
          <th>ุงููุบุฉ</th>
          <th>ุชุงุฑูุฎ ุงูุนูุฏ</th>
          <th>ุฅุฌุฑุงุกุงุช</th>
        </tr>
      </thead>
      <tbody id="annualContractsTable"></tbody>
    </table>
  </div>

  <!-- ุฌุฏูู ุงูุฒูุงุฑุงุช -->
  <h4 style="margin:18px 0 10px;color:#0f766e">ุจ) ุงูุฒูุงุฑุงุช ููุฑุฉ ูุงุญุฏุฉ (ุนุฑุถ ุณุนุฑ / ุชูุฑูุฑ)</h4>
  <div class="table-wrap">
    <table border="1" width="100%" cellpadding="8" style="border-collapse:collapse">
      <thead style="background:#f3f4f6">
        <tr>
          <th>#</th>
          <th>ุฑูู ุงูุฒูุงุฑุฉ</th>
          <th>ุงูุนููู</th>
          <th>ุนุฏุฏ ุงููุตุงุนุฏ</th>
          <th>ูููุฉ ุงูุฒูุงุฑุฉ</th>
          <th>ุชุงุฑูุฎ ุงูุฒูุงุฑุฉ</th>
          <th>ููุน ุงูุฒูุงุฑุฉ</th>
          <th>ุฅุฌุฑุงุกุงุช</th>
        </tr>
      </thead>
      <tbody id="onceVisitsTable"></tbody>
    </table>
  </div>
</div>
<!-- ุฌุฏูู ุชูุฑูุฏ ูุชุฑููุจ ูุชุดุบูู -->
<h4 style="margin:18px 0 10px;color:#0f766e">
  ุฌ) ุชูุฑูุฏ ูุชุฑููุจ ูุชุดุบูู ูุทุน ุบูุงุฑ
</h4>

<div class="table-wrap">
  <table border="1" width="100%" cellpadding="8" style="border-collapse:collapse">
    <thead style="background:#f3f4f6">
      <tr>
        <th>#</th>
        <th>ุฑูู ุงูุนุฑุถ</th>
        <th>ุงูุนููู</th>
        <th>ุงุณู ุงููุดุฑูุน</th>
        <th>ููุน ุงูุนูู</th>
        <th>ุงููููุฉ ุงูุฅุฌูุงููุฉ</th>
        <th>ุชุงุฑูุฎ ุงูุชูููุฐ</th>
        <th>ุฅุฌุฑุงุกุงุช</th>
      </tr>
    </thead>
    <tbody id="supplyInstallTable"></tbody>
  </table>
</div>


<script>
let customer = null;

/* =========================================================
   ุชุญููู ุงูุนููุงุก ูู ุงูุชุฎุฒูู (ููุณ ููุฑุฉ elevator-quote)
   - ุฌุฑูุจ ุฃูุซุฑ ูู ููุชุงุญ ุดุงุฆุน ุนุดุงู ูุง ุชุชุนุทู ูู ุงุฎุชูู ุงุณู ุงูุชุฎุฒูู
========================================================= */
function getCustomersFromStorage(){
  const possibleKeys = [
    'rkl_customers',
    'customers',
    'rkl_customers_list',
    'rkl_customer_list'
  ];

  for(const key of possibleKeys){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) continue;
      const arr = JSON.parse(raw);
      if(Array.isArray(arr) && arr.length) return arr;
    }catch(e){}
  }
  return [];
}

function renderCustomerInfo(c){
  const box = document.getElementById('customerInfo');
  if(!c){
    box.innerHTML = 'โ';
    return;
  }

  box.innerHTML = `
    ุงูุนููู: <span class="user-data">${c.customer_name || c.name || 'โ'}</span>
    <p><b>ุงูุฌูุงู:</b> ${c.mobile || c.phone || 'โ'}</p>
    <p><b>ุงููุฏููุฉ:</b> ${c.city || 'โ'}</p>
    <p><b>ุงูุนููุงู:</b> ${(c.full_address || c.address || 'โ')}</p>
  `;
}

function fillCustomerSelect(){
  const select = document.getElementById('customerSelect');
  const customers = getCustomersFromStorage();

  // ุชูุฑูุบ ุงูุฎูุงุฑุงุช
  select.innerHTML = `<option value="">-- ุงุฎุชุฑ ุงูุนููู --</option>`;

  // ุชุนุจุฆุฉ ุงูุฎูุงุฑุงุช
  customers.forEach((c, idx) => {
    const name = c.customer_name || c.name || `ุนููู ${idx+1}`;
    const city = c.city ? ` - ${c.city}` : '';
    const opt = document.createElement('option');
    opt.value = String(idx);
    opt.textContent = `${name}${city}`;
    select.appendChild(opt);
  });

  // ุฅู ูุงู ููุงู ุนููู ููุญุฏุฏ ุณุงุจููุง
  const saved = localStorage.getItem('rkl_selected_customer');
  if(saved){
    try{
      const savedObj = JSON.parse(saved);
      const savedName = savedObj.customer_name || savedObj.name || '';
      const foundIndex = customers.findIndex(x => (x.customer_name || x.name || '') === savedName);
      if(foundIndex > -1){
        select.value = String(foundIndex);
        customer = customers[foundIndex];
        renderCustomerInfo(customer);
        return;
      }
    }catch(e){}
  }

  // ุฅุฐุง ูุง ูู ุชุญุฏูุฏ ุณุงุจู: ุงุนุฑุถ ุฃูู ุนููู (ุงุฎุชูุงุฑู)
  if(customers.length){
    select.value = "0";
    customer = customers[0];
    localStorage.setItem('rkl_selected_customer', JSON.stringify(customer));
    renderCustomerInfo(customer);
  }else{
    renderCustomerInfo(null);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  fillCustomerSelect();

  document.getElementById('customerSelect').addEventListener('change', (e) => {
    const customers = getCustomersFromStorage();
    const idx = Number(e.target.value);

    if(!e.target.value){
      customer = null;
      localStorage.removeItem('rkl_selected_customer');
      renderCustomerInfo(null);
      return;
    }

    customer = customers[idx] || null;
    if(customer){
      localStorage.setItem('rkl_selected_customer', JSON.stringify(customer));
    }
    renderCustomerInfo(customer);
  });
});


  function generateFullContractText(){

  const lang = document.getElementById('lang').value;
  const date = document.getElementById('contractDate').value;
  const lifts = document.getElementById('lifts').value;
const brandSelect = document.getElementById('brandSelect').value;
const brandOther  = document.getElementById('brandOther')?.value || '';
const projectName     = (document.getElementById('projectName')?.value || 'โ').trim();
const projectLocation = (document.getElementById('projectLocation')?.value || 'โ').trim();

let brand = '';

if (brandSelect === 'Local') {
  brand = 'local';
} else if (brandSelect === 'Other') {
  brand = brandOther.trim().toLowerCase() || 'other';
} else {
  brand = brandSelect.toLowerCase();
}


  const buildingType = document.getElementById('building').value === 'government'
    ? 'ุญูููู'
    : 'ุฎุงุต';

  const city = customer.city || 'โ';
  const address = customer.full_address || city;
  const mobile = customer.mobile || 'โ';

 const calc = window.finalCalcOverride || calculateTotal();


/* ================== ุงููุต ุงูุนุฑุจู ================== */
const ar = `
ุจุนูู ุงููู ูุชูููููุ ููุฏ ุชู ูู ููู ${date} ุฅุจุฑุงู ูุฐุง ุงูุนูุฏ ุจูู ููู ูู:

ุฃูููุง: ุงูุทุฑู ุงูุฃูู  
ูุคุณุณุฉ ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ  
ุณุฌู ุชุฌุงุฑู ุฑูู: (1010709355)  
ุฑูู ุงูุชุนุฑูู ุงูุถุฑูุจู: (302250422600003)  
ุงูุนููุงู: ุญู ุงูุณูููุงููุฉ โ ูุฏููุฉ ุงูุฑูุงุถ โ ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ  
ูุงุชู: 0114774021  
ูููุดุงุฑ ุฅูููุง ูุงุญููุง ุจู (ุงูุทุฑู ุงูุฃูู)

ุซุงูููุง: ุงูุทุฑู ุงูุซุงูู  
ุงุณู ุงูุนููู: ${customer.customer_name}  
ุฑูู ุงูุฌูุงู: ${mobile}  
ุงูุนููุงู: ${address}  
ูููุดุงุฑ ุฅููู ูุงุญููุง ุจู (ุงูุทุฑู ุงูุซุงูู)

### ุชูููุฏ:
ูุธุฑูุง ูุฑุบุจุฉ ุงูุทุฑู ุงูุซุงูู ูู ุงูุชุนุงูุฏ ุนูู ุฃุนูุงู ุงูุตูุงูุฉ ุงูููุงุฆูุฉ ุงูุฏูุฑูุฉ ูุนุฏุฏ (${lifts}) ูุตุนุฏ/ูุตุงุนุฏ ุฑูุงุจุ
ูู ููุน (${brand})ุ ุชุฎุฏู ูุจูู (${buildingType}) ุงููุงุฆู ูู ูุฏููุฉ (${city})ุ
ูุญูุซ ุฅู ุงูุทุฑู ุงูุฃูู ุฌูุฉ ูุชุฎุตุตุฉ ููุฑุฎุตุฉ ูู ุฃุนูุงู ุตูุงูุฉ ุงููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉุ
ููุฏ ุงุชูู ุงูุทุฑูุงู โ ูููุง ุจูุงูู ุฃูููุชููุง ุงูุดุฑุนูุฉ ูุงููุธุงููุฉ โ ุนูู ูุง ููู:
ุงุณู ุงููุดุฑูุน: (${projectName})
ูููุน ุงููุดุฑูุน: (${projectLocation})

### ุงููุงุฏุฉ (1): ูุทุงู ุงูุนูุฏ
ููุชุฒู ุงูุทุฑู ุงูุฃูู ุจุชูุฏูู ุฎุฏูุงุช ุงูุตูุงูุฉ ุงูููุงุฆูุฉ ุงูุฏูุฑูุฉ ูููุตุงุนุฏ ุงููุดูููุฉ ุจุงูุนูุฏุ ููููุง ูููุนุงููุฑ ุงููููุฉ ุงููุนุชูุฏุฉ ูุฃูุธูุฉ ุงูุณูุงูุฉ ุงููุนููู ุจูุง ูู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ.

### ุงููุงุฏุฉ (2): ุฃุนูุงู ุงูุตูุงูุฉ ุงูููุงุฆูุฉ
ุชุดูู ุฃุนูุงู ุงูุตูุงูุฉ ุงูููุงุฆูุฉ โ ุฏูู ุญุตุฑ โ ูุง ููู:
- ุงููุญุต ุงูุฏูุฑู ุงูุดูุฑู ูุฌููุน ููููุงุช ุงููุตุนุฏ.
- ุชูุธูู ูุชุฒููุช ุงูุฃุฌุฒุงุก ุงููููุงููููุฉ ุงููุชุญุฑูุฉ.
- ูุญุต ุฃุฌูุฒุฉ ุงูุฃูุงู ูุฃูุธูุฉ ุงูุชุญูู.
- ุงูุชุฃูุฏ ูู ุณูุงูุฉ ุงููุญุฑูุงุชุ ุงูููุงุจุญุ ุงูุญุจุงูุ ูุงูุฃุจูุงุจ.
- ุชุณุฌูู ุงูููุงุญุธุงุช ุงููููุฉ ูุงูุชูุตูุงุช ุงููุงุฒูุฉ.

### ุงููุงุฏุฉ (3): ุงูุจูุงุบุงุช ูุงูุฃุนุทุงู
ููุชุฒู ุงูุทุฑู ุงูุซุงูู ุจุฅุจูุงุบ ุงูุทุฑู ุงูุฃูู ููุฑ ููุงุญุธุฉ ุฃู ุฎูู ุฃู ุชููู ุบูุฑ ุทุจูุนูุ ููููู ุงูุทุฑู ุงูุฃูู ุจุงุชุฎุงุฐ ุงูุฅุฌุฑุงุกุงุช ุงููุงุฒูุฉ ูุฅุนุงุฏุฉ ุงููุตุนุฏ ุฅูู ูุถุน ุงูุชุดุบูู ุงูุทุจูุนู.

### ุงููุงุฏุฉ (4): ุงูุงุณุชุฌุงุจุฉ ููุทูุงุฑุฆ
ููุชุฒู ุงูุทุฑู ุงูุฃูู ุจุงูุงุณุชุฌุงุจุฉ ูุจูุงุบุงุช ุงูุฃุนุทุงู ุงูุทุงุฑุฆุฉ ุฎูุงู ูุฏุฉ ุฒูููุฉ ูุนูููุฉ ุญุณุจ ูููุน ุงููุดุฑูุน ูุทุจูุนุฉ ุงูุนุทู.

### ุงููุงุฏุฉ (5): ุชุฏุฑูุจ ููุธูู ุงูุนููู
ููุชุฒู ุงูุทุฑู ุงูุฃูู ุจุชุฏุฑูุจ ุนุฏุฏ (1โ2) ูู ููุธูู ุงูุทุฑู ุงูุซุงูู ุนูู ุฅุฌุฑุงุกุงุช ุฅููุงุฐ ุงูุฑูุงุจ ุงููุญุชุฌุฒูู ุฏุงุฎู ุงููุตุนุฏ ูู ุญุงูุงุช ุงูุทูุงุฑุฆ.

### ุงููุงุฏุฉ (6): ุงููุณุชูุฒูุงุช ุงูุชุดุบูููุฉ
ูุชุนูุฏ ุงูุทุฑู ุงูุฃูู ุจุชูููุฑ ุงูุฒููุชุ ุงูุดุญููุ ูููุงุฏ ุงูุชูุธูู ุงููุงุฒูุฉ ูุฃุนูุงู ุงูุตูุงูุฉ ุงูููุงุฆูุฉ.

### ุงููุงุฏุฉ (7): ูุทุน ุงูุบูุงุฑ
ูุง ูุดูู ูุฐุง ุงูุนูุฏ ุชูุฑูุฏ ุฃู ุงุณุชุจุฏุงู ูุทุน ุงูุบูุงุฑุ ููุชุญูู ุงูุทุฑู ุงูุซุงูู ุชูููุฉ ุฃู ูุทุน ุบูุงุฑ ูุชู ุงุณุชุจุฏุงููุงุ ููุชู ุชุณุนูุฑูุง ุจุนุฑุถ ุณุนุฑ ูุณุชูู ููุนุชูุฏ.

### ุงููุงุฏุฉ (8): ูููุฉ ุงูุนูุฏ
ููุชุฒู ุงูุทุฑู ุงูุซุงูู ุจุณุฏุงุฏ ูููุฉ ุงูุนูุฏ ุงูุณููู ููู ุงูุจูุงู ุงูุชุงูู:


<div class="contract-summary">
  <h4>ููุฎุต ุงููููุฉ ุงูุฅุฌูุงููุฉ ููุนูุฏ</h4>
  <table>
    <tr>
      <td class="label">ูููุฉ ุงูุนูุฏ ูุจู ุงูุถุฑูุจุฉ</td>
      <td class="value">${(calc.total / 1.15).toFixed(2)} ุฑูุงู ุณุนูุฏู</td>
    </tr>
    <tr>
      <td class="label">ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (15%)</td>
      <td class="value">${(calc.total - (calc.total / 1.15)).toFixed(2)} ุฑูุงู ุณุนูุฏู</td>
    </tr>
    <tr>
      <td class="label total">ุฅุฌูุงูู ูููุฉ ุงูุนูุฏ ุดุงูู ุงูุถุฑูุจุฉ</td>
      <td class="value total">${calc.total.toFixed(2)} ุฑูุงู ุณุนูุฏู</td>
    </tr>
  </table>
</div>

### ุงููุงุฏุฉ (9): ูุฏุฉ ุงูุนูุฏ
ุชุณุฑู ูุฏุฉ ูุฐุง ุงูุนูุฏ ููุฏุฉ ุณูุฉ ูููุงุฏูุฉ ูุงุญุฏุฉ ุชุจุฏุฃ ูู:
- ุชุงุฑูุฎ ุงูุจุฏุงูุฉ: ${date}
- ุชุงุฑูุฎ ุงูุงูุชูุงุก: ${(() => {
  const d = new Date(date);
  d.setFullYear(d.getFullYear() + 1);
  return d.toISOString().split('T')[0];
})()}

ููุชุฌุฏุฏ ุงูุนูุฏ ุชููุงุฆููุง ูุง ูู ููุฎุทุฑ ุฃุญุฏ ุงูุทุฑููู ุงูุขุฎุฑ ุฎุทููุง ุจุนุฏู ุงูุฑุบุจุฉ ูู ุงูุชุฌุฏูุฏ ูุจู (60) ููููุง ูู ุชุงุฑูุฎ ุงูุงูุชูุงุก.

### ุงููุงุฏุฉ (10): ุงูุณุฏุงุฏ ูุงูุชุญููู ุงูุจููู
ุชูุณุฏุฏ ุงูุฏูุนุงุช ุนุจุฑ ุงูุชุญููู ุงูุจููู ุฅูู ุงูุญุณุงุจ ุงูุชุงูู:
ุงูุจูู: ุงูุจูู ุงูุฃููู ุงูุณุนูุฏู (SNB)  
ุงุณู ุงูุญุณุงุจ: ุขุฑ ูู ุงู RKL  
ุฑูู ุงูุญุณุงุจ: 01400005531406  
ุงูุขูุจุงู: SA1710000001400005531406  

### ุงููุงุฏุฉ (11): ุงูุฅููุงู ุจุณุจุจ ุนุฏู ุงูุณุฏุงุฏ
ูุญู ููุทุฑู ุงูุฃูู ุฅููุงู ุฃุนูุงู ุงูุตูุงูุฉ ูุคูุชูุง ูู ุญุงู ุชุฃุฎุฑ ุงูุทุฑู ุงูุซุงูู ุนู ุงูุณุฏุงุฏุ ุฏูู ุฃู ูุณุคูููุฉ ูุงููููุฉ.

### ุงููุงุฏุฉ (12): ุญุฏูุฏ ุงููุณุคูููุฉ
ูุง ูุชุญูู ุงูุทุฑู ุงูุฃูู ุฃู ูุณุคูููุฉ ุนู ุงูุฃุนุทุงู ุงููุงุชุฌุฉ ุนู:
- ุณูุก ุงูุงุณุชุฎุฏุงู ุฃู ุงูุชุญููู ุงูุฒุงุฆุฏ
- ุงูุนุจุซ ุฃู ุงูุชุฎุฑูุจ
- ุงููุทุงุน ุฃู ุถุนู ุงูุชูุงุฑ ุงูููุฑุจุงุฆู
- ุงูููุงุฑุซ ุงูุทุจูุนูุฉ ุฃู ุงูุธุฑูู ุงููุงูุฑุฉ
- ุชุฏุฎู ุฃุทุฑุงู ุบูุฑ ูุนุชูุฏุฉ

### ุงููุงุฏุฉ (13): ุงูุณูุงูุฉ
ููุชุฒู ุงูุทุฑู ุงูุซุงูู ุจุชูููุฑ ุจูุฆุฉ ุนูู ุขููุฉ ุฏุงุฎู ูููุน ุงููุตุงุนุฏ ููู ุงุดุชุฑุงุทุงุช ุงูุณูุงูุฉ ุงููุนุชูุฏุฉ.

### ุงููุงุฏุฉ (14): ุงูุฅููุงุก
ูุฌูุฒ ูุฃู ูู ุงูุทุฑููู ุฅููุงุก ุงูุนูุฏ ุจุฅุดุนุงุฑ ุฎุทู ูุณุจู ูุฏุชู (30) ููููุงุ ูุน ุชุณููุฉ ุฌููุน ุงูุงูุชุฒุงูุงุช ุงููุงููุฉ ุญุชู ุชุงุฑูุฎ ุงูุฅููุงุก.
### ุงููุงุฏุฉ (15): ุงุณุชุญูุงู ูุงูู ูููุฉ ุงูุนูุฏ
ููุฑ ุงูุทุฑู ุงูุซุงูู ูููุงูู ุตุฑุงุญุฉู ุจุฃูู ุจูุฌุฑุฏ ุณุฏุงุฏ ุฃู ุฏูุนุฉ ูุงููุฉ ูู ูููุฉ ูุฐุง ุงูุนูุฏ โ ุณูุงุก ูุงูุช ุฏูุนุฉ ุฌุฒุฆูุฉ ุฃู ุฃูููุฉ โ ูุฅู ุฐูู ููุนุฏ ุฅูุฑุงุฑูุง ููุงุฆููุง ุจุงูุงูุชุฒุงู ุจูุงูู ูููุฉ ุงูุนูุฏ ุงูุณูููุฉุ ูุชุตุจุญ ุงููููุฉ ุงูุฅุฌูุงููุฉ ููุนูุฏ ูุณุชุญูุฉ ุงูุณุฏุงุฏ ููุทุฑู ุงูุฃูู ูุงููุฉูุ ููุง ูุญู ููุทุฑู ุงูุซุงูู ุงููุทุงูุจุฉ ุจุฅูุบุงุก ุงูุนูุฏ ุฃู ุชุฎููุถ ูููุชู ุฃู ุชุนููู ุงูุงูุชุฒุงู ุงููุงูู ูุฃู ุณุจุจ ูุงู ุจุนุฏ ุงูุณุฏุงุฏ ุงูุฌุฒุฆู.

### ุงููุงุฏุฉ (16): ุงุญุชุณุงุจ ุงูุฒูุงุฑุงุช ูู ุญุงู ุชููู ุงููุตุนุฏ
ููุฑ ุงูุทุฑู ุงูุซุงูู ูููุงูู ุนูู ุฃู ุงูุฒูุงุฑุฉ ุงูููุฏุงููุฉ ุงูุชู ูููู ุจูุง ุงูุทุฑู ุงูุฃูู ุชูุนุฏ ุฒูุงุฑุฉ ุตูุงูุฉ ููุชููุฉ ุถูู ุฌุฏูู ุงูุตูุงูุฉ ุงูููุงุฆูุฉ ุงููุชูู ุนูููุ ุญุชู ูู ุญุงู ูุงู ุงููุตุนุฏ ูุชููููุง ุนู ุงูุนููุ ุฃู ุชุจูู ุฃุซูุงุก ุงูุฒูุงุฑุฉ ูุฌูุฏ ุนุทู ูุชุทูุจ ุงุณุชุจุฏุงู ูุทุน ุบูุงุฑ ุฃู ุฃุนูุงู ุฅุถุงููุฉ ุบูุฑ ูุดูููุฉ ูู ูุฐุง ุงูุนูุฏ.

ููุง ููุชุฒู ุงูุทุฑู ุงูุฃูู ุจุฅุนุงุฏุฉ ุฒูุงุฑุฉ ุงููููุน ุฃู ุชูููุฐ ุฃุนูุงู ุฅุถุงููุฉ ุฅูุง ุจุนุฏ ุงุนุชูุงุฏ ุนุฑุถ ุณุนุฑ ูุณุชูู ูุชูุฑูุฏ ุฃู ุงุณุชุจุฏุงู ูุทุน ุงูุบูุงุฑ ุงููุทููุจุฉุ ูุชูุนุฏ ุงูุฒูุงุฑุฉ ุงููููุฐุฉ ูู ูุฐู ุงูุญุงูุฉ ุฒูุงุฑุฉ ูุญุชุณุจุฉ ูููุชููุฉ ููุง ุชูุนุงุฏ ูุฌุงููุง.

### ุงููุงุฏุฉ (17): ุงูุงุฎุชุตุงุต ุงููุถุงุฆู
ูู ุญุงู ูุดูุก ุฃู ูุฒุงุน โ ูุง ูุฏุฑ ุงููู โ ูููู ุงูุงุฎุชุตุงุต ุงููุถุงุฆู ูููุญุงูู ุงููุฎุชุตุฉ ูู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ.

ูุจูุฐุง ุชู ุชูููุน ูุฐุง ุงูุนูุฏ ุจููุงููุฉ ุงูุทุฑูููุ ูููุนุฏ ูุงูุฐูุง ูููุฒููุง ูู ุชุงุฑูุฎ ุงุนุชูุงุฏู.
`;


/* ================== English Text ================== */
const en = `
By the grace of God, this Annual Preventive Maintenance Agreement was executed on ${date} between:

First Party  
RKL Elevators & Escalators  
Commercial Registration No.: 1010709355  
VAT No.: 302250422600003  
Address: Al Sulaymaniyah โ Riyadh โ Saudi Arabia  
Tel: 0114774021  
Hereinafter referred to as the โFirst Partyโ

Second Party  
Customer Name: ${customer.customer_name}  
Mobile No.: ${mobile}  
Address: ${address}  
Hereinafter referred to as the โSecond Partyโ
Project Name: (${projectName})
Project Location: (${projectLocation})

### Preamble:
Whereas the Second Party desires to engage the First Party for annual preventive maintenance services for (${lifts}) passenger elevator(s),
Brand (${brand}), serving a (${buildingType}) building located in (${city}),
and whereas the First Party is a duly licensed and qualified elevator maintenance contractor,
the parties hereby agree as follows:

### Article (1): Scope of Agreement
The First Party shall provide preventive maintenance services in accordance with applicable safety standards and regulations of the Kingdom of Saudi Arabia.

### Article (2): Preventive Maintenance Services
Preventive maintenance services shall include, but not be limited to:
- Monthly inspection of all elevator components
- Cleaning and lubrication of mechanical parts
- Inspection of safety devices and control systems
- Functional testing of motors, brakes, ropes, and doors
- Issuance of technical observations and recommendations

### Article (3): Fault Reporting
The Second Party shall promptly notify the First Party of any abnormal operation or stoppage.

### Article (4): Emergency Response
The First Party shall respond to emergency breakdowns within a reasonable time depending on site location and fault nature.

### Article (5): Training
The First Party shall provide rescue procedure training to one or two building staff nominated by the Second Party.

### Article (6): Consumables
The First Party shall supply lubricants, grease, and cleaning materials required for preventive maintenance.

### Article (7): Spare Parts
Spare parts replacement is excluded from this contract and shall be quoted separately upon approval by the Second Party.

### Article (8): Contract Value
The total annual contract value is SAR ${calc.total.toFixed(2)}, inclusive of 15% VAT, excluding spare parts.

### Article (9): Contract Term
This Agreement shall be valid for one calendar year from the commencement date and shall be automatically renewed unless terminated by written notice at least sixty (60) days prior to expiry.

### Article (10): Payment Method
Payments shall be made via bank transfer to:
Bank: Saudi National Bank (SNB)  
Account Name: RKL  
IBAN: SA1710000001400005531406  

### Article (11): Suspension
The First Party reserves the right to suspend services in case of delayed payment without liability.

### Article (12): Limitation of Liability
The First Party shall not be liable for failures resulting from misuse, overloading, power outages, vandalism, force majeure events, or unauthorized third-party intervention.

### Article (13): Safety Compliance
The Second Party shall ensure a safe working environment in accordance with safety regulations.

### Article (14): Termination
Either party may terminate this Agreement with thirty (30) daysโ prior written notice, subject to settlement of all outstanding dues.

### Article (15): Full Contract Value Entitlement
The Second Party hereby acknowledges and agrees that upon payment of any partial or initial amount under this Agreement, the full annual contract value shall become immediately due and payable to the First Party. Such payment shall constitute a final acknowledgment and commitment to the total contract value, and the Second Party shall not be entitled to cancel, reduce, or suspend the financial obligations under this Agreement for any reason after such payment.
### Article (16): Visits During Elevator Shutdown or Spare Parts Requirement
The Second Party acknowledges and agrees that any site visit carried out by the First Party shall be considered a completed preventive maintenance visit under the agreed schedule, even if the elevator is found to be out of service or requires spare parts replacement or additional works not covered under this Agreement.

The First Party shall not be obligated to conduct additional visits or resume maintenance works unless a separate quotation for the required spare parts or corrective works is approved. The performed visit shall be deemed valid, completed, and non-refundable.

### Article (17): Governing Law & Jurisdiction
This Agreement shall be governed by the laws of the Kingdom of Saudi Arabia, and the competent courts of Saudi Arabia shall have exclusive jurisdiction.

IN WITNESS WHEREOF, the parties have executed this Agreement as of the date first written above.
`;


  /* ================== ุงุฎุชูุงุฑ ุงููุบุฉ ================== */
  if(lang === 'ar') return ar;
  if(lang === 'en') return en;
  return ar + '\n\n---------------------------------\n\n' + en;
}
const cityZones = {
  riyadh: {
    label: 'ุงูุฑูุงุถ',
    increase: 0
  },
  near: {
    label: 'ูุฑูุจุฉ ูู ุงูุฑูุงุถ',
    increase: 0.05
  },
  medium: {
    label: 'ูุชูุณุทุฉ ุงูุจุนุฏ',
    increase: 0.10
  },
  far: {
    label: 'ุจุนูุฏุฉ',
    increase: 0.15
  },
  remote: {
    label: 'ูุงุฆูุฉ',
    increase: 0.20
  }
};

  

function calculateTotal(){

  const capacityValue = document.getElementById('capacity')?.value || '';
  const floorsValue   = document.getElementById('floors')?.value || '';
  const liftsValue    = document.getElementById('lifts')?.value || '';

  if (!capacityValue || !floorsValue || !liftsValue) {
    return {
      pricePerLift: 0,
      lifts: 0,
      zone: 'โ',
      subtotal: 0,
      vat: 0,
      total: 0
    };
  }

  let pricePerLift = Number(capacityValue);

  const lifts    = Number(liftsValue);
  const floors   = Number(floorsValue);
  const building = document.getElementById('building')?.value || 'private';

  const brandSelect = document.getElementById('brandSelect')?.value || '';
  const brandOther  = document.getElementById('brandOther')?.value || '';

  let brand = '';
  if (brandSelect === 'Local') {
    brand = 'local';
  } else if (brandSelect === 'Other') {
    brand = brandOther.trim().toLowerCase() || 'other';
  } else {
    brand = brandSelect.toLowerCase();
  }

  const cityKey = document.getElementById('projectCity')?.value || 'riyadh';
  const zone = cityZones[cityKey] || cityZones.riyadh;

  if (floors > 2) pricePerLift *= 1.10;
  if (building === 'government') pricePerLift *= 1.50;
  if (['otis','kone','wittur','mitsubishi','schindler'].includes(brand)) pricePerLift += 2000;

  pricePerLift *= (1 + zone.increase);

  let subtotal = pricePerLift * lifts;

  if (lifts >= 3) subtotal *= 0.90;

  const vat   = subtotal * 0.15;
  const total = subtotal + vat;

  return {
    pricePerLift,     // ุฑูู
    lifts,
    zone: zone.label,
    subtotal,         // ุฑูู
    vat,              // ุฑูู
    total             // ุฑูู
  };
}

/* =========================================================
   โ ูุนุงููุฉ ุงูุชุณุนูุฑ (ุฒุฑ ๐ ุนุฑุถ ุงูุญุณุจุฉ)
   - ุชูุธูุฑ reviewSection
   - ุชููุฃ reviewBox
   - ุชูุธูุฑ ุฒุฑ ุงูุญูุธ saveBtn
   - ุชุฏุนู ุณุนุฑ ูุฏูู ูููุตุนุฏ (ููุนูุฏ ุงูุณููู)
========================================================= */

window.manualPricePerLift = null; // ุณุนุฑ ูุฏูู ูููุตุนุฏ
window.finalCalcOverride  = null; // ูุชูุฌุฉ ูุนุชูุฏุฉ ุจุนุฏ ุงูุชุนุฏูู

function fmt(n){
  return (Number(n || 0)).toFixed(2);
}

function paintPreviewAnnual(calc, isManual){
  const box = document.getElementById('reviewBox');
  if(!box) return;

  box.innerHTML = `
    <div class="contract-summary">
      <h4>ูุนุงููุฉ ุงูุชุณุนูุฑ ูุจู ุงูุงุนุชูุงุฏ</h4>
      <table>
        <tr>
          <td class="label">ุนุฏุฏ ุงููุตุงุนุฏ</td>
          <td class="value">${calc.lifts}</td>
        </tr>
        <tr>
          <td class="label">ุงูููุทูุฉ</td>
          <td class="value">${calc.zone || 'โ'}</td>
        </tr>
        <tr>
          <td class="label">ุงูุณุนุฑ ูููุตุนุฏ (ูุงุจู ููุชุนุฏูู)</td>
          <td class="value" style="text-align:left;direction:ltr">
            <input
              id="manualPricePerLift"
              type="number"
              min="0"
              step="0.01"
              style="width:180px;text-align:left"
              value="${fmt(calc.pricePerLift)}"
              oninput="recomputeFromManual()"
            />
            <div style="font-size:12px;color:#6b7280;margin-top:4px;direction:rtl;text-align:right">
              ${isManual ? 'โ ุชู ุงุนุชูุงุฏ ุณุนุฑ ูุฏูู ูุณูุชู ุงูุญูุธ ุนููู.' : 'โน๏ธ ูุฐุง ุณุนุฑ ูุญุณูุจ ุชููุงุฆููุง ูููููู ุชุนุฏููู.'}
            </div>
          </td>
        </tr>
        <tr>
          <td class="label">ุงูุฅุฌูุงูู ูุจู ุงูุถุฑูุจุฉ</td>
          <td class="value"><span id="pv_subtotal">${fmt(calc.subtotal)}</span> ุฑูุงู</td>
        </tr>
        <tr>
          <td class="label">ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (15%)</td>
          <td class="value"><span id="pv_vat">${fmt(calc.vat)}</span> ุฑูุงู</td>
        </tr>
        <tr>
          <td class="label total">ุงูุฅุฌูุงูู ุดุงูู ุงูุถุฑูุจุฉ</td>
          <td class="value total"><span id="pv_total">${fmt(calc.total)}</span> ุฑูุงู</td>
        </tr>
      </table>

      <p class="words">โ๏ธ ูุฐู ุงููุนุงููุฉ ูุจู ุงูุงุนุชูุงุฏ. ุนุฏูู ุณุนุฑ ุงููุตุนุฏ ูุณูุชู ุชุญุฏูุซ ุงูุฅุฌูุงูู ุชููุงุฆููุง.</p>
    </div>
  `;
}

function recomputeFromManual(){
  const lifts = Number(document.getElementById('lifts')?.value || 0);
  if(!lifts) return;

  const v = Number(document.getElementById('manualPricePerLift')?.value || 0);

  // ูู ูุงุถู/ุตูุฑ โ ุฑุฌูุน ููุญุณุจุฉ ุงูุชููุงุฆูุฉ
  if(!v || v <= 0){
    window.manualPricePerLift = null;
    const calc = calculateTotal();
    window.finalCalcOverride = calc;
    paintPreviewAnnual(calc, false);
    return;
  }

  window.manualPricePerLift = v;

  // โ ููุณ ููุทู ุงูุฎุตู ุนูุฏ 3 ูุตุงุนุฏ (10%) + ุงูุถุฑูุจุฉ
  let subtotal = v * lifts;
  if(lifts >= 3) subtotal *= 0.90;

  const vat = subtotal * 0.15;
  const total = subtotal + vat;

  const zone =
    (cityZones?.[document.getElementById('projectCity')?.value || 'riyadh']?.label) || 'โ';

  const calc = {
    pricePerLift: v,
    lifts,
    zone,
    subtotal,
    vat,
    total,
    isManual: true
  };

  window.finalCalcOverride = calc;

  // ุชุญุฏูุซ ุฃุฑูุงู ุงููุนุงููุฉ ุจุฏูู ุฅุนุงุฏุฉ ุฑุณู ูุงูู
  const s = document.getElementById('pv_subtotal');
  const v1 = document.getElementById('pv_vat');
  const t = document.getElementById('pv_total');
  if(s) s.textContent = fmt(subtotal);
  if(v1) v1.textContent = fmt(vat);
  if(t) t.textContent = fmt(total);
}

function previewPricing(){

  const serviceType = document.getElementById('serviceType')?.value || 'annual';

  /* =========================
     ุชุญูู ูู ุจูุงูุงุช ุงููุตุงุนุฏ ุงูุฃุณุงุณูุฉ
  ========================= */
  const baseRequired = ['lifts','capacity','floors'];
  for(const id of baseRequired){
    const el = document.getElementById(id);
    if(!el || !el.value){
      alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ุจูุงูุงุช ุงููุตุงุนุฏ ุงูุฃุณุงุณูุฉ (ุนุฏุฏ ุงููุตุงุนุฏุ ุงูุญูููุฉุ ุงูุทูุงุจู)');
      return;
    }
  }

  /* =========================
     1๏ธโฃ ุนูุฏ ุตูุงูุฉ ุณููู
  ========================= */
  if(serviceType === 'annual'){

    const annualRequired = ['lang','contractDate'];
    for(const id of annualRequired){
      const el = document.getElementById(id);
      if(!el || !el.value){
        alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ (ูุบุฉ ุงูุนูุฏ + ุชุงุฑูุฎ ุงูุนูุฏ) ูุนุฑุถ ุญุณุจุฉ ุงูุนูุฏ ุงูุณููู');
        return;
      }
    }

    const calc = calculateTotal();
    window.manualPricePerLift = null;
    window.finalCalcOverride = calc;
    paintPreviewAnnual(calc, false);
  }

  /* =========================
     2๏ธโฃ ุชูุฑูุฏ / ุชุฑููุจ / ุชุดุบูู
  ========================= */
  else if(serviceType === 'supply_install'){

    const supplyType = document.getElementById('supplyType').value;
    const supplyDate = document.getElementById('supplyDate').value;

    if(!supplyType || !supplyDate){
      alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ููุน ุงูุนูู ูุชุงุฑูุฎ ุงูุชูููุฐ');
      return;
    }

    /* ุชุดุบูู ุจุฏูู ูุทุน */
    if(supplyType === 'commission_only'){
      if(!document.getElementById('operationMode').value){
        alert('โ๏ธ ูุฑุฌู ุชุญุฏูุฏ ูู ุงูุชุดุบูู ูุฃูู ูุฑุฉ ุฃู ุฅุนุงุฏุฉ ุถุจุท');
        return;
      }
    } 
    /* ุชูุฑูุฏ ุฃู ุชุฑููุจ */
    else {
      if(!document.getElementById('supplyDescription').value ||
         !document.getElementById('supplyMaterialPrice').value){
        alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ูุตู ุงูุนูู ููููุฉ ุงูุชูุฑูุฏ');
        return;
      }
    }

    /* =========================
       ุงูุญุณุงุจ
    ========================= */
    let material = 0;
    let labor    = 0;

    if(supplyType !== 'commission_only'){
      material = Number(document.getElementById('supplyMaterialPrice').value || 0);
    }

    labor = Number(document.getElementById('supplyLaborPrice').value || 0);

    const subtotal = material + labor;
    const vat      = subtotal * 0.15;
    const total    = subtotal + vat;

    /* =========================
       ุงูุฎูุงุฑุงุช
    ========================= */
    const options = [];

    if(supplyType === 'commission_only'){
      const mode =
        document.getElementById('operationMode').value === 'first_time'
          ? 'ุชุดุบูู ูุฃูู ูุฑุฉ'
          : 'ุฅุนุงุฏุฉ ุถุจุท / ุฅุนุงุฏุฉ ุจุฑูุฌุฉ';

      options.push(`๐ง ููุน ุงูุชุดุบูู: ${mode}`);
    }

    if(document.getElementById('includeCommissioning')?.checked)
      options.push('ูุดูู ุจุฑูุฌุฉ / ุชุดุบูู ุงููุธุงู');

    if(document.getElementById('excludeFutureMaintenance')?.checked)
      options.push('ูุง ูุดูู ุตูุงูุฉ ูุณุชูุจููุฉ');

    /* =========================
       ุงููุนุงููุฉ
    ========================= */
    document.getElementById('reviewBox').innerHTML = `
      <div class="contract-summary">
        <h4>ูุนุงููุฉ ุนุฑุถ ุณุนุฑ (ุชูุฑูุฏ / ุชุดุบูู)</h4>
        <table>
          <tr><td class="label">ูููุฉ ุงูุชูุฑูุฏ</td><td class="value">${material.toFixed(2)} ุฑูุงู</td></tr>
          <tr><td class="label">ูููุฉ ุงูุชุฑููุจ / ุงูุชุดุบูู</td><td class="value">${labor.toFixed(2)} ุฑูุงู</td></tr>
          <tr><td class="label">ุงูุฅุฌูุงูู ูุจู ุงูุถุฑูุจุฉ</td><td class="value">${subtotal.toFixed(2)} ุฑูุงู</td></tr>
          <tr><td class="label">ุงูุถุฑูุจุฉ (15%)</td><td class="value">${vat.toFixed(2)} ุฑูุงู</td></tr>
          <tr>
            <td class="label total">ุงูุฅุฌูุงูู ุดุงูู ุงูุถุฑูุจุฉ</td>
            <td class="value total">${total.toFixed(2)} ุฑูุงู</td>
          </tr>
        </table>
        <p style="margin-top:10px"><b>ุงูุฎูุงุฑุงุช:</b><br>${options.join('<br>') || 'โ'}</p>
      </div>
    `;

    window.finalCalcOverride = {
      mode: 'supply_install',
      supplyType,
      material,
      labor,
      subtotal,
      vat,
      total,
      options,
      isManual: true
    };
  }

  /* =========================
     3๏ธโฃ ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ
  ========================= */
  else if(serviceType === 'once'){

    const onceRequired = ['onceVisitType','onceDate','onceIssue','oncePrice'];
    for(const id of onceRequired){
      const el = document.getElementById(id);
      if(!el || !el.value){
        alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ูุชุทูุจุงุช ุงูุฒูุงุฑุฉ (ููุน ุงูุฒูุงุฑุฉุ ุงูุชุงุฑูุฎุ ุงููุตูุ ุณุนุฑ ุงูุฒูุงุฑุฉ)');
        return;
      }
    }

    const subtotal = Number(document.getElementById('oncePrice').value || 0);
    const vat      = subtotal * 0.15;
    const total    = subtotal + vat;

    document.getElementById('reviewBox').innerHTML = `
      <div class="contract-summary">
        <h4>ูุนุงููุฉ ุนุฑุถ ุณุนุฑ (ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ)</h4>
        <table>
          <tr><td class="label">ููุน ุงูุฒูุงุฑุฉ</td><td class="value">${document.getElementById('onceVisitType').selectedOptions[0]?.textContent || 'โ'}</td></tr>
          <tr><td class="label">ุชุงุฑูุฎ ุงูุฒูุงุฑุฉ</td><td class="value">${document.getElementById('onceDate').value}</td></tr>
          <tr><td class="label">ุงููุจูุบ ูุจู ุงูุถุฑูุจุฉ</td><td class="value">${fmt(subtotal)} ุฑูุงู</td></tr>
          <tr><td class="label">ุงูุถุฑูุจุฉ (15%)</td><td class="value">${fmt(vat)} ุฑูุงู</td></tr>
          <tr><td class="label total">ุงูุฅุฌูุงูู ุดุงูู ุงูุถุฑูุจุฉ</td><td class="value total">${fmt(total)} ุฑูุงู</td></tr>
        </table>
      </div>
    `;

    window.finalCalcOverride = {
      mode: 'once',
      subtotal,
      vat,
      total,
      isManual: true
    };
  }

  /* =========================
     ุฅุธูุงุฑ ุงููุนุงููุฉ ูุฒุฑ ุงูุญูุธ
  ========================= */
  document.getElementById('reviewSection').style.display = 'block';

  const btn = document.getElementById('saveBtn');
  btn.style.display = 'inline-block';
  btn.textContent =
    serviceType === 'once'
      ? '๐พ ุญูุธ ุงูุฒูุงุฑุฉ ูู ุงูุณุฌู'
      : serviceType === 'supply_install'
        ? '๐พ ุญูุธ ุนุฑุถ ุงูุชูุฑูุฏ / ุงูุชุดุบูู'
        : '๐พ ุงุนุชูุงุฏ ูุญูุธ ุงูุนูุฏ';
}



function saveContract() {
  if (!customer) {
    alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููู ุฃููุงู');
    return;
  }

  const serviceType = document.getElementById('serviceType')?.value || 'annual';


  /* =========================
     ุจูุงูุงุช ูุดุชุฑูุฉ
  ========================= */
  const lifts    = document.getElementById('lifts').value;
  const capacity = document.getElementById('capacity').value;
  const floors   = document.getElementById('floors').value;

  if (!lifts || !capacity || !floors) {
    alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ุจูุงูุงุช ุงููุตุงุนุฏ ุงูุฃุณุงุณูุฉ (ุนุฏุฏ ุงููุตุงุนุฏุ ุงูุญูููุฉุ ุงูุทูุงุจู)');
    return;
  
  }
const projectName     = (document.getElementById('projectName')?.value || '').trim();
const projectLocation = (document.getElementById('projectLocation')?.value || '').trim();

if(!projectName || !projectLocation){
  alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ (ุงุณู ุงููุดุฑูุน + ูููุน ุงููุดุฑูุน)');
  return;
}
  /* =========================
     ุชุญูู ุญุณุจ ููุน ุงูุฎุฏูุฉ
  ========================= */
  if (serviceType === 'annual') {

    const lang = document.getElementById('lang').value;
    const date = document.getElementById('contractDate').value;

    if (!lang || !date) {
      alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ (ุงููุบุฉ + ุชุงุฑูุฎ ุงูุนูุฏ) ููุนูุฏ ุงูุณููู');
      return;
    }

  } 
  else if (serviceType === 'once') {

    const onceRequired = ['onceVisitType','onceDate','onceIssue','oncePrice'];
    for (const id of onceRequired) {
      const el = document.getElementById(id);
      if (!el || !el.value) {
        alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ูุชุทูุจุงุช ุงูุฒูุงุฑุฉ (ููุน ุงูุฒูุงุฑุฉุ ุงูุชุงุฑูุฎุ ุงููุตูุ ุณุนุฑ ุงูุฒูุงุฑุฉ)');
        return;
      }
    }

  } 
  else if (serviceType === 'supply_install') {

    const supplyType = document.getElementById('supplyType')?.value || '';
    const supplyDate = document.getElementById('supplyDate')?.value || '';

    if (!supplyType || !supplyDate) {
      alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ููุน ุงูุนูู ูุชุงุฑูุฎ ุงูุชูููุฐ');
      return;
    }

    /* ุชุดุบูู ุจุฏูู ูุทุน */
    if (supplyType === 'commission_only') {
      const op = document.getElementById('operationMode')?.value || '';
      if (!op) {
        alert('โ๏ธ ูุฑุฌู ุชุญุฏูุฏ ูู ุงูุชุดุบูู ูุฃูู ูุฑุฉ ุฃู ุฅุนุงุฏุฉ ุถุจุท');
        return;
      }
    } 
    /* ุชูุฑูุฏ / ุชุฑููุจ */
    else {
      const desc = document.getElementById('supplyDescription')?.value || '';
      const mat  = document.getElementById('supplyMaterialPrice')?.value || '';

      if (!desc || !mat) {
        alert('โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ูุตู ุงูุนูู ููููุฉ ุงูุชูุฑูุฏ');
        return;
      }
    }
  }

  /* =========================
     โ ุชุฃููุฏ ูุฌูุฏ ูุนุงููุฉ/ุญุณุจุฉ ูุจู ุงูุญูุธ
  ========================= */
  if (!window.finalCalcOverride || !window.finalCalcOverride.total) {
    alert('โ๏ธ ูุฑุฌู ุงูุถุบุท ุนูู ุฒุฑ (๐ ุนุฑุถ ุงูุญุณุจุฉ) ูุจู ุงูุญูุธ');
    return;
  }

  /* =========================
     ุงูุญูุธ
  ========================= */
  try {

    const calc = window.finalCalcOverride || calculateTotal();

    const supplyTypeNow = (serviceType === 'supply_install')
      ? (document.getElementById('supplyType')?.value || '')
      : '';
const elevatorType = document.getElementById('elevatorType')?.value || '';
const brandSelect  = document.getElementById('brandSelect')?.value || '';
const brandOther   = document.getElementById('brandOther')?.value || '';
const building     = document.getElementById('building')?.value || '';

    const contract = {
      id: (
        serviceType === 'once'
          ? 'VIS-'
          : serviceType === 'supply_install'
            ? 'SUP-'
            : 'PMC-'
      ) + Date.now(),

      serviceType,
      customer,
      lifts,
      projectName,
projectLocation,
     
elevatorType,
brandSelect,
brandOther,
capacity,
floors,
building,


      total: Number(calc.total || 0).toFixed(2) + ' ุฑูุงู',

      pricing: {
        zone: calc.zone || 'โ',
        pricePerLift: Number(calc.pricePerLift || 0),
        subtotal: Number(calc.subtotal || 0),
        vat: Number(calc.vat || 0),
        total: Number(calc.total || 0),
        isManual: !!calc.isManual
      },

      /* =========================
         ุจูุงูุงุช ุญุณุจ ููุน ุงูุฎุฏูุฉ
      ========================= */

      // ุนูุฏ ุณููู
      lang: (serviceType === 'annual')
        ? document.getElementById('lang').value
        : 'ar',

      date: (serviceType === 'annual')
        ? document.getElementById('contractDate').value
        : serviceType === 'once'
          ? document.getElementById('onceDate').value
          : document.getElementById('supplyDate').value,

      // ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ
      onceDetails: (serviceType === 'once') ? {
        visitType: document.getElementById('onceVisitType').value,
        visitDate: document.getElementById('onceDate').value,
        urgency: document.getElementById('onceUrgency').value,
        stopped: document.getElementById('onceStopped').value,
        issue: document.getElementById('onceIssue').value,
        priceBeforeVat: Number(document.getElementById('oncePrice').value || 0)
      } : null,

      // ุชูุฑูุฏ / ุชุฑููุจ / ุชุดุบูู
      supplyDetails: (serviceType === 'supply_install') ? {
        type: supplyTypeNow,

        operationMode:
          supplyTypeNow === 'commission_only'
            ? (document.getElementById('operationMode')?.value || null)
            : null,

        date: document.getElementById('supplyDate').value,
        stopped: document.getElementById('supplyStopped').value,
        description: document.getElementById('supplyDescription').value,

        material:
          supplyTypeNow === 'commission_only'
            ? 0
            : Number(document.getElementById('supplyMaterialPrice').value || 0),

        labor: Number(document.getElementById('supplyLaborPrice').value || 0),

        includeCommissioning:
          document.getElementById('includeCommissioning')?.checked || false,

        excludeFutureMaintenance:
          document.getElementById('excludeFutureMaintenance')?.checked || false
      } : null,

      // ูุญุชูู ุงูุนูุฏ (ููุท ููุนูุฏ ุงูุณููู)
      content: (serviceType === 'annual')
        ? generateFullContractText()
        : ''
    };

    const contracts = JSON.parse(
      localStorage.getItem('rkl_maintenance_contracts') || '[]'
    );

    contracts.push(contract);
    localStorage.setItem(
      'rkl_maintenance_contracts',
      JSON.stringify(contracts)
    );

    renderContractsTable();
    alert('โ ุชู ุงูุญูุธ ุจูุฌุงุญ ูุฅุถุงูุชู ููุณุฌู');

  } catch (error) {
    console.error(error);
    alert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ: ' + error.message);
  }
}


function openSupplyOfferPrint(contract) {
  if (!contract || contract.serviceType !== 'supply_install') {
    alert('โ ูุฐุง ููุณ ุนุฑุถ ุชูุฑูุฏ / ุชุฑููุจ / ุชุดุบูู');
    return;
  }

  const w = window.open('', '_blank');

  // =========================
  // ุจูุงูุงุช ุงูุชุญููู ุงูุจููู (RKL) - ุซุงุจุชุฉ
  // =========================
  const bankName   = 'ุงูุจูู ุงูุฃููู ุงูุณุนูุฏู (SNB)';
  const beneficiary = 'ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ';
  const customerNo = '7023357804';
  const accountNo  = '01400005531406';
  const iban       = 'SA1710000001400005531406';

  // =========================
  // ุจูุงูุงุช ุงูุนุฑุถ
  // =========================
  const customer = contract.customer || {};
  const refNo = contract.id || 'โ';
  const projectName = contract.projectName || 'โ';
  const projectLocation = contract.projectLocation || 'โ';
  const execDate = contract.date || (contract.supplyDetails?.date || 'โ');

  const supply = contract.supplyDetails || {};
  const pricing = contract.pricing || {};

  const supplyTypeLabelMap = {
    supply: 'ุชูุฑูุฏ ููุท',
    supply_install: 'ุชูุฑูุฏ + ุชุฑููุจ',
    supply_install_commission: 'ุชูุฑูุฏ + ุชุฑููุจ + ุชุดุบูู',
    commission_only: 'ุชุดุบูู ุจุฏูู ูุทุน ุบูุงุฑ'
  };

  const opModeLabelMap = {
    first_time: 'ุชุดุบูู ูุฃูู ูุฑุฉ',
    reset: 'ุฅุนุงุฏุฉ ุถุจุท / ุฅุนุงุฏุฉ ุจุฑูุฌุฉ'
  };

  const supplyTypeText = supplyTypeLabelMap[supply.type] || 'โ';
  const opModeText = supply.operationMode ? (opModeLabelMap[supply.operationMode] || 'โ') : 'โ';

  const money = (n) => (Number(n || 0)).toFixed(2);

  // ุฅุฌุจุงุฑ ุฃุฑูุงู (ุญุชู ูู ูุงูุช ูุญููุธุฉ ููุต)
  const material = Number(supply.material || 0);
  const labor    = Number(supply.labor || 0);
  const subtotal = Number(pricing.subtotal ?? (material + labor));
  const vat      = Number(pricing.vat ?? (subtotal * 0.15));
  const total    = Number(pricing.total ?? (subtotal + vat));

  // ุฎูุงุฑุงุช ุฅุถุงููุฉ
  const options = [];
  if (supply.type === 'commission_only' && supply.operationMode) {
    options.push(`ููุน ุงูุชุดุบูู: ${opModeText}`);
  }
  if (supply.includeCommissioning) options.push('ูุดูู ุจุฑูุฌุฉ / ุชุดุบูู ุงููุธุงู');
  if (supply.excludeFutureMaintenance) options.push('ูุง ูุดูู ุตูุงูุฉ ูุณุชูุจููุฉ');

  const description = (supply.description || 'โ').trim();
  const lifts = contract.lifts || 'โ';

  w.document.write(`
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ุนุฑุถ ุณุนุฑ ${refNo}</title>

<style>
*{ -webkit-print-color-adjust: exact; print-color-adjust: exact; box-sizing:border-box; }
@page{ size:A4; margin:15mm; }

:root{
  --ink:#111827;
  --muted:#6b7280;
  --line:#e5e7eb;
  --soft:#f8fafc;
  --brand:#0f766e;
}

body{
  margin:0;
  font-family:"Cairo","Tajawal",Arial,sans-serif;
  font-size:14px;
  color:var(--ink);
  background:#fff;
  line-height:1.7;
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  background:url('/public/images/logo.png') center center / 360px no-repeat;
  opacity:0.04;
  z-index:-1;
}

.page{
  outline:1.5px solid var(--brand);
  outline-offset:-8px;
  padding:16px 18px 22px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:2px solid var(--brand);
  padding-bottom:10px;
  gap:12px;
}

.header img{ width:46px; height:auto; }

.header h1{
  margin:0;
  color:var(--brand);
  font-size:18.5px;
  font-weight:900;
  text-align:center;
  flex:1;
}

.small{
  font-size:12px;
  color:var(--muted);
  line-height:1.35;
  text-align:left;
  direction:ltr;
  min-width:190px;
}

.meta{
  margin-top:14px;
  background:var(--soft);
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px 14px;
  font-size:13.5px;
}

.meta-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px 16px;
}

.meta b{ color:var(--brand); }

.section{
  margin-top:14px;
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px 14px;
  background:#fff;
}

.section h3{
  margin:0 0 10px 0;
  color:var(--brand);
  font-size:15px;
  font-weight:900;
  border-bottom:1px solid var(--line);
  padding-bottom:8px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13.5px;
}

th,td{
  border:1px solid var(--line);
  padding:9px 10px;
  vertical-align:top;
}

thead th{
  background:var(--brand);
  color:#fff;
  font-weight:800;
}

tbody tr:nth-child(even){ background:#f9fafb; }

.money{
  text-align:left;
  direction:ltr;
  font-weight:800;
}

.summary{
  background:#f0fdfa;
  border:1px solid #99f6e4;
}

.summary .row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:6px 0;
  border-bottom:1px dashed var(--line);
}
.summary .row:last-child{ border-bottom:none; }
.summary .total{
  font-size:15.5px;
  color:var(--brand);
  font-weight:900;
}

.note{
  color:var(--muted);
  font-size:12.5px;
  margin-top:8px;
}

.footer{
  margin-top:14px;
  text-align:center;
  font-size:11.5px;
  color:var(--muted);
  line-height:1.5;
}

.print-actions{
  margin-top:12px;
  text-align:center;
}

button{
  background:var(--brand);
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
}

@media print{
  .print-actions{ display:none; }
}
</style>
</head>

<body>
  <div class="page">

    <!-- Header -->
    <div class="header">
      <img src="/public/images/logo.png" alt="RKL">
      <h1>ุนุฑุถ ุณุนุฑ ุชูุฑูุฏ ูุชุฑููุจ ูุชุดุบูู ูุทุน ุบูุงุฑ</h1>
      <div class="small">
        RKL Elevators & Escalators<br>
        CR: 1010709355<br>
        VAT: 302250422600003
      </div>
    </div>

    <!-- Meta -->
    <div class="meta">
      <div class="meta-grid">
        <div><b>ุฑูู ุงูุนุฑุถ:</b> ${refNo}</div>
        <div><b>ุชุงุฑูุฎ ุงูุชูููุฐ:</b> ${execDate}</div>

        <div><b>ุงูุนููู:</b> ${(customer.customer_name || customer.name || 'โ')}</div>
        <div><b>ุนุฏุฏ ุงููุตุงุนุฏ:</b> ${lifts}</div>

        <div><b>ุงุณู ุงููุดุฑูุน:</b> ${projectName}</div>
        <div><b>ูููุน ุงููุดุฑูุน:</b> ${projectLocation}</div>

        <div><b>ููุน ุงูุนูู:</b> ${supplyTypeText}</div>
        <div><b>ุญุงูุฉ ุงููุตุนุฏ:</b> ${(supply.stopped === 'yes') ? 'ูุชููู' : 'ุบูุฑ ูุชููู'}</div>
      </div>
    </div>

    <!-- Scope / Description -->
    <div class="section">
      <h3>ูุทุงู ุงูุนูู ููุตู ุงููุทุน</h3>
      <div style="white-space:pre-wrap">${description}</div>

      ${options.length ? `
        <div class="note" style="margin-top:10px">
          <b style="color:var(--brand)">ุฎูุงุฑุงุช ุถูู ุงูุนุฑุถ:</b><br>
          ${options.map(x => `- ${x}`).join('<br>')}
        </div>
      ` : ``}
    </div>

    <!-- Items Table -->
<div class="section">
  <h3>ุงูุชูุงุตูู ุงููุงููุฉ (ุจููุฏ ุงูุนุฑุถ)</h3>

  <table id="itemsTable">
    <thead>
      <tr>
        <th style="width:5%">#</th>
        <th style="width:22%">ุงูุจูุฏ</th>
        <th>ุงููุตู</th>
        <th style="width:14%">ุณุนุฑ ุงููุญุฏุฉ</th>
        <th style="width:10%">ุงููููุฉ</th>
        <th style="width:14%">ุงูุฅุฌูุงูู</th>
        <th style="width:8%">ุฅุฌุฑุงุก</th>
      </tr>
    </thead>

    <tbody id="itemsBody">
      <!-- ุจููุฏ ุงูุชุฑุงุถูุฉ -->
    </tbody>
  </table>

  <div style="margin-top:10px">
    <button type="button" onclick="addItem()">โ ุฅุถุงูุฉ ุจูุฏ</button>
  </div>
</div>



    <!-- Summary -->
    <div class="section summary">
      <h3>ููุฎุต ุงูุฅุฌูุงูู</h3>
      <div class="row"><span>ุงูุฅุฌูุงูู ูุจู ุงูุถุฑูุจุฉ</span><span class="money">${money(subtotal)}</span></div>
      <div class="row"><span>ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (15%)</span><span class="money">${money(vat)}</span></div>
      <div class="row total"><span>ุงูุฅุฌูุงูู ุดุงูู ุงูุถุฑูุจุฉ</span><span class="money">${money(total)}</span></div>

      <div class="note">
        * ุฌููุน ุงูุฃุณุนุงุฑ ุฃุนูุงู ุจุงูุฑูุงู ุงูุณุนูุฏู ูุชุดูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ 15% ุญุณุจ ุงูุฃูุธูุฉ.
      </div>
    </div>

    <!-- Terms -->
    <div class="section">
      <h3>ุงูุดุฑูุท ูุงูุฃุญูุงู</h3>
      <table>
        <tbody>
          <tr>
            <th style="width:28%">ุดุฑูุท ุงูุฏูุน</th>
            <td>ูุจุฏุฃ ุงูุชูููุฐ ุจุนุฏ ุงุนุชูุงุฏ ุงูุนุฑุถ ูุงุณุชูุงู ุงูุชุญููู/ุงูุฏูุนุฉ ูุฅุฑุณุงู ุฅุดุนุงุฑ ุงูุณุฏุงุฏ.</td>
          </tr>
          <tr>
            <th>ูุฏุฉ ุงูุชูููุฐ</th>
            <td>ุญุณุจ ุชููุฑ ุงููุทุน ูุฌุฏููุฉ ุงููุฑูู ุงูููู ุจุงููููุน (ูุชู ุชุฃููุฏูุง ุจุนุฏ ุงูุชุนููุฏ).</td>
          </tr>
          <tr>
            <th>ุงูุถูุงู</th>
            <td>ุถูุงู ุนูู ุงููุทุน ุถุฏ ุนููุจ ุงูุชุตููุน ุญุณุจ ุณูุงุณุฉ ุงูููุฑุฏุ ูุนูู ุฃุนูุงู ุงูุชุฑููุจ ููู ูุทุงู ุงูุนูู.</td>
          </tr>
          <tr>
            <th>ุงูุงุณุชุซูุงุกุงุช</th>
            <td>ูุง ูุดูู ุงูุนุฑุถ ุฃู ุฃุนูุงู ูุฏููุฉ/ุชูุฏูุฏุงุช ููุฑุจุงุฆูุฉ ุฅุถุงููุฉ ุบูุฑ ูุชููุฑุฉ ุจุงููููุนุ ุฅูุง ุจุนุฑุถ ูุณุชูู.</td>
          </tr>
          <tr>
            <th>ุญุฏูุฏ ุงููุณุคูููุฉ</th>
            <td>ูุง ุชุชุญูู ุงููุคุณุณุฉ ุงูุฃุนุทุงู ุงููุงุชุฌุฉ ุนู ุณูุก ุงูุงุณุชุฎุฏุงูุ ุงูุนุจุซุ ุงูุชุญููู ุงูุฒุงุฆุฏุ ุงููุทุงุน ุงูููุฑุจุงุกุ ุฃู ุชุฏุฎู ุฃุทุฑุงู ุบูุฑ ูุนุชูุฏุฉ.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Bank Details -->
    <div class="section">
      <h3>ุจูุงูุงุช ุงูุชุญููู ุงูุจููู</h3>
      <table>
        <tr><th style="width:30%">ุงูุจูู</th><td>${bankName}</td></tr>
        <tr><th>ุงุณู ุงููุณุชููุฏ</th><td>${beneficiary}</td></tr>
        <tr><th>ุฑูู ุงูุนููู</th><td class="money">${customerNo}</td></tr>
        <tr><th>ุฑูู ุงูุญุณุงุจ</th><td class="money">${accountNo}</td></tr>
        <tr><th>ุงูุขูุจุงู</th><td class="money"><b>${iban}</b></td></tr>
      </table>
      <div class="note">
        * ููุฑุฌู ุฅุฑุณุงู ุฅุดุนุงุฑ ุงูุชุญููู ูุน ุฑูู ุงูุนุฑุถ ูุถูุงู ุณุฑุนุฉ ุงูุชูุนูู ูุงูุฌุฏููุฉ.
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      ูุคุณุณุฉ ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ<br>
      ุงูุณุฌู ุงูุชุฌุงุฑู: 1010709355 โ ุงูุฑูู ุงูุถุฑูุจู: 302250422600003<br>
      ุงูุฑูุงุถ โ ุงูุณูููุงููุฉ | ูุงุชู: 0114774021 | ุงูุจุฑูุฏ: admin@rk-lifts.com
    </div>

    <div class="print-actions">
      <button onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ ุนุฑุถ ุงูุณุนุฑ</button>
    </div>

  </div>
</body>
</html>
  `);

  w.document.close();
}




function openPrintView(contract){

  if(!contract || !contract.id){
    alert('ุฎุทุฃ: ุฑูู ุงูุนูุฏ ุบูุฑ ููุฌูุฏ');
    return;
  }

   const serviceType = contract.serviceType || 'annual'; // โ ุฃุถู ูุฐุง
  const w = window.open('', '_blank');
// =========================
// ุจูุงูุงุช ุงูุชุญููู ุงูุจููู (RKL) - ุซุงุจุชุฉ
// =========================
const bankName   = 'ุงูุจูู ุงูุฃููู ุงูุณุนูุฏู (SNB)';
const beneficiary = 'ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ';
const customerNo = '7023357804';
const accountNo  = '01400005531406';
const iban       = 'SA1710000001400005531406';

  w.document.write(`
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>${contract.id}</title>

<style>
/* =========================================================
   RKL Contract Print Styles (A4) โ FINAL (Header + Summary Fix)
========================================================= */

*{ -webkit-print-color-adjust: exact; print-color-adjust: exact; box-sizing:border-box; }

@page{
  size:A4;
  margin:16mm 14mm 22mm 14mm;
}

:root{
  --ink:#111827;
  --muted:#6b7280;
  --line:#e5e7eb;
  --soft:#f8fafc;
  --brand:#0f766e;
  --brand2:#115e59;
}

/* Base */
html,body{ height:100%; }
body{
  margin:0;
  background:#fff;
  color:var(--ink);
  font-family:"Cairo","Tajawal",Arial,sans-serif;
  font-size:14px;
  line-height:1.75;
}

/* Preserve contract newlines + markdown-ish layout */
.ar,.en,.contract{
  white-space:pre-wrap;
  word-break:break-word;
  overflow-wrap:anywhere;
}

/* Hide UI elements */
.editor-toolbar, button{ display:none!important; }

/* Watermark (background only) */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:url('/public/images/logo.png') center center / 340px no-repeat;
  opacity:0.045;
  z-index:-1;
}

/* โ ูุง ูุฎูู ุงูุดุนุงุฑ ูู ุงูุชุฑููุณุฉ */
.print-logo{
  width:44px;
  height:auto;
  display:block;
}

/* Frame */
.page-frame{
  outline:1.5px solid var(--brand);
  outline-offset:-8px;
  padding:18px 20px;
  padding-bottom:32mm;           /* ูุณุงุญุฉ ููููุชุฑ */
  min-height:96vh;
}

/* Header */
.print-header{
  margin:0 0 16px 0;
  padding:0 0 12px 0;
  border-bottom:1px solid var(--line);
}

/* โ ูุฎูู ุชุฑุชูุจ flex ุซุงุจุช ููุฑุงุกุฉ โุดุนุงุฑ - ุนููุงู - ุจูุงูุงุชโ */
.print-header-row{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:14px;
  direction:ltr;                 /* โ ูุญู ูุดููุฉ ุงูููุงุจ ุฃูุงูู ุงูุนูุงุตุฑ */
}

.header-center{
  text-align:center;
  flex:1;
  direction:rtl;                 /* ูุต ุนุฑุจู ุทุจูุนู */
}

.header-center h1{
  margin:0;
  font-size:19px;
  font-weight:900;
  color:var(--brand);
  letter-spacing:.2px;
}

.header-center p{
  margin:4px 0 0 0;
  font-size:11.8px;
  color:var(--muted);
}

/* โ ุจูุงูุงุช ุงูุนูุฏ ุชููู ูููู ุงูุตูุญุฉ ูุจุดูู ูุฑุชุจ */
.header-meta{
  min-width:175px;
  font-size:11.5px;
  color:var(--muted);
  line-height:1.45;
  text-align:right;
  direction:rtl;
}
.header-meta b{ color:var(--ink); font-weight:800; }
.header-meta div{ margin-bottom:6px; }

/* Body */
.contract{ font-size:13.8px; }
.contract p{ margin:6px 0; }

hr{
  border:none;
  border-top:1px solid #cbd5e1;
  margin:18px 0;
}

/* Tables (global) */
table{
  width:100%;
  max-width:100%;
  border-collapse:collapse;
  margin:12px 0;
  font-size:13.4px;
  table-layout:auto;             /* โ ูููุน ุชูุฏุฏ/ุชูุณูุฑ ุบุฑูุจ */
}
td,th{
  border:1px solid var(--line);
  padding:9px 10px;
  vertical-align:top;
}

/* Contract Summary (Financial box) */
.contract-summary{
  background:var(--soft);
  border:1px solid var(--line);
  border-radius:14px;
  padding:16px 18px;
  margin:18px 0 12px;
  overflow:hidden;
  page-break-inside:avoid !important;
  break-inside:avoid !important;
}

.contract-summary h4{
  margin:0 0 12px;
  text-align:center;
  font-size:15px;
  font-weight:900;
  color:var(--brand);
  border-bottom:1px solid var(--line);
  padding-bottom:10px;
}

.contract-summary table,
.contract-summary tr,
.contract-summary td,
.contract-summary th{
  page-break-inside:avoid !important;
  break-inside:avoid !important;
}

.contract-summary .label{ color:var(--muted); }
.contract-summary .value{
  font-weight:800;
  color:var(--ink);
  text-align:left;               /* ุงูุฃุฑูุงู ูุณุงุฑ ุฃูุถู */
  direction:ltr;
}
.contract-summary .total{
  font-size:15px;
  font-weight:900;
  color:var(--brand);
}

/* Language */
.ar{ direction:rtl; text-align:right; }
.en{ direction:ltr; text-align:left; font-family:"Segoe UI",Arial,sans-serif; font-size:13.3px; }

/* Footer */
.print-footer{
  position:fixed;
  bottom:8mm;
  left:0;
  right:0;
  text-align:center;
  font-size:10.5px;
  color:var(--muted);
}

/* Page Break */
.page-break{ break-before:page; margin:0; padding:0; }

/* Signature */
.signature{
  margin-top:34px;
  display:flex;
  justify-content:space-between;
  gap:24px;
  page-break-inside:avoid;
}
.signature div{
  width:48%;
  border-top:1.5px solid var(--ink);
  padding-top:12px;
  text-align:center;
  font-size:13px;
  font-weight:600;
}

/* Print safety */
.contract,.ar,.en{ orphans:3; widows:3; }
</style>




</head>

<body>
<div class="print-footer" data-contract="${contract.id}"></div>

<div class="editor-toolbar">
  <button onclick="format('bold')"><b>B</b></button>
  <button onclick="format('italic')"><i>I</i></button>
  <button onclick="format('underline')"><u>U</u></button>

  <select onchange="format('foreColor', this.value)">
    <option value="">ููู ุงููุต</option>
    <option value="#2563eb">ุฃุฒุฑู</option>
    <option value="#dc2626">ุฃุญูุฑ</option>
    <option value="#16a34a">ุฃุฎุถุฑ</option>
    <option value="#000000">ุฃุณูุฏ</option>
  </select>

  <select onchange="format('fontSize', this.value)">
    <option value="">ุญุฌู ุงูุฎุท</option>
    <option value="3">ุตุบูุฑ</option>
    <option value="4">ุนุงุฏู</option>
    <option value="5">ูุจูุฑ</option>
    <option value="6">ูุจูุฑ ุฌุฏูุง</option>
  </select>
</div>
<div class="page-frame">
  <div id="editableContent" contenteditable="true" class="contract">
<!-- ================== Cover Page ================== -->
<div style="page-break-after:always">


  <div style="text-align:center;margin-top:120px">
    <img src="/public/images/logo.png" style="width:90px;margin-bottom:20px">
    
    <h1 style="font-size:26px;color:#0f766e;margin:0">
      ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ุณููู ูููุตุงุนุฏ
    </h1>

    <div style="width:140px;height:3px;background:#0f766e;margin:20px auto"></div>

    <p style="font-size:15px">
      ุจูู<br>
      <b>ูุคุณุณุฉ ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ</b><br>
      ู<br>
      <b>${contract.customer.customer_name || 'โ'}</b>
    </p>

    <div style="margin-top:40px;font-size:14px">
      <p><b>ุฑูู ุงูุนูุฏ:</b> ${contract.id}</p>
      <p><b>ุชุงุฑูุฎ ุงูุนูุฏ:</b> ${contract.date}</p>
    </div>
  </div>

</div>

<div class="print-header">
  <div class="print-header-row">

  <img src="/public/images/logo.png" class="print-logo" alt="RKL">



    <div class="header-center">
     <h1>${serviceType === 'once' ? 'ุนุฑุถ ุณุนุฑ ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ' : 'ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ุณููู ูููุตุงุนุฏ'}</h1>


      <p>ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ</p>
      <p class="small">ุงูุณุฌู ุงูุชุฌุงุฑู: 1010709355 | ูุงุชู: 0114774021</p>
    </div>

    <div class="header-meta">
      <div><b>ุฑูู ุงูุนูุฏ:</b><br>${contract.id}</div>
      <div><b>ุชุงุฑูุฎ ุงูุนูุฏ:</b><br>${contract.date}</div>
      <div><b>ุงุณู ุงููุดุฑูุน:</b><br>${contract.projectName || 'โ'}</div>
<div><b>ูููุน ุงููุดุฑูุน:</b><br>${contract.projectLocation || 'โ'}</div>

    </div>

  </div>
</div>


${
  contract.lang === 'en'
    ? `<div class="en">${contract.content}</div>`
    : contract.lang === 'ar'
      ? `<div class="ar">${contract.content}</div>`
      : `
        <div class="ar">
          ${contract.content.split('---------------------------------')[0].replace(/\n/g,'<br>')}
        </div>
        <hr>
        <div class="en">
          ${contract.content.split('---------------------------------')[1].replace(/\n/g,'<br>')}
        </div>
      `
}

</div>


<div class="signature">
  <div>ุชูููุน ุงูุทุฑู ุงูุฃูู</div>
  <div>ุชูููุน ุงูุทุฑู ุงูุซุงูู</div>
</div>
</div>
<br>
<button onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ ุงูุนูุฏ</button>



</body>
</html>
  `);

  w.document.close();
}

function openAnnualContractOfferPrint(contract){

  if(!contract || contract.serviceType !== 'annual'){
    alert('โ ูุฐุง ููุณ ุนูุฏ ุตูุงูุฉ ุณููู');
    return;
  }

  const calc     = contract.pricing || {};
  const customer = contract.customer || {};
  const refNo    = contract.id || 'โ';
  const date     = contract.date || 'โ';

  // โ ุจูุงูุงุช ุงููุดุฑูุน
  const projectName     = contract.projectName || 'โ';
  const projectLocation = contract.projectLocation || 'โ';

  // โ ุจูุงูุงุช ุงููุตุงุนุฏ (ุซุงููุงู) โ ูู ุงูุนูุฏ (ุงูุฌุฏูุฏ) ุฃู fallback
  const elevatorType = contract.elevatorType || '';
  const brandSelect  = contract.brandSelect  || '';
  const brandOther   = contract.brandOther   || '';
  const capacityVal  = contract.capacity     || '';
  const floorsVal    = contract.floors       || '';
  const buildingVal  = contract.building     || '';

  const elevatorTypeMap = {
    passenger: 'ุฑูุงุจ',
    service: 'ุฎุฏูุฉ',
    panoramic: 'ุจุงููุฑุงูู'
  };

  const buildingMap = {
    private: 'ุฎุงุต',
    government: 'ุญูููู'
  };

  const capacityMap = {
    "3000":"150 โ 320",
    "3500":"350 โ 550",
    "4000":"600 โ 900",
    "4500":"901 โ 1100",
    "5000":"1101 โ 1500",
    "5500":"1501 โ 1750"
  };

  const brand =
    (brandSelect === 'Other')
      ? (brandOther || 'โ')
      : (brandSelect || 'โ');

  const capacityText = capacityVal ? (capacityMap[String(capacityVal)] || capacityVal) : 'โ';

  // โ ูุทุงู ุงูุตูุงูุฉ (ูู ุงูุนูุฏ ุฅู ููุฌุฏ / ุฃู ูู ุงูุตูุญุฉ ูุฎูุงุฑ ุงุญุชูุงุทู)
  const savedVisits    = contract.visits || null;
  const savedEmergency = contract.emergency || null;
  const savedSpare     = contract.spareParts || null;
  const savedTraining  = contract.training || null;

  const visitsVal =
    savedVisits ||
    (document.getElementById('visits')?.value || 'monthly');

  const emergencyVal =
    savedEmergency ||
    (document.getElementById('emergency')?.value || 'normal');

  const sparePartsVal =
    savedSpare ||
    (document.getElementById('spareParts')?.value || 'excluded');

  const trainingVal =
    savedTraining ||
    (document.getElementById('training')?.value || 'no');

  const visits =
    visitsVal === 'monthly'
      ? '12 ุฒูุงุฑุฉ (ุฒูุงุฑุฉ ุดูุฑูุฉ)'
      : '6 ุฒูุงุฑุงุช (ูู ุดูุฑูู)';

  const emergency =
  emergencyVal === 'extended'
    ? 'ุฎุฏูุฉ ุทูุงุฑุฆ ุฎุงุฑุฌ ุฃููุงุช ุงูุฏูุงู (ุฅุถุงูู)'
    : 'ุฎุฏูุฉ ุทูุงุฑุฆ ุฎูุงู ุฃููุงุช ุงูุฏูุงู 3 ุฒูุงุฑุงุช ูุฌุงููุฉ ุจุงูุณูุฉ';

  const spareParts =
    sparePartsVal === 'included'
      ? 'ูุทุน ุงูุบูุงุฑ ูุดูููุฉ (ุจุนุฑุถ ุฎุงุต)'
      : 'ูุทุน ุงูุบูุงุฑ ุบูุฑ ูุดูููุฉ';

  const training =
    trainingVal === 'yes'
      ? 'ูุดูู ุชุฏุฑูุจ ุฅููุงุฐ ุงููุญุชุฌุฒูู (1โ2 ููุธู)'
      : 'ูุง ูุดูู ุชุฏุฑูุจ';

  // โ ุฃุฑูุงู ูุงููุฉ (ูุฏ ุชููู ูุญููุธุฉ ููุต)
  const money = (n) => (Number(n || 0)).toFixed(2);
  const subtotalNum = Number(calc.subtotal || 0);
  const vatNum      = Number(calc.vat || 0);
  const totalNum    = Number(calc.total || 0);

  // โ ุจูุงูุงุช ุงูุชุญููู ุงูุจููู (RKL) โ ุซุงุจุชุฉ
  const bankName    = 'ุงูุจูู ุงูุฃููู ุงูุณุนูุฏู (SNB)';
  const beneficiary = 'ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ';
  const customerNo  = '7023357804';
  const accountNo   = '01400005531406';
  const iban        = 'SA1710000001400005531406';

  const w = window.open('', '_blank');

  w.document.write(`<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ุนุฑุถ ุณุนุฑ ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ุณููู - ${refNo}</title>

<style>
*{ -webkit-print-color-adjust: exact; print-color-adjust: exact; box-sizing:border-box; }
@page{ size:A4; margin:15mm; }

:root{
  --ink:#111827;
  --muted:#6b7280;
  --line:#e5e7eb;
  --soft:#f8fafc;
  --brand:#0f766e;
}

body{
  margin:0;
  font-family:"Cairo","Tajawal",Arial,sans-serif;
  font-size:14px;
  color:var(--ink);
  background:#fff;
  line-height:1.75;
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  background:url('/public/images/logo.png') center center / 360px no-repeat;
  opacity:0.04;
  z-index:-1;
}

.page{
  outline:1.5px solid var(--brand);
  outline-offset:-8px;
  padding:16px 18px 22px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:2px solid var(--brand);
  padding-bottom:10px;
  gap:12px;
}

.header img{ width:46px; height:auto; }

.header h1{
  margin:0;
  color:var(--brand);
  font-size:18.5px;
  font-weight:900;
  text-align:center;
  flex:1;
}

.meta{
  margin-top:14px;
  background:var(--soft);
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px 14px;
  font-size:13.5px;
}

.meta-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px 16px;
}

.meta b{ color:var(--brand); }

.section{
  margin-top:14px;
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px 14px;
  background:#fff;
}

.section h3{
  margin:0 0 10px 0;
  color:var(--brand);
  font-size:15px;
  font-weight:900;
  border-bottom:1px solid var(--line);
  padding-bottom:8px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13.5px;
}

th,td{
  border:1px solid var(--line);
  padding:9px 10px;
  vertical-align:top;
}

thead th{
  background:var(--brand);
  color:#fff;
  font-weight:800;
}

tbody tr:nth-child(even){ background:#f9fafb; }

.money{
  text-align:left;
  direction:ltr;
  font-weight:800;
}

.summary{
  background:#f0fdfa;
  border:1px solid #99f6e4;
}

.summary .row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:6px 0;
  border-bottom:1px dashed var(--line);
}
.summary .row:last-child{ border-bottom:none; }
.summary .total{
  font-size:15.5px;
  color:var(--brand);
  font-weight:900;
}

.note{
  color:var(--muted);
  font-size:12.5px;
  margin-top:8px;
}

.footer{
  margin-top:14px;
  text-align:center;
  font-size:11.5px;
  color:var(--muted);
  line-height:1.5;
}

.print-actions{
  margin-top:12px;
  text-align:center;
}

button{
  background:var(--brand);
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
}

@media print{
  .print-actions{ display:none; }
}
</style>
</head>

<body>
  <div class="page">

    <div class="header">
      <img src="/public/images/logo.png" alt="RKL">
      <h1>ุนุฑุถ ุณุนุฑ ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ุณููู</h1>
      <div style="width:46px"></div>
    </div>

    <div class="meta">
      <div class="meta-grid">
        <div><b>ุงูุนููู:</b> ${(customer.customer_name || customer.name || 'โ')}</div>
        <div><b>ุฑูู ุงูุนุฑุถ:</b> ${refNo}</div>

        <div><b>ุชุงุฑูุฎ ุงูุนุฑุถ:</b> ${date}</div>
        <div><b>ููุน ุงูุฎุฏูุฉ:</b> ุตูุงูุฉ ููุงุฆูุฉ ุณูููุฉ</div>

        <div><b>ุงุณู ุงููุดุฑูุน:</b> ${projectName}</div>
        <div><b>ูููุน ุงููุดุฑูุน:</b> ${projectLocation}</div>
      </div>
    </div>

    <!-- โ ุซุงููุงู: ุจูุงูุงุช ุงููุตุงุนุฏ (ุชูุตููู) -->
    <div class="section">
      <h3>ุซุงููุงู: ุจูุงูุงุช ุงููุตุงุนุฏ</h3>
      <table>
        <tbody>
          <tr>
            <th style="width:28%">ุนุฏุฏ ุงููุตุงุนุฏ</th>
            <td>${contract.lifts || 'โ'}</td>
            <th style="width:28%">ููุน ุงููุตุนุฏ</th>
            <td>${elevatorType ? (elevatorTypeMap[elevatorType] || elevatorType) : 'โ'}</td>
          </tr>
          <tr>
            <th>ูุงุฑูุฉ ุงููุตุนุฏ</th>
            <td>${brand}</td>
            <th>ุญูููุฉ ุงููุตุนุฏ</th>
            <td>${capacityText}</td>
          </tr>
          <tr>
            <th>ุนุฏุฏ ุงูุทูุงุจู</th>
            <td>${floorsVal || 'โ'}</td>
            <th>ููุน ุงููุจูู</th>
            <td>${buildingVal ? (buildingMap[buildingVal] || buildingVal) : 'โ'}</td>
          </tr>
        </tbody>
      </table>

      <div class="note">* ูู ุญุงู ูุงูุช ุจุนุถ ุงูุญููู ุบูุฑ ูุชููุฑุฉ ุฏุงุฎู ุงูุนููุฏ ุงููุฏููุฉุ ุณูุชู ุนุฑุถ (โ). ุงุญูุธ ุนูุฏ ุฌุฏูุฏ ูุชุธูุฑ ูุงูู ุงูุจูุงูุงุช.</div>
    </div>

    <!-- ูุทุงู ุงูุตูุงูุฉ -->
    <div class="section">
      <h3>ูุทุงู ุงูุตูุงูุฉ ุงููุดูููุฉ</h3>
      <table>
        <tbody>
          <tr><th style="width:30%">ุนุฏุฏ ุงูุฒูุงุฑุงุช</th><td>${visits}</td></tr>
          <tr><th>ุฎุฏูุฉ ุงูุทูุงุฑุฆ</th><td>${emergency}</td></tr>
          <tr><th>ูุทุน ุงูุบูุงุฑ</th><td>${spareParts}</td></tr>
          <tr><th>ุงูุชุฏุฑูุจ</th><td>${training}</td></tr>
        </tbody>
      </table>
    </div>

    <!-- ููุฎุต ูุงูู -->
    <div class="section">
      <h3>ุงูููุฎุต ุงููุงูู</h3>
      <table>
        <thead>
          <tr>
            <th>ุงููููุฉ ูุจู ุงูุถุฑูุจุฉ</th>
            <th>ุถุฑูุจุฉ 15%</th>
            <th>ุงูุฅุฌูุงูู ุดุงูู ุงูุถุฑูุจุฉ</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="money">${money(subtotalNum)} SAR</td>
            <td class="money">${money(vatNum)} SAR</td>
            <td class="money"><b>${money(totalNum)} SAR</b></td>
          </tr>
        </tbody>
      </table>
      <div class="note">* ุฌููุน ุงูุฃุณุนุงุฑ ุจุงูุฑูุงู ุงูุณุนูุฏู ูุชุดูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ 15% ุญุณุจ ุงูุฃูุธูุฉ.</div>
    </div>

    <!-- โ ุทุฑููุฉ ุงูุณุฏุงุฏ ูุงูุชุญููู -->
    <div class="section">
      <h3>ุทุฑููุฉ ุงูุณุฏุงุฏ ูุงูุชุญููู ุงูุจููู</h3>
      <table>
        <tbody>
          <tr><th style="width:30%">ุดุฑูุท ุงูุฏูุน</th><td><b>100% ุฏูุนุฉ ููุฏูุฉ</b> ุนูุฏ ุงุนุชูุงุฏ ุงูุนุฑุถ/ุฅุตุฏุงุฑ ุฃูุฑ ุงูุดุฑุงุกุ ููุจุฏุฃ ุงูุชูููุฐ ูุงูุฌุฏููุฉ ุจุนุฏ ุงุณุชูุงู ุงูุชุญููู ูุฅุดุนุงุฑ ุงูุณุฏุงุฏ.</td></tr>
          <tr><th>ุงูุจูู</th><td>${bankName}</td></tr>
          <tr><th>ุงุณู ุงููุณุชููุฏ</th><td>${beneficiary}</td></tr>
          <tr><th>ุฑูู ุงูุนููู</th><td>${customerNo}</td></tr>
          <tr><th>ุฑูู ุงูุญุณุงุจ</th><td>${accountNo}</td></tr>
          <tr><th>ุงูุขูุจุงู</th><td style="direction:ltr;text-align:left"><b>${iban}</b></td></tr>
        </tbody>
      </table>
    </div>

    <!-- โ ุดุฑูุท ูุฃุญูุงู (ููุณูุนุฉ) -->
    <div class="section">
      <h3>ุงูุดุฑูุท ูุงูุฃุญูุงู</h3>
      <table>
        <tbody>
          <tr>
            <th style="width:30%">ุณุฑูุงู ุงูุนุฑุถ</th>
            <td>ุณุงุฑู ููุฏุฉ (15) ููููุง ูู ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ ูุง ูู ูุชู ุงูุชุนููุฏ ุฎูุงู ุงููุฏุฉ.</td>
          </tr>
          <tr>
            <th>ุจุฏุก ุงูุฎุฏูุฉ</th>
            <td>ุชุจุฏุฃ ุงูุฎุฏูุฉ ุจุนุฏ ุงุนุชูุงุฏ ุงูุนุฑุถ ูุงุณุชูุงู ุงูุฏูุนุฉ ูุฅุตุฏุงุฑ ุฌุฏูู ุงูุฒูุงุฑุงุช ููู ูุทุงู ุงูุนูุฏ.</td>
          </tr>
          <tr>
            <th>ุงุญุชุณุงุจ ุงูุฒูุงุฑุฉ</th>
            <td>ุชูุญุณุจ ุงูุฒูุงุฑุฉ ุถูู ุฌุฏูู ุงูุตูุงูุฉ ุญุชู ูู ุญุงู ูุงู ุงููุตุนุฏ ูุชููููุง ุฃู ุงุญุชุงุฌ ูุทุน ุบูุงุฑ/ุฃุนูุงู ุฅุถุงููุฉ ุบูุฑ ูุดูููุฉ.</td>
          </tr>
          <tr>
            <th>ุงูุงุณุชุซูุงุกุงุช</th>
            <td>ูุง ูุดูู ุงูุนูุฏ ุชูุฑูุฏ ุฃู ุงุณุชุจุฏุงู ูุทุน ุงูุบูุงุฑ ูุฃู ุฃุนูุงู ูุฏููุฉ/ููุฑุจุงุฆูุฉ ุฅุถุงููุฉ ุบูุฑ ูุชููุฑุฉ ุจุงููููุนุ ูุชูุณุนูุฑ ุจุนุฑุถ ูุณุชูู.</td>
          </tr>
          <tr>
            <th>ุญุฏูุฏ ุงููุณุคูููุฉ</th>
            <td>ูุง ุชุชุญูู ุงููุคุณุณุฉ ุงูุฃุนุทุงู ุงููุงุชุฌุฉ ุนู ุณูุก ุงูุงุณุชุฎุฏุงูุ ุงูุนุจุซุ ุงูุชุญููู ุงูุฒุงุฆุฏุ ุงููุทุงุน ุงูููุฑุจุงุกุ ุฃู ุชุฏุฎู ุฃุทุฑุงู ุบูุฑ ูุนุชูุฏุฉ.</td>
          </tr>
          <tr>
            <th>ุงูุชุฒุงูุงุช ุงูุนููู</th>
            <td>ุชูููุฑ ุจูุฆุฉ ุนูู ุขููุฉุ ูุชูููู ูุฑูููุง ูู ุงููุตูู ูุบุฑูุฉ ุงูููุงุฆู/ุงูููุชุฑููุ ูุชูููุฑ ูุตุฏุฑ ููุฑุจุงุก ูุณุชูุฑ ุฃุซูุงุก ุงููุญุต.</td>
          </tr>
          <tr>
            <th>ุงูุถุฑูุจุฉ</th>
            <td>ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ 15% ูุญุชุณุจุฉ ุถูู ุงูุฅุฌูุงูู ุฃุนูุงู ููู ุงูุฃูุธูุฉ ุงููุนููู ุจูุง.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="footer">
      ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ<br>
      ุงูุณุฌู ุงูุชุฌุงุฑู: 1010709355 โ ุงูุฑูู ุงูุถุฑูุจู: 302250422600003<br>
      ุงูุฑูุงุถ โ ุงูุณูููุงููุฉ | ูุงุชู: 0114774021 | ุงูุจุฑูุฏ: admin@rk-lifts.com
    </div>

    <div class="print-actions">
      <button onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ ุนุฑุถ ุงูุณุนุฑ</button>
    </div>

  </div>
</body>
</html>`);

  w.document.close();
}



  
function getBrandValue(){
  const brandSelect = document.getElementById('brandSelect').value;
  const brandOther  = document.getElementById('brandOther')?.value || '';

  if (brandSelect === 'Local') return 'local';
  if (brandSelect === 'Other') return brandOther.trim().toLowerCase() || 'other';

  return brandSelect.toLowerCase();
}

function renderContractsTable(){
  const annualTbody = document.getElementById('annualContractsTable');
  const onceTbody   = document.getElementById('onceVisitsTable');
  const supplyTbody = document.getElementById('supplyInstallTable'); // โ ุฌุฏูุฏ

  if (!annualTbody || !onceTbody) return;
  // supplyTbody ุงุฎุชูุงุฑู (ูู ูุง ุฃุถูุชู ูุง ูููู)
  
  const items = JSON.parse(localStorage.getItem('rkl_maintenance_contracts') || '[]');

  annualTbody.innerHTML = '';
  onceTbody.innerHTML   = '';
  if(supplyTbody) supplyTbody.innerHTML = '';

  let annualIndex = 0;
  let onceIndex   = 0;
  let supplyIndex = 0;

  items.forEach((c, i) => {

    // =======================
    // ุงุณู ุงูุนููู (ูุฏุนู Object ุฃู ูุต ูุฏูู)
    // =======================
    let customerName = 'โ';
    let customerCity = '';
    if (typeof c.customer === 'object' && c.customer !== null) {
      customerName = c.customer.customer_name || c.customer.name || 'โ';
      customerCity = c.customer.city ? ` - ${c.customer.city}` : '';
    } else if (typeof c.customer === 'string') {
      customerName = c.customer;
    }

    const serviceType = c.serviceType || 'annual';

    // =========================================================
    // (ุฃ) ุงูุนููุฏ ุงูุณูููุฉ (annual + content = ุนูุฏ ูุนูู)
    // =========================================================
    if(serviceType === 'annual' && c.content){
      annualIndex++;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${annualIndex}</td>
        <td>${c.id || 'โ'}</td>
        <td>
          <strong>${customerName}</strong>
          <div style="font-size:12px;color:#6b7280">${customerCity}</div>
        </td>
        <td>${c.lifts || 'โ'}</td>
        <td>${c.total || 'โ'}</td>
        <td>${c.lang || 'โ'}</td>
        <td>${c.date || 'โ'}</td>
        <td>
          <button type="button" class="print-annual" data-index="${i}">
            ุทุจุงุนุฉ ุงูุนูุฏ
          </button>

          <button type="button" class="print-annual-offer" data-index="${i}">
            ๐จ๏ธ ุทุจุงุนุฉ ุนุฑุถ ุณุนุฑ ุงูุนูุฏ
          </button>
        </td>
      `;
      annualTbody.appendChild(row);
      return;
    }

    // =========================================================
    // (ุจ) ุงูุฒูุงุฑุงุช ููุฑุฉ ูุงุญุฏุฉ
    // =========================================================
    if(serviceType === 'once'){
      onceIndex++;

      const vt = c.onceDetails?.visitType || 'โ';
      const vtLabel =
        vt === 'inspection' ? 'ูุญุต ูุชุดุฎูุต' :
        vt === 'repair'     ? 'ุตูุงูุฉ/ุฅุตูุงุญ' :
        vt === 'rescue'     ? 'ุงุญุชุฌุงุฒ/ุฅููุงุฐ' : 'โ';

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${onceIndex}</td>
        <td>${c.id || 'โ'}</td>
        <td>
          <strong>${customerName}</strong>
          <div style="font-size:12px;color:#6b7280">${customerCity}</div>
        </td>
        <td>${c.lifts || 'โ'}</td>
        <td>${c.total || 'โ'}</td>
        <td>${c.date || 'โ'}</td>
        <td>${vtLabel}</td>
        <td>
          <button type="button" class="print-once-offer" data-index="${i}">
            ๐จ๏ธ ุทุจุงุนุฉ ุนุฑุถ ุงูุณุนุฑ ุฒูุงุฑู
          </button>

          <button type="button" class="print-once-report" data-index="${i}">
            ๐งพ ุทุจุงุนุฉ ุงูุชูุฑูุฑ ุฒูุงุฑู
          </button>
        </td>
      `;
      onceTbody.appendChild(row);
      return;
    }

    // =========================================================
    // (ุฌ) ุชูุฑูุฏ + ุชุฑููุจ + ุชุดุบูู ูุทุน ุบูุงุฑ
    // =========================================================
    if(serviceType === 'supply_install'){
      if(!supplyTbody) return; // ูู ุฌุฏูู (ุฌ) ุบูุฑ ููุฌูุฏ ุจุงูู HTML

      supplyIndex++;

      const supplyType = c.supplyDetails?.type || 'โ';
      const supplyTypeLabel =
        supplyType === 'supply'                   ? 'ุชูุฑูุฏ ููุท' :
        supplyType === 'supply_install'           ? 'ุชูุฑูุฏ + ุชุฑููุจ' :
        supplyType === 'supply_install_commission'? 'ุชูุฑูุฏ + ุชุฑููุจ + ุชุดุบูู' :
        supplyType === 'commission_only'          ? 'ุชุดุบูู ุจุฏูู ูุทุน ุบูุงุฑ' : 'โ';

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${supplyIndex}</td>
        <td>${c.id || 'โ'}</td>
        <td>
          <strong>${customerName}</strong>
          <div style="font-size:12px;color:#6b7280">${customerCity}</div>
        </td>
        <td>${c.projectName || 'โ'}</td>
        <td>${supplyTypeLabel}</td>
        <td>${c.total || 'โ'}</td>
        <td>${c.date || 'โ'}</td>
        <td>
          <button type="button" class="print-supply-offer" data-index="${i}">
            ๐จ๏ธ ุทุจุงุนุฉ ุนุฑุถ ุงูุณุนุฑ (ุชูุฑูุฏ/ุชุฑููุจ/ุชุดุบูู)
          </button>
        </td>
      `;
      supplyTbody.appendChild(row);
      return;
    }

    // ุบูุฑ ุฐูู: ุจูุงูุงุช ูุฏููุฉ/ุบูุฑ ูุนุฑููุฉ โ ุชุฌุงูู
  });

  // =========================
  // ุฑุจุท ุฃุฒุฑุงุฑ ุงูุทุจุงุนุฉ
  // =========================

  // (ุฃ) ุทุจุงุนุฉ ุงูุนูุฏ ุงูุณููู
  document.querySelectorAll('.print-annual').forEach(btn => {
    btn.onclick = function(){
      const idx = Number(this.getAttribute('data-index'));
      openPrintView(items[idx]);
    };
  });

  // (ุฃ) ุทุจุงุนุฉ ุนุฑุถ ุณุนุฑ ุงูุนูุฏ ุงูุณููู
  document.querySelectorAll('.print-annual-offer').forEach(btn => {
    btn.onclick = function(){
      const idx = Number(this.getAttribute('data-index'));
      openAnnualContractOfferPrint(items[idx]);
    };
  });

  // (ุจ) ุนุฑุถ ุณุนุฑ ุงูุฒูุงุฑุฉ
  document.querySelectorAll('.print-once-offer').forEach(btn => {
    btn.onclick = function(){
      const idx = Number(this.getAttribute('data-index'));
      openOnceVisitOfferPrint(items[idx]);
    };
  });

  // (ุจ) ุชูุฑูุฑ ุงูุฒูุงุฑุฉ
  document.querySelectorAll('.print-once-report').forEach(btn => {
    btn.onclick = function(){
      const idx = Number(this.getAttribute('data-index'));
      openOnceVisitReportPrint(items[idx]);
    };
  });

  // (ุฌ) ุทุจุงุนุฉ ุนุฑุถ ุณุนุฑ ุงูุชูุฑูุฏ/ุงูุชุฑููุจ/ุงูุชุดุบูู
  document.querySelectorAll('.print-supply-offer').forEach(btn => {
    btn.onclick = function(){
      const idx = Number(this.getAttribute('data-index'));
      openSupplyOfferPrint(items[idx]); // โ ูุงุฒู ุชููู ุงูุฏุงูุฉ ููุฌูุฏุฉ ุนูุฏู
    };
  });
}

document.addEventListener('DOMContentLoaded', renderContractsTable);



function reviewContract(){
  const required=['lang','contractDate','lifts','capacity','floors'];
  for(const id of required){
    if(!document.getElementById(id).value){
      alert('ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู ุงูุฅูุฒุงููุฉ');
      return;
    }
  }

  let price=Number(document.getElementById('capacity').value);
  const lifts=Number(document.getElementById('lifts').value);
  const floors=Number(document.getElementById('floors').value);
  const building=document.getElementById('building').value;
  const brandSelect = document.getElementById('brandSelect').value || '';
const brandOther  = document.getElementById('brandOther')?.value || '';
const brand = (brandSelect === 'Other' || brandSelect === 'Local')
  ? brandOther.toLowerCase()
  : brandSelect.toLowerCase();


  if(floors>2) price*=1.10;
  if(building==='government') price*=1.50;
  if(['otis','kone','wittur','mitsubishi','schindler'].some(b=>brand.includes(b))){
    price+=2000;
  }

  const vat=price*lifts*0.15;
  const total=price*lifts+vat;
  const calc = calculateTotal();


  document.getElementById('reviewBox').innerHTML=`
    <p><b>ุนุฏุฏ ุงููุตุงุนุฏ:</b> ${lifts}</p>
    <p><b>ูููุน ุงููุดุฑูุน:</b> ${calc.zone}</p>
    <p><b>ุงูุณุนุฑ ุงูุณููู ูููุตุนุฏ:</b> ${price.toFixed(2)} ุฑูุงู</p>
    <p><b>ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ 15%:</b> ${vat.toFixed(2)} ุฑูุงู</p>
    <p><b>ุฅุฌูุงูู ูููุฉ ุงูุนูุฏ:</b> <strong>${total.toFixed(2)} ุฑูุงู</strong></p>
    <p><b>ููุงุญุธุงุช:</b> ${document.getElementById('notes').value||'โ'}</p>
  `;

  document.getElementById('reviewSection').style.display='block';
}
</script>

  <script>
function toggleOtherBrand(){
  const select = document.getElementById('brandSelect').value;
  document.getElementById('otherBrandBox').style.display =
    (select === 'Other') ? 'block' : 'none';
}

    function numberToArabicWords(num){
  return num.toLocaleString('ar-SA');
}

</script>
<script>
window.manualPricePerLift = null; // ุณุนุฑ ูุฏูู ูููุตุนุฏ (ูุจู ุงูุฎุตููุงุช ูุงูููุทูุฉ ุฅูุฎ)
window.finalCalcOverride = null;  // ูุชูุฌุฉ ุญุณุงุจ ููุงุฆูุฉ ุจุนุฏ ุชุนุฏูู ุงููุณุชุฎุฏู (ููุงุณุชุฎุฏุงู ุจุงูุญูุธ)
</script>

<script>
/* ====== ุฃุฏูุงุช ุตุบูุฑุฉ ====== */
function fmt(n){
  return (Number(n || 0)).toFixed(2);
}
function esc(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

/* =========================================================
   ุชูุฑูุฑ ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ (ูุงุจู ููุชุนุฏูู ุฏุงุฎู ูุงูุฐุฉ ุงูุทุจุงุนุฉ)
   โ ูุณุฎุฉ ุตุญูุญุฉ 100% (ุจุฏูู <script> ุฏุงุฎู document.write)
========================================================= */
function openOnceVisitReportPrint(visit){
  try{
    if(!visit || visit.serviceType !== 'once'){
      alert('โ ูุฐุง ููุณ ุณุฌู ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ');
      return;
    }

    const customer = visit.customer || {};
    const refNo = visit.id || 'โ';
    const date  = visit.date || 'โ';
    const d = visit.onceDetails || {};
    const calc = visit.pricing || {};

    const vt = d.visitType || '';
    const vtLabel =
      vt === 'inspection' ? 'ูุญุต ูุชุดุฎูุต' :
      vt === 'repair'     ? 'ุตูุงูุฉ/ุฅุตูุงุญ' :
      vt === 'rescue'     ? 'ุงุญุชุฌุงุฒ/ุฅููุงุฐ' : 'โ';

    const urgencyLabel = (d.urgency === 'urgent') ? 'ูุณุชุนุฌู' : 'ุนุงุฏู';
    const stoppedLabel = (d.stopped === 'yes') ? 'ูุนู (ุชููู ูุงูู)' : 'ูุง';

    const subtotal = Number(calc.subtotal || 0);
    const vat      = Number(calc.vat || 0);
    const total    = Number(calc.total || 0);
    const hasFinancial = total > 0;

    const issue = esc(d.issue || 'โ');

    // ุญูุธ ุงูุชุนุฏูู ููู ุฒูุงุฑุฉ
    const LS_KEY = `rkl_once_visit_report_edit_${refNo}`;

    const w = window.open('', '_blank');
    if(!w){
      alert('โ๏ธ ุงููุชุตูุญ ููุน ูุชุญ ูุงูุฐุฉ ุฌุฏูุฏุฉ (Popup). ูุนูู ุงูุณูุงุญ ุซู ุฌุฑูุจ ูุฑุฉ ุฃุฎุฑู.');
      return;
    }

    // HTML (ุจุฏูู ุฃู <script> ุฏุงุฎูู)
    const html = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ุชูุฑูุฑ ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ - ${esc(refNo)}</title>

<style>
@page{ size:A4; margin:15mm; }
*{ -webkit-print-color-adjust: exact; print-color-adjust: exact; box-sizing:border-box; }
:root{
  --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --soft:#f8fafc;
  --brand:#0f766e; --brand2:#115e59;
}
body{ font-family:"Cairo","Tajawal",Arial,sans-serif; font-size:14px; color:var(--ink); line-height:1.75; margin:0; }
body::before{
  content:""; position:fixed; inset:0;
  background:url('/public/images/logo.png') center center / 340px no-repeat;
  opacity:0.045; z-index:-1;
}
.frame{ border:1.5px solid var(--brand); border-radius:14px; padding:14px 16px; }
.header{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding-bottom:10px; border-bottom:2px solid var(--line);
}
.logo{ width:44px; height:auto; }
.center{ text-align:center; flex:1; }
.center h1{ margin:0; color:var(--brand2); font-size:18px; font-weight:900; }
.center p{ margin:4px 0 0; color:var(--muted); font-size:11.5px; }
.meta{ min-width:170px; font-size:12px; color:var(--muted); line-height:1.6; text-align:right; }
.meta b{ color:var(--ink); }

.section{ margin-top:14px; }
.section h3{
  margin:0 0 8px 0; color:var(--brand2); font-size:14px; font-weight:900;
  border-bottom:1px solid var(--line); padding-bottom:6px;
}
table{ width:100%; border-collapse:collapse; font-size:13px; }
th,td{ border:1px solid var(--line); padding:8px 10px; vertical-align:top; }
th{ background:var(--soft); width:35%; }

.note{ background:#fff; border:1px dashed var(--line); border-radius:12px; padding:10px 12px; color:#374151; }

.toolbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
.toolbar button{
  background:var(--brand); color:#fff; border:none; padding:9px 12px;
  border-radius:10px; font-size:13px; font-weight:800; cursor:pointer;
}
.toolbar button.secondary{ background:#334155; }
.toolbar .hint{ font-size:12px; color:var(--muted); align-self:center; margin-right:auto; }
.editable{ outline:2px dashed rgba(15,118,110,0.25); outline-offset:6px; border-radius:12px; }

@media print{
  .toolbar{ display:none !important; }
  .editable{ outline:none !important; }
}
</style>
</head>

<body>
<div class="frame">

  <div class="header">
    <img src="/public/images/logo.png" class="logo" alt="RKL">
    <div class="center">
      <h1>ุชูุฑูุฑ ุฒูุงุฑุฉ ููุฑุฉ ูุงุญุฏุฉ</h1>
      <p>ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ</p>
      <p>ุงูุณุฌู ุงูุชุฌุงุฑู: 1010709355 | ุงูุฑูู ุงูุถุฑูุจู: 302250422600003 | ูุงุชู: 0114774021</p>
    </div>
    <div class="meta">
      <div><b>ุฑูู ุงููุฑุฌุน:</b> ${esc(refNo)}</div>
      <div><b>ุชุงุฑูุฎ ุงูุฒูุงุฑุฉ:</b> ${esc(date)}</div>
    </div>
  </div>

  <div class="section">
    <h3>ุฃููุงู: ุจูุงูุงุช ุงูุนููู</h3>
    <table>
      <tr><th>ุงุณู ุงูุนููู</th><td>${esc(customer.customer_name || customer.name || 'โ')}</td></tr>
      <tr><th>ุงูุฌูุงู</th><td>${esc(customer.mobile || customer.phone || 'โ')}</td></tr>
      <tr><th>ุงููุฏููุฉ</th><td>${esc(customer.city || 'โ')}</td></tr>
      <tr><th>ุงูุนููุงู</th><td>${esc(customer.full_address || customer.address || 'โ')}</td></tr>
    </table>
  </div>

  <div class="section">
    <h3>ุซุงููุงู: ุชูุงุตูู ุงูุฒูุงุฑุฉ</h3>
    <table>
      <tr><th>ููุน ุงูุฒูุงุฑุฉ</th><td>${esc(vtLabel)}</td></tr>
      <tr><th>ุงูุฃููููุฉ</th><td>${esc(urgencyLabel)}</td></tr>
      <tr><th>ูู ููุฌุฏ ุชููู ูุงููุ</th><td>${esc(stoppedLabel)}</td></tr>
      <tr><th>ูุตู ุงููุดููุฉ / ุงููุทููุจ</th><td>${issue}</td></tr>
    </table>
  </div>

  <!-- โ ููุทูุฉ ูุงุจูุฉ ููุชุนุฏูู -->
  <div id="editableReport" class="editable" contenteditable="true">

    <div class="section">
      <h3>ุซุงูุซุงู: ูุชุงุฆุฌ ุงูุฒูุงุฑุฉ (ููุณุชููู ุฃุซูุงุก ุงูุชูููุฐ)</h3>
      <div class="note">โ</div>
    </div>

    <div class="section">
      <h3>ุฑุงุจุนุงู: ุงูุชูุตูุงุช ูุงููุชุทูุจุงุช</h3>
      <div class="note">โ</div>
    </div>

    <div class="section">
      <h3>ุฎุงูุณุงู: ููุฎุต ูุงูู (ุฅู ููุฌุฏ ูู ุงูุณุฌู)</h3>
      ${
        hasFinancial
          ? `<table>
              <tr><th>ุงููููุฉ ูุจู ุงูุถุฑูุจุฉ</th><td>${fmt(subtotal)} ุฑูุงู</td></tr>
              <tr><th>ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ 15%</th><td>${fmt(vat)} ุฑูุงู</td></tr>
              <tr><th><b>ุงูุฅุฌูุงูู ุดุงูู ุงูุถุฑูุจุฉ</b></th><td><b>${fmt(total)} ุฑูุงู</b></td></tr>
            </table>
            <div class="note" style="margin-top:8px"><b>ููุงุญุธุฉ:</b> ูุฐุง ุงูููุฎุต ุฎุงุต ุจุฑุณูู ุงูุฒูุงุฑุฉ ููุท.</div>`
          : `<div class="note">ูุง ููุฌุฏ ููุฎุต ูุงูู ูุญููุธ ููุฐู ุงูุฒูุงุฑุฉ ุฏุงุฎู ุงูุณุฌู. ููููู ูุชุงุจุฉ ุงูููุฎุต ููุง ุฅู ูุฒู.</div>`
      }
    </div>

  </div>

  <div class="toolbar">
    <button id="btnSaveEdits">๐พ ุญูุธ ุงูุชุนุฏูู</button>
    <button class="secondary" id="btnLoadEdits">โฉ๏ธ ุงุณุชุฑุฌุงุน ุขุฎุฑ ุชุนุฏูู</button>
    <button class="secondary" id="btnPrint">๐งพ ุทุจุงุนุฉ ุงูุชูุฑูุฑ</button>
    <span class="hint">ุงูุฃูุณุงู ุฏุงุฎู ุงูุฅุทุงุฑ ุงููุชูุทุน ูุงุจูุฉ ููุชุนุฏูู ูุณูุชู ุญูุธูุง ููุฐู ุงูุฒูุงุฑุฉ ููุท.</span>
  </div>

</div>
</body>
</html>`;

    // ุงูุชุจ ุงููุญุชูู ุซู ุงุบูู
    w.document.open();
    w.document.write(html);
    w.document.close();

    // โ ุงุฑุจุท ุงูุฃุฒุฑุงุฑ ูู ูุงูุฐุฉ ุงูุทุจุงุนุฉ (ุจุฏูู <script> ุฏุงุฎู ุงูู HTML)
    w.onload = () => {
      try{
        const editable = w.document.getElementById('editableReport');

        // ุชุญููู ุชููุงุฆู ุฅู ูุฌุฏ
        const saved = localStorage.getItem(LS_KEY);
        if(saved) editable.innerHTML = saved;

        // ุญูุธ
        w.document.getElementById('btnSaveEdits').onclick = () => {
          localStorage.setItem(LS_KEY, editable.innerHTML);
          w.alert('โ ุชู ุญูุธ ุงูุชุนุฏูู ููุฐู ุงูุฒูุงุฑุฉ');
        };

        // ุงุณุชุฑุฌุงุน
        w.document.getElementById('btnLoadEdits').onclick = () => {
          const s = localStorage.getItem(LS_KEY);
          if(!s) return w.alert('ูุง ููุฌุฏ ุชุนุฏูู ูุญููุธ ุณุงุจููุง');
          editable.innerHTML = s;
          w.alert('โ ุชู ุงุณุชุฑุฌุงุน ุขุฎุฑ ุชุนุฏูู');
        };

        // ุทุจุงุนุฉ
        w.document.getElementById('btnPrint').onclick = () => {
          localStorage.setItem(LS_KEY, editable.innerHTML);
          w.print();
        };

      }catch(e){
        console.error(e);
        alert('โ ุฎุทุฃ ุฏุงุฎู ูุงูุฐุฉ ุงูุชูุฑูุฑ: ' + e.message);
      }
    };

  }catch(err){
    console.error(err);
    alert('โ ุฎุทุฃ ูู ุทุจุงุนุฉ ุงูุชูุฑูุฑ: ' + err.message);
  }
}
</script>


<script>
function toggleServiceType(){
  const type = document.getElementById('serviceType').value;

  document.getElementById('annualBox').style.display = 'none';
  document.getElementById('onceBox').style.display = 'none';
  document.getElementById('supplyInstallBox').style.display = 'none';

  if(type === 'annual'){
    document.getElementById('annualBox').style.display = 'block';
  }

  if(type === 'once'){
    document.getElementById('onceBox').style.display = 'block';
  }

  if(type === 'supply_install'){
    document.getElementById('supplyInstallBox').style.display = 'block';
  }
}


document.addEventListener('DOMContentLoaded', () => {
  toggleServiceType();
});

  </script>
<script>
  
function esc(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

function printOfferFromPreview(){

  const serviceType = document.getElementById('serviceType')?.value || 'annual';

  const calc = window.finalCalcOverride || calculateTotal();
  if(!calc || !calc.total){
    alert('โ๏ธ ุงุนุฑุถ ุงูุญุณุจุฉ ุฃููุงู ุซู ุงุทุจุน ุนุฑุถ ุงูุณุนุฑ');
    return;
  }
  if(!customer){
    alert('โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุงูุนููู ุฃููุงู');
    return;
  }

  const lifts = Number(document.getElementById('lifts').value || 0);
  const building = document.getElementById('building').value === 'government' ? 'ุญูููู' : 'ุฎุงุต';
  const elevatorType = document.getElementById('elevatorType').value || 'โ';

  const brandSelect = document.getElementById('brandSelect').value || '';
  const brandOther  = document.getElementById('brandOther')?.value || '';
  const brand = (brandSelect === 'Other') ? (brandOther || 'โ') : (brandSelect || 'โ');

  // โ ุงูุชุงุฑูุฎ ูุฎุชูู ุญุณุจ ุงูููุน
  const date = (serviceType === 'once')
    ? (document.getElementById('onceDate').value || '')
    : (document.getElementById('contractDate').value || '');

  // โ ูุญุชูู ุงูุฎุฏูุฉ ูุฎุชูู ุญุณุจ ุงูููุน
  let serviceHtml = '';
  if(serviceType === 'annual'){
    const visits = document.getElementById('visits').value === 'monthly' ? 'ุฒูุงุฑุฉ ุดูุฑูุฉ (12 ุฒูุงุฑุฉ)' : 'ุฒูุงุฑุฉ ูู ุดูุฑูู (6 ุฒูุงุฑุงุช)';
    const emergency = document.getElementById('emergency').value === 'extended' ? 'ุฎุงุฑุฌ ุงูุฏูุงู (ุฅุถุงูู)' : 'ุฃููุงุช ุงูุฏูุงู';
    const spareParts = document.getElementById('spareParts').value === 'included' ? 'ูุดูููุฉ (ุจุนุฑุถ ุฎุงุต)' : 'ุบูุฑ ูุดูููุฉ';
    const training = document.getElementById('training').value === 'yes' ? 'ูุนู' : 'ูุง';
    const notes = document.getElementById('notes').value || 'โ';

    serviceHtml = `
      <div class="grid">
        <div class="kv"><span class="k">ุนุฏุฏ ุงููุตุงุนุฏ</span><span class="v">${lifts}</span></div>
        <div class="kv"><span class="k">ููุน ุงููุจูู</span><span class="v">${esc(building)}</span></div>
        <div class="kv"><span class="k">ููุน ุงููุตุนุฏ</span><span class="v">${esc(elevatorType)}</span></div>
        <div class="kv"><span class="k">ุงููุงุฑูุฉ</span><span class="v">${esc(brand)}</span></div>
        <div class="kv"><span class="k">ุนุฏุฏ ุงูุฒูุงุฑุงุช</span><span class="v">${esc(visits)}</span></div>
        <div class="kv"><span class="k">ุฎุฏูุฉ ุงูุทูุงุฑุฆ</span><span class="v">${esc(emergency)}</span></div>
        <div class="kv"><span class="k">ุชุฏุฑูุจ ุฅููุงุฐ ูุญุชุฌุฒูู</span><span class="v">${esc(training)}</span></div>
        <div class="kv"><span class="k">ูุทุน ุงูุบูุงุฑ</span><span class="v">${esc(spareParts)}</span></div>
      </div>
      <div style="margin-top:8px;color:#374151"><b>ููุงุญุธุงุช:</b> ${esc(notes)}</div>
    `;
  } else {
    const vt = document.getElementById('onceVisitType').selectedOptions[0]?.textContent || 'โ';
    const urgency = document.getElementById('onceUrgency').value === 'urgent' ? 'ูุณุชุนุฌู' : 'ุนุงุฏู';
    const stopped = document.getElementById('onceStopped').value === 'yes' ? 'ูุนู' : 'ูุง';
    const issue = document.getElementById('onceIssue').value || 'โ';

    serviceHtml = `
      <div class="grid">
        <div class="kv"><span class="k">ููุน ุงูุฒูุงุฑุฉ</span><span class="v">${esc(vt)}</span></div>
        <div class="kv"><span class="k">ุชุงุฑูุฎ ุงูุฒูุงุฑุฉ</span><span class="v">${esc(date)}</span></div>
        <div class="kv"><span class="k">ุงูุฃููููุฉ</span><span class="v">${esc(urgency)}</span></div>
        <div class="kv"><span class="k">ุชููู ูุงูู</span><span class="v">${esc(stopped)}</span></div>

        <div class="kv"><span class="k">ุนุฏุฏ ุงููุตุงุนุฏ</span><span class="v">${lifts}</span></div>
        <div class="kv"><span class="k">ููุน ุงููุจูู</span><span class="v">${esc(building)}</span></div>
        <div class="kv"><span class="k">ููุน ุงููุตุนุฏ</span><span class="v">${esc(elevatorType)}</span></div>
        <div class="kv"><span class="k">ุงููุงุฑูุฉ</span><span class="v">${esc(brand)}</span></div>
      </div>

      <div style="margin-top:10px;color:#374151">
        <b>ูุตู ุงููุดููุฉ/ุงููุทููุจ:</b><br>${esc(issue)}
      </div>
    `;
  }

  const offerId = 'Q-' + Date.now();
  const w = window.open('', '_blank');
function toggleOperationMode(){
  const type = document.getElementById('supplyType')?.value;
  const box  = document.getElementById('operationModeBox');

  if(type === 'commission_only'){
    box.style.display = 'block';
  } else {
    box.style.display = 'none';
    document.getElementById('operationMode').value = '';
  }
}

</script>

<script>
let itemIndex = 0;

function addItem(data = {}) {
  itemIndex++;

  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${itemIndex}</td>

    <td>
      <input type="text" value="${data.name || ''}" placeholder="ูุซุงู: ุชูุฑูุฏ ูุทุน ุบูุงุฑ">
    </td>

    <td>
      <input type="text" value="${data.desc || ''}" placeholder="ูุตู ุงูุจูุฏ">
    </td>

    <td>
      <input type="number" value="${data.price || 0}" min="0" oninput="updateRow(this)">
    </td>

    <td>
      <input type="number" value="${data.qty || 1}" min="1" oninput="updateRow(this)">
    </td>

    <td class="money">0.00</td>

    <td>
      <button type="button" onclick="removeItem(this)" style="background:#dc2626">โ</button>
    </td>
  `;

  document.getElementById('itemsBody').appendChild(row);
  recalcAll();
}

function removeItem(btn) {
  btn.closest('tr').remove();
  recalcAll();
}

function updateRow(el) {
  const row = el.closest('tr');
  const price = Number(row.children[3].querySelector('input').value || 0);
  const qty   = Number(row.children[4].querySelector('input').value || 0);

  row.children[5].innerText = (price * qty).toFixed(2);
  recalcAll();
}

function recalcAll() {
  let subtotal = 0;

  document.querySelectorAll('#itemsBody tr').forEach(row => {
    subtotal += Number(row.children[5].innerText || 0);
  });

  const vat = subtotal * 0.15;
  const total = subtotal + vat;

  // ุงุณุชุฎุฏู ููุณ ูุชุบูุฑุงุชู ุงูุญุงููุฉ
  window.finalCalcOverride = {
    subtotal,
    vat,
    total,
    isManual: true
  };
}
</script>

</body>
</html>
