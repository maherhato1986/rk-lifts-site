<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ูููุตุงุนุฏ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Cairo,Arial;background:#f3f4f6;margin:0}
.container{max-width:1200px;margin:20px auto;background:#fff;padding:30px}
h2,h3{margin-top:0}
.section{margin-bottom:35px;border-bottom:1px dashed #e5e7eb;padding-bottom:25px}
label{font-weight:600;font-size:14px}
input,select,textarea{
  width:100%;padding:8px;margin-top:6px;
  border:1px solid #d1d5db;border-radius:8px
}
textarea{min-height:70px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px}
button{
  background:#059669;color:#fff;border:none;
  padding:10px 22px;border-radius:8px;
  cursor:pointer;font-size:14px
}
button.secondary{background:#6b7280}
button:disabled{background:#9ca3af;cursor:not-allowed}
.review-box{background:#f9fafb;padding:25px;border-radius:10px}
.en{direction:ltr;font-family:Arial}
@media print{
  body{background:#fff}
  .no-print{display:none}
}
</style>
</head>

<body>
<div class="container">

<h2>ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ูููุตุงุนุฏ</h2>

<!-- ================== ุจูุงูุงุช ุงูุนููู ================== -->
<div class="section">
<h3>ุฃููุงู: ุจูุงูุงุช ุงูุนููู</h3>
<div id="customerInfo"></div>
</div>

<!-- ================== ุฅุนุฏุงุฏุงุช ุนุงูุฉ ================== -->
<div class="section">
<h3>ุซุงููุงู: ุฅุนุฏุงุฏุงุช ุงูุนูุฏ</h3>

<div class="grid">
  <div>
    <label>ูุบุฉ ุงูุนูุฏ</label>
    <select id="lang">
      <option value="">-- ุงุฎุชุฑ --</option>
      <option value="ar">ุนุฑุจู</option>
      <option value="en">English</option>
      <option value="both">ุนุฑุจู + English</option>
    </select>
  </div>

  <div>
    <label>ุชุงุฑูุฎ ุงูุนูุฏ</label>
    <input id="contractDate" type="date">
  </div>

  <div>
    <label>ูุฏุฉ ุงูุนูุฏ</label>
    <select id="duration">
      <option value="1">ุณูุฉ ูุงุญุฏุฉ</option>
    </select>
  </div>

  <div>
    <label>ุชุฌุฏูุฏ ุชููุงุฆู</label>
    <select id="renewal">
      <option value="yes">ูุนู</option>
      <option value="no">ูุง</option>
    </select>
  </div>
</div>
</div>

<!-- ================== ุจูุงูุงุช ุงููุตุงุนุฏ ================== -->
<div class="section">
<h3>ุซุงูุซุงู: ุจูุงูุงุช ุงููุตุงุนุฏ</h3>

<div class="grid">
  <div>
    <label>ุนุฏุฏ ุงููุตุงุนุฏ</label>
    <input id="lifts" type="number" min="1">
  </div>

  <div>
    <label>ููุน ุงููุตุนุฏ</label>
    <select id="elevatorType">
      <option value="passenger">ุฑูุงุจ</option>
      <option value="service">ุฎุฏูุฉ</option>
      <option value="panoramic">ุจุงููุฑุงูู</option>
    </select>
  </div>

  <div>
    <label>ูุงุฑูุฉ ุงููุตุนุฏ</label>
    <input id="brandName" placeholder="Otis / KONE / Mitsubishi ...">
  </div>

  <div>
    <label>ุญูููุฉ ุงููุตุนุฏ (ูุฌู)</label>
    <select id="capacity">
      <option value="">-- ุงุฎุชุฑ --</option>
      <option value="3000">150 โ 320</option>
      <option value="3500">350 โ 550</option>
      <option value="4000">600 โ 900</option>
      <option value="4500">901 โ 1100</option>
      <option value="5000">1101 โ 1500</option>
      <option value="5500">1501 โ 1750</option>
    </select>
  </div>

  <div>
    <label>ุนุฏุฏ ุงูุทูุงุจู</label>
    <input id="floors" type="number" min="1">
  </div>

  <div>
    <label>ููุน ุงููุจูู</label>
    <select id="building">
      <option value="private">ุฎุงุต</option>
      <option value="government">ุญูููู</option>
    </select>
  </div>
</div>
</div>

<!-- ================== ูุทุงู ุงูุตูุงูุฉ ================== -->
<div class="section">
<h3>ุฑุงุจุนุงู: ูุทุงู ุงูุตูุงูุฉ</h3>

<div class="grid">
  <div>
    <label>ุนุฏุฏ ุงูุฒูุงุฑุงุช ุงูุฏูุฑูุฉ</label>
    <select id="visits">
      <option value="monthly">ุฒูุงุฑุฉ ุดูุฑูุฉ</option>
      <option value="bimonthly">ุฒูุงุฑุฉ ูู ุดูุฑูู</option>
    </select>
  </div>

  <div>
    <label>ุชุฏุฑูุจ ุฅููุงุฐ ุงููุญุชุฌุฒูู</label>
    <select id="training">
      <option value="yes">ูุนู</option>
      <option value="no">ูุง</option>
    </select>
  </div>

  <div>
    <label>ูุทุน ุงูุบูุงุฑ</label>
    <select id="spareParts">
      <option value="excluded">ุบูุฑ ูุดูููุฉ</option>
      <option value="included">ูุดูููุฉ (ุจุนุฑุถ ุฎุงุต)</option>
    </select>
  </div>

  <div>
    <label>ุฎุฏูุฉ ุงูุทูุงุฑุฆ</label>
    <select id="emergency">
      <option value="normal">ุฃููุงุช ุงูุฏูุงู</option>
      <option value="extended">ุฎุงุฑุฌ ุงูุฏูุงู (ุฅุถุงูู)</option>
    </select>
  </div>
</div>

<label style="margin-top:15px">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
<textarea id="notes"></textarea>
<button onclick="saveAndPrintContract()">๐พ ุญูุธ ูุทุจุงุนุฉ ุงูุนูุฏ</button>

</div>

<!-- ================== ูุฑุงุฌุนุฉ ุงูุนูุฏ ================== -->
<div class="section" id="reviewSection" style="display:none">
<h3>ุฎุงูุณุงู: ูุฑุงุฌุนุฉ ุงูุนูุฏ</h3>
<div class="review-box" id="reviewBox"></div>
<button onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ / PDF</button>
</div>

</div>
  <div class="section">
  <h3>ุณุฌู ุนููุฏ ุงูุตูุงูุฉ ุงูููุงุฆูุฉ</h3>

  <table border="1" width="100%" cellpadding="8" style="border-collapse:collapse">
    <thead style="background:#f3f4f6">
      <tr>
        <th>#</th>
        <th>ุฑูู ุงูุนูุฏ</th>
        <th>ุงูุนููู</th>
        <th>ุนุฏุฏ ุงููุตุงุนุฏ</th>
        <th>ูููุฉ ุงูุนูุฏ</th>
        <th>ุงููุบุฉ</th>
        <th>ุชุงุฑูุฎ ุงูุนูุฏ</th>
        <th>ุฅุฌุฑุงุกุงุช</th>
      </tr>
    </thead>
    <tbody id="contractsTable"></tbody>
  </table>
</div>


<script>
let customer=null;

document.addEventListener('DOMContentLoaded',()=>{
  const saved=localStorage.getItem('rkl_selected_customer');
  if(!saved){alert('ูู ูุชู ุงุฎุชูุงุฑ ุนููู');return;}
  customer=JSON.parse(saved);

  document.getElementById('customerInfo').innerHTML=`
    <p><b>ุงุณู ุงูุนููู:</b> ${customer.customer_name}</p>
    <p><b>ุงูุฌูุงู:</b> ${customer.mobile}</p>
    <p><b>ุงูุนููุงู:</b> ${customer.city} โ ${customer.full_address||''}</p>
  `;
});

function calculateTotal(){
  let price = Number(document.getElementById('capacity').value);
  const lifts = Number(document.getElementById('lifts').value);
  const floors = Number(document.getElementById('floors').value);
  const building = document.getElementById('building').value;
  const brand = document.getElementById('brandName').value.toLowerCase();

  if(floors > 2) price *= 1.10;
  if(building === 'government') price *= 1.50;
  if(['otis','kone','mitsubishi','schindler'].some(b=>brand.includes(b))){
    price += 2000;
  }

  const subtotal = price * lifts;
  const vat = subtotal * 0.15;
  return {
    pricePerLift: price,
    vat,
    total: subtotal + vat
  };
}
function saveAndPrintContract(){

  // ุชุญูู ูุจุฏุฆู
  if(!customer){
    alert('ุจูุงูุงุช ุงูุนููู ุบูุฑ ููุฌูุฏุฉ');
    return;
  }

  // ุชุญูู ูู ุงูุญููู ุงูุฅูุฒุงููุฉ
  const required = ['lang','contractDate','lifts','capacity','floors'];
  for(const id of required){
    if(!document.getElementById(id).value){
      alert('ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู ุงูุฅูุฒุงููุฉ');
      return;
    }
  }

  // ุญุณุงุจ ุงูุณุนุฑ
  const calc = calculateTotal();

  // ุฅูุดุงุก ุงูุนูุฏ
  const contract = {
    id: 'PMC-' + Date.now(),
    customer: customer.customer_name,
    lifts: document.getElementById('lifts').value,
    total: calc.total.toFixed(2) + ' ุฑูุงู',
    lang: document.getElementById('lang').value,
    date: document.getElementById('contractDate').value,
    content: generateFullContractText()
  };

  // ุญูุธ ูู LocalStorage
  const contracts = JSON.parse(
    localStorage.getItem('rkl_maintenance_contracts') || '[]'
  );

  contracts.push(contract);
  localStorage.setItem(
    'rkl_maintenance_contracts',
    JSON.stringify(contracts)
  );

  // ุชุญุฏูุซ ุงูุฌุฏูู
  renderContractsTable();

  // ูุชุญ ุงูุทุจุงุนุฉ
  openPrintView(contract);
}

function generateFullContractText(){
  return `
ุนูุฏ ุตูุงูุฉ ููุงุฆูุฉ ูููุตุงุนุฏ

ุจุชูููู ูู ุงููู ุชู ุงูุงุชูุงู ุจุชุงุฑูุฎ ${document.getElementById('contractDate').value} ุจูู ูู ูู:

ุงูุทุฑู ุงูุฃูู:
ูุคุณุณุฉ ุขุฑ ูู ุงู RKL ูููุตุงุนุฏ ูุงูุณูุงูู ุงูููุฑุจุงุฆูุฉ
ุณุฌู ุชุฌุงุฑู ุฑูู 1010709355

ุงูุทุฑู ุงูุซุงูู:
${customer.customer_name}
ุฑูู ุงูุฌูุงู: ${customer.mobile}
ุงูุนููุงู: ${customer.city}

ููุฏูุฉ ุงูุนูุฏ:
ุจูุงุกู ุนูู ุฑุบุจุฉ ุงูุทุฑู ุงูุซุงูู ุจุตูุงูุฉ ุนุฏุฏ (${document.getElementById('lifts').value}) ูุตุนุฏุ
ููุฏ ุชู ุงูุงุชูุงู ุนูู ูุง ููู:

1- ููุชุฒู ุงูุทุฑู ุงูุฃูู ุจุชูุฏูู ุงูุตูุงูุฉ ุงูุฏูุฑูุฉ ูุฑุฉ ูู ุดูุฑ.
2- ุชุดูู ุงูุตูุงูุฉ ุงููุญุต ูุงูุชุดุญูู ูุงูุชูุธูู ููุญุต ุฃูุธูุฉ ุงูุฃูุงู.
3- ูุง ุชุดูู ุงูุตูุงูุฉ ูุทุน ุงูุบูุงุฑ.
4- ูููุฉ ุงูุนูุฏ ุญุณุจ ุงูุฌุฏูู ุงููุชูู ุนููู.
5- ูุฎุถุน ูุฐุง ุงูุนูุฏ ูุฃูุธูุฉ ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ.

ุงูุทุฑู ุงูุฃูู: ูุคุณุณุฉ ุขุฑ ูู ุงู
ุงูุชูููุน: ___________

ุงูุทุฑู ุงูุซุงูู: ${customer.customer_name}
ุงูุชูููุน: ___________
`;
}
function openPrintView(contract){
  const w = window.open('', '_blank');
  w.document.write(`
    <html dir="rtl">
    <head>
      <title>ุทุจุงุนุฉ ุนูุฏ ุตูุงูุฉ</title>
      <style>
        body{font-family:Cairo;padding:40px}
        textarea{width:100%;height:90vh;border:none;font-size:15px}
      </style>
    </head>
    <body>
      <textarea contenteditable="true">${contract.content}</textarea>
      <br><br>
      <button onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ</button>
    </body>
    </html>
  `);
}
function renderContractsTable(){
  const tbody = document.getElementById('contractsTable');
  const contracts = JSON.parse(localStorage.getItem('rkl_maintenance_contracts') || '[]');
  tbody.innerHTML = '';

  contracts.forEach((c, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${c.id}</td>
        <td>${c.customer}</td>
        <td>${c.lifts}</td>
        <td>${c.total}</td>
        <td>${c.lang}</td>
        <td>${c.date}</td>
        <td>
          <button onclick='openPrintView(${JSON.stringify(c)})'>ุทุจุงุนุฉ</button>
        </td>
      </tr>
    `;
  });
}

document.addEventListener('DOMContentLoaded', renderContractsTable);


function reviewContract(){
  const required=['lang','contractDate','lifts','capacity','floors'];
  for(const id of required){
    if(!document.getElementById(id).value){
      alert('ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู ุงูุฅูุฒุงููุฉ');
      return;
    }
  }

  let price=Number(document.getElementById('capacity').value);
  const lifts=Number(document.getElementById('lifts').value);
  const floors=Number(document.getElementById('floors').value);
  const building=document.getElementById('building').value;
  const brand=document.getElementById('brandName').value.toLowerCase();

  if(floors>2) price*=1.10;
  if(building==='government') price*=1.50;
  if(['otis','kone','mitsubishi','schindler'].some(b=>brand.includes(b))){
    price+=2000;
  }

  const vat=price*lifts*0.15;
  const total=price*lifts+vat;

  document.getElementById('reviewBox').innerHTML=`
    <p><b>ุนุฏุฏ ุงููุตุงุนุฏ:</b> ${lifts}</p>
    <p><b>ุงูุณุนุฑ ุงูุณููู ูููุตุนุฏ:</b> ${price.toFixed(2)} ุฑูุงู</p>
    <p><b>ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ 15%:</b> ${vat.toFixed(2)} ุฑูุงู</p>
    <p><b>ุฅุฌูุงูู ูููุฉ ุงูุนูุฏ:</b> <strong>${total.toFixed(2)} ุฑูุงู</strong></p>
    <p><b>ููุงุญุธุงุช:</b> ${document.getElementById('notes').value||'โ'}</p>
  `;

  document.getElementById('reviewSection').style.display='block';
}
</script>

</body>
</html>
