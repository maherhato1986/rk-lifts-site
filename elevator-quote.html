<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>نموذج عرض سعر مصعد</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 0;
        }

        .page-wrapper {
            max-width: 1100px;
            margin: 30px auto;
            padding: 16px;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
            gap: 16px;
        }
        .table-wrapper {
    margin-top: 10px;
    overflow-x: auto;
}

#quotes-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

#quotes-table th,
#quotes-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #e5e7eb;
    text-align: right;
    white-space: nowrap;
}

#quotes-table th {
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
}


        .card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            padding: 18px 20px;
            margin-bottom: 16px;
        }

        .card-header {
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 12px;
            padding-bottom: 6px;
        }

        .card-header h1,
        .card-header h2 {
            margin: 0;
            color: #111827;
        }

        .card-header h1 {
            font-size: 22px;
        }

        .card-header h2 {
            font-size: 18px;
        }

        .card-header p {
            margin: 4px 0 0;
            font-size: 13px;
            color: #6b7280;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 12px 14px;
        }

        label {
            display: block;
            font-size: 13px;
            color: #374151;
            margin-bottom: 4px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 14px;
            box-sizing: border-box;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.25);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .hint {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .section-title {
            margin: 10px 0 4px;
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .inline {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .inline input[type="checkbox"] {
            width: auto;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .number-box {
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 8px 10px;
            background: #f9fafb;
        }

        .number-box .label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .number-box .value {
            font-weight: 600;
            font-size: 15px;
            color: #111827;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #ecfdf5;
            color: #166534;
            margin-right: 6px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            border: none;
            padding: 7px 16px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.05s;
        }

        .btn-primary {
            background: #059669;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #047857;
            box-shadow: 0 4px 10px rgba(4, 120, 87, 0.25);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 900px) {
            .layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>
<body>
<div class="page-wrapper">

    <div class="layout">
        <!-- بطاقة إدخال بيانات العرض -->
        <div>
            <div class="card">
                <div class="card-header">
                    <h1>نموذج عرض سعر مصعد</h1>
                    <p>واجهة عامة لحساب عرض سعر بناءً على بيانات الماركة والسعة والسرعة وعدد الأدوار (FUJI MRL كمرحلة أولى).</p>
                </div>

                <form id="quote-form">
                    <div class="section-title">١. بيانات عامة</div>
                    <div class="form-grid">
                       <div class="section-title">١. اختيار العميل</div>
<div class="form-grid">
    <div>
        <label for="customer_select">اختر عميلًا من السجل (محفوظ في هذا الجهاز)</label>
        <select id="customer_select">
            <option value="">— اختر عميلًا (اختياري) —</option>
        </select>
        <div class="hint">
            يتم سحب هذه القائمة من صفحة "إضافة / إدارة بيانات العميل" (localStorage).
        </div>
    </div>

    <div>
        <label for="customer_name">اسم العميل (يمكن تعديله يدويًا)</label>
        <input type="text" id="customer_name" placeholder="مثال: السادة / شركة ...." />
    </div>

    <div>
        <label for="project_name">اسم المشروع (اختياري)</label>
        <input type="text" id="project_name" placeholder="مثال: مشروع مبنى المكاتب - الرياض" />
    </div>
</div>


                    <div class="section-title">٢. اختيار نوع المصعد</div>
                    <div class="form-grid">
                        <div>
                            <label for="brand">
                                الماركة / نوع النظام
                            </label>
                            <select id="brand" required>
                                <option value="">اختر الماركة...</option>
                                <option value="FUJI_MRL">FUJI – MRL Passenger (من الصين)</option>
                                <!-- لاحقًا: نضيف خيارات أخرى مثل VERTILIFT, FUJI_HOME, Local Assembly ... -->
                            </select>
                            <div class="hint">حاليًا المربوط فعليًا هو FUJI – MRL، والباقي نضيفه لاحقًا بنفس الفكرة.</div>
                        </div>

                        <div>
                            <label for="capacity">السعة (kg)</label>
                            <select id="capacity" required disabled>
                                <option value="">اختر السعة...</option>
                            </select>
                        </div>

                        <div>
                            <label for="speed">السرعة (m/s)</label>
                            <select id="speed" required disabled>
                                <option value="">اختر السرعة...</option>
                            </select>
                        </div>

                        <div>
                            <label for="floors">عدد الأدوار (Stops)</label>
                            <input type="number" id="floors" min="2" value="2" required />
                            <div class="hint">السعر الأساسي يشمل عادةً دورين. الزيادة تُحسب لكل دور إضافي.</div>
                        </div>
                    </div>
                        <div class="section-title">٢.١ عدد المصاعد لهذه المواصفات</div>
<div class="form-grid">
    <div>
        <label for="lifts_count">عدد المصاعد بنفس المواصفات</label>
        <input type="number" id="lifts_count" min="1" value="1" />
        <div class="hint">
            إذا كانت جميع المصاعد بنفس الحمولة والسرعة وعدد الأدوار، ضع العدد الكلي هنا (مثال: 5 مصاعد).
            إذا كانت هناك مواصفات مختلفة، احسب كل مجموعة لوحدها (مثال: 3 × 800kg ثم 2 × 1000kg).
        </div>
    </div>
</div>


                    <div class="section-title">٣. إعدادات التسعير</div>
                    <div class="form-grid">
                        <div>
                            <label for="currency">العملة الأساسية للحساب</label>
                            <select id="currency">
                                <option value="SAR">ريال سعودي (SAR)</option>
                                <option value="USD">دولار أمريكي (USD)</option>
                            </select>
                        </div>

                        <div>
                            <label for="vat_rate">نسبة الضريبة %</label>
                            <input type="number" id="vat_rate" value="15" step="0.1" />
                        </div>

                        <div>
                            <label>خيارات إضافية</label>
                            <div class="inline">
                                <input type="checkbox" id="include_vat" checked />
                                <label for="include_vat" style="margin: 0;">عرض السعر شامل الضريبة</label>
                            </div>
                        </div>
                    </div>

                    <div class="actions">
                        <button type="button" class="btn btn-primary" id="calc-btn">حساب عرض السعر</button>
                        <button type="reset" class="btn btn-secondary" id="reset-btn">إعادة تعيين</button>
                    </div>
                </form>
            </div>

            <!-- بطاقة الأرقام التفصيلية -->
            <div class="card">
                <div class="card-header">
                    <h2>النتائج الرقمية</h2>
                </div>

                <div id="numbers-wrapper">
                    <div class="hint">اختر الماركة والسعة والسرعة ثم اضغط "حساب عرض السعر" لعرض التفاصيل.</div>
                </div>
            </div>
        </div>

        <!-- بطاقة ملخص عرض السعر النصي -->
        <div>
            <div class="card">
                <div class="card-header">
                    <h2>ملخص عرض السعر (نصي)</h2>
                    <p>يمكنك نسخ هذا النص ولصقه في عرض سعر رسمي أو ملف Word.</p>
                </div>

                <textarea id="quote_text" placeholder="سيتم توليد نص عرض السعر هنا بعد الحساب..."></textarea>

                <div class="actions">
                    <button type="button" class="btn btn-secondary" id="copy-btn">نسخ النص</button>
                </div>
            </div>
        </div>
    </div>
</div>
            <!-- بطاقة سجل عروض الأسعار -->
        <div style="margin-top: 16px;">
            <div class="card">
                <div class="card-header">
                    <h2>سجل عروض الأسعار في هذا الجهاز</h2>
                    <p>يمكنك حفظ عرض السعر الحالي في السجل ثم تصدير جميع العروض إلى ملف Excel (CSV).</p>
                </div>

                <div class="actions">
                    <button type="button" class="btn btn-primary" id="save-quote-btn">
                        حفظ عرض السعر الحالي في السجل
                    </button>
                    <button type="button" class="btn btn-secondary" id="export-quotes-btn">
                        تصدير السجل إلى Excel (CSV)
                    </button>
                    <button id="printOfferButton" type="button">
    طباعة عرض السعر
</button>

                </div>

                <div class="table-wrapper">
                    <table id="quotes-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>رقم عرض السعر</th>
                                <th>التاريخ</th>
                                <th>اسم العميل</th>
                                <th>اسم المشروع</th>
                                <th>الماركة / السعة / السرعة</th>
                                <th>عدد المصاعد</th>
                                <th>الإجمالي شامل الضريبة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- سيتم تعبئته تلقائيًا من JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

<script>
    // ======================= ثوابت الحسبة (يمكن تعديلها لاحقًا) =======================
const COST_PARAMS = {
    shippingUsdPerLift: 500,
    insurancePercent: 1,
    clearanceSar: 1200,
    inlandTransportSar: 1500,
    installationSar: 9000,   // ← عدّلها إلى التكلفة الحقيقية
    commissioningSar: 2000,  // ← عدّل حسب رغبتك
    overheadPercent: 12,     // ← لو تريد تقليل أو رفع المصاريف التشغيلية
    profitPercent: 25
};


        // تخزين عروض الأسعار
    const QUOTES_STORAGE_KEY = 'rkl_quotes';
    let lastQuoteSnapshot = null; // آخر عرض سعر محسوب (لنحفظه في السجل)


    // ========================== ربط واجهة عرض السعر ببيانات العملاء ==========================
    const CUSTOMER_STORAGE_KEY = 'rkl_customers';

    let currentBrandData = null;
    let selectedCustomer = null; // آخر عميل تم تحميله في النموذج

    function loadStoredCustomers() {
        try {
            return JSON.parse(localStorage.getItem(CUSTOMER_STORAGE_KEY) || '[]');
        } catch (e) {
            console.error('خطأ في قراءة بيانات العملاء من localStorage', e);
            return [];
        }
    }

    function populateCustomerDropdown() {
        const select = document.getElementById('customer_select');
        if (!select) return;

        const customers = loadStoredCustomers();

        select.innerHTML = '<option value="">— اختر عميلًا (اختياري) —</option>';

        customers.forEach((c, index) => {
            const name = c.customer_name || '(بدون اسم)';
            const city = c.city ? ` - ${c.city}` : '';
            const opt = document.createElement('option');
            opt.value = index.toString();
            opt.textContent = `${name}${city}`;
            select.appendChild(opt);
        });

        if (!customers.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'لا توجد بيانات عملاء محفوظة في هذا المتصفح';
            select.appendChild(opt);
            select.disabled = true;
        } else {
            select.disabled = false;
        }
    }

    function applyCustomerToForm(customer) {
        selectedCustomer = customer || null;

        const nameInput = document.getElementById('customer_name');
        const projectInput = document.getElementById('project_name');

        if (customer) {
            if (nameInput) nameInput.value = customer.customer_name || '';
            if (projectInput && !projectInput.value) {
                const city = customer.city ? ` - ${customer.city}` : '';
                projectInput.value = `مشروع مصاعد للعميل ${customer.customer_name || ''}${city}`;
            }
        }
    }

        // ========================== تخزين عروض الأسعار في LocalStorage ==========================

    function loadStoredQuotes() {
        try {
            return JSON.parse(localStorage.getItem(QUOTES_STORAGE_KEY) || '[]');
        } catch (e) {
            console.error('خطأ في قراءة عروض الأسعار من localStorage', e);
            return [];
        }
    }

  function saveQuotesToStorage(quotes) {
    try {
        localStorage.setItem(QUOTES_STORAGE_KEY, JSON.stringify(quotes));
    } catch (e) {
        console.error("خطأ أثناء حفظ عروض الأسعار:", e);
        alert("تعذر حفظ عرض السعر في هذا الجهاز.");
    }
}


    function renderQuotesTable() {
        const tbody = document.querySelector('#quotes-table tbody');
        if (!tbody) return;

        const quotes = loadStoredQuotes();
        tbody.innerHTML = '';

        if (!quotes.length) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 8;
            td.textContent = 'لا توجد عروض أسعار محفوظة في هذا الجهاز حتى الآن.';
            td.style.textAlign = 'center';
            td.style.color = '#9ca3af';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        quotes.forEach((q, index) => {
            const tr = document.createElement('tr');

            const dateStr = q.timestamp ? q.timestamp.slice(0, 10) : '';
            const totalStr = formatCurrency(q.totalWithVat, q.currency || 'SAR');

            const cols = [
                index + 1,
                q.quoteNumber || '',
                dateStr,
                q.customerName || '',
                q.projectName || '',
                `${q.brandLabel || q.brandKey || ''} / ${q.capacity || ''} / ${q.speed || ''}`,
                q.liftsCount || '',
                totalStr
            ];

            cols.forEach(val => {
                const td = document.createElement('td');
                td.textContent = val;
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }



    // ========================== تعريف الماركات وملفات الأسعار ==========================
    const BRAND_SOURCES = {
        'FUJI_MRL': {
            label: 'FUJI – MRL Passenger',
            jsonPath: 'https://maherhato1986.github.io/rk-lifts-site/fuji_mrl_prices.json'

        }
        // لاحقًا يمكن إضافة ماركات أخرى هنا
    };

    async function loadBrandData(brandKey) {
        const config = BRAND_SOURCES[brandKey];
        if (!config) {
            currentBrandData = null;
            return null;
        }

        const res = await fetch(config.jsonPath);
        if (!res.ok) {
            alert('تعذر تحميل ملف الأسعار للماركة المحددة.');
            currentBrandData = null;
            return null;
        }

        const data = await res.json();
        currentBrandData = data;
        return data;
    }

    function fillCapacityOptions() {
        const capacitySelect = document.getElementById('capacity');
        const speedSelect = document.getElementById('speed');

        capacitySelect.innerHTML = '<option value="">اختر السعة...</option>';
        speedSelect.innerHTML = '<option value="">اختر السرعة...</option>';
        speedSelect.disabled = true;

        if (!currentBrandData || !currentBrandData.models) {
            capacitySelect.disabled = true;
            return;
        }

        const capacities = Array.from(
            new Set(currentBrandData.models.map(m => m.capacityKg))
        );

        capacities.forEach(cap => {
            const opt = document.createElement('option');
            opt.value = cap;
            opt.textContent = cap + ' kg';
            capacitySelect.appendChild(opt);
        });

        capacitySelect.disabled = false;
    }

    function fillSpeedOptions() {
        const capacitySelect = document.getElementById('capacity');
        const speedSelect = document.getElementById('speed');

        const selectedCapacity = capacitySelect.value;
        speedSelect.innerHTML = '<option value="">اختر السرعة...</option>';

        if (!currentBrandData || !selectedCapacity) {
            speedSelect.disabled = true;
            return;
        }

        const speeds = Array.from(
            new Set(
                currentBrandData.models
                    .filter(m => m.capacityKg === selectedCapacity)
                    .map(m => m.speedMps)
            )
        ).sort((a, b) => a - b);

        speeds.forEach(sp => {
            const opt = document.createElement('option');
            opt.value = sp;
            opt.textContent = sp + ' m/s';
            speedSelect.appendChild(opt);
        });

        speedSelect.disabled = false;
    }

    function findModel(capacity, speed) {
        if (!currentBrandData || !currentBrandData.models) return null;
        return currentBrandData.models.find(
            m => m.capacityKg === capacity && Number(m.speedMps) === Number(speed)
        );
    }

    function formatCurrency(value, currency) {
        if (isNaN(value)) return '-';
        const v = Number(value).toFixed(2);
        return currency === 'USD'
            ? `${v} USD`
            : `${v} SAR`;
    }

    function generateNumbersView(result, model, currency) {
        const wrapper = document.getElementById('numbers-wrapper');

        const per = (v) => formatCurrency(v, currency);
        const both = (perLift, total) =>
            `${per(perLift)} <span style="font-size:11px;color:#6b7280;">/ لكل مصعد</span><br>` +
            `${per(total)} <span style="font-size:11px;color:#6b7280;">إجمالي (${result.liftsCount})</span>`;

        wrapper.innerHTML = `
        <div class="numbers-grid">
            <div class="number-box">
                <div class="label">سعر المصنع (FOB)</div>
                <div class="value">
                    ${both(result.factoryCostPerLift, result.factoryCost)}
                </div>
            </div>

            <div class="number-box">
                <div class="label">الشحن + التأمين</div>
                <div class="value">
                    ${both(result.shippingInsurancePerLift, result.shippingInsuranceCost)}
                </div>
            </div>

            <div class="number-box">
                <div class="label">التخليص + النقل الداخلي</div>
                <div class="value">
                    ${both(result.clearanceTransportPerLift, result.clearanceTransportCost)}
                </div>
            </div>

            <div class="number-box">
                <div class="label">التركيب + التشغيل</div>
                <div class="value">
                    ${both(result.installationCommissioningPerLift, result.installationCommissioningCost)}
                </div>
            </div>

            <div class="number-box">
                <div class="label">مصاريف تشغيل (${result.overheadPercent}%)</div>
                <div class="value">
                    ${both(result.overheadPerLift, result.overheadCost)}
                </div>
            </div>

            <div class="number-box">
                <div class="label">التكلفة الكلية قبل الربح</div>
                <div class="value">
                    ${both(result.costBeforeProfitPerLift, result.costBeforeProfit)}
                </div>
            </div>

            <div class="number-box">
                <div class="label">هامش الربح (${result.profitPercent}%)</div>
                <div class="value">
                    ${both(result.profitPerLift, result.profitAmount)}
                </div>
            </div>

            <div class="number-box">
                <div class="label">سعر البيع قبل الضريبة</div>
                <div class="value">
                    ${both(result.totalBeforeVatPerLift, result.totalBeforeVat)}
                </div>
            </div>

            <div class="number-box">
                <div class="label">قيمة الضريبة (${result.vatRate}%)</div>
                <div class="value">
                    ${both(result.vatAmountPerLift, result.vatAmount)}
                </div>
            </div>

            <div class="number-box">
                <div class="label">الإجمالي ${result.includeVat ? 'شامل الضريبة' : 'بدون الضريبة'}</div>
                <div class="value">
                    ${both(result.totalWithVatPerLift, result.totalWithVat)}
                </div>
            </div>
        </div>

        <div style="margin-top: 10px; font-size: 12px; color:#6b7280;">
            <span class="badge">${BRAND_SOURCES[result.brandKey].label}</span>
            عدد المصاعد: ${result.liftsCount} – سعة ${model.capacityKg} kg – سرعة ${model.speedMps} m/s – عدد الأدوار: ${result.floors} (الأساسي ${model.baseFloors} دور).
        </div>
    `;
    }

    function generateQuoteText(result, model, currency) {
        const manualCustomerName = document.getElementById('customer_name').value.trim();
        const projectName = document.getElementById('project_name').value.trim();

        const currencyLabel = currency === 'USD' ? 'دولار أمريكي' : 'ريال سعودي';
        const finalCustomerName = selectedCustomer?.customer_name || manualCustomerName || 'العميل الكريم';

        const lines = [];

        lines.push(`السادة / ${finalCustomerName}`);
        if (projectName) {
            lines.push(`الموضوع: عرض سعر توريد وتركيب مصعد لمشروع (${projectName}).`);
        } else {
            lines.push(`الموضوع: عرض سعر توريد وتركيب مصعد.`);
        }

        lines.push('');
        lines.push(`نود أن نشكركم على تواصلكم مع مؤسسة آر كي ال RKL، ويسرّنا أن نقدّم لكم عرض السعر التالي:`);

        if (selectedCustomer) {
            lines.push('');
            lines.push(`بيانات العميل المسجّلة لدينا:`);
            if (selectedCustomer.customer_type === 'company') {
                lines.push(`- نوع العميل: شركة / مؤسسة.`);
            } else if (selectedCustomer.customer_type === 'individual') {
                lines.push(`- نوع العميل: فرد.`);
            }
            if (selectedCustomer.contact_person) {
                lines.push(`- الشخص المخوّل بالتوقيع: ${selectedCustomer.contact_person}`);
            }
            if (selectedCustomer.cr_number) {
                lines.push(`- السجل التجاري: ${selectedCustomer.cr_number}`);
            }
            if (selectedCustomer.tax_number) {
                lines.push(`- الرقم الضريبي: ${selectedCustomer.tax_number}`);
            }
            const addrParts = [
                selectedCustomer.city,
                selectedCustomer.district,
                selectedCustomer.street,
                selectedCustomer.full_address
            ].filter(Boolean);
            if (addrParts.length) {
                lines.push(`- العنوان: ${addrParts.join(' - ')}`);
            }
            if (selectedCustomer.mobile) {
                lines.push(`- جوال رقم: ${selectedCustomer.mobile}`);
            }
            if (selectedCustomer.email) {
                lines.push(`- البريد الإلكتروني: ${selectedCustomer.email}`);
            }
        }

        lines.push(``);
        lines.push(`1) بيانات المصعد:`);
        lines.push(`- الماركة: ${BRAND_SOURCES[result.brandKey].label}`);
        lines.push(`- عدد المصاعد بهذه المواصفات: ${result.liftsCount} مصعد/مصاعد.`);
        lines.push(`- السعة: ${model.capacityKg} kg`);
        lines.push(`- السرعة: ${model.speedMps} m/s`);
        lines.push(`- عدد الأدوار: ${result.floors} دور (السعر الأساسي من المصنع يشمل ${model.baseFloors} دور).`);

        lines.push('');
        lines.push(`2) هيكل التكلفة (${currencyLabel}):`);
        lines.push(`- سعر المصنع (FOB): ${formatCurrency(result.factoryCost, currency)}`);
        lines.push(`- الشحن والتأمين: ${formatCurrency(result.shippingInsuranceCost, currency)}`);
        lines.push(`- التخليص الجمركي + النقل الداخلي: ${formatCurrency(result.clearanceTransportCost, currency)}`);
        lines.push(`- أجور التركيب والتشغيل: ${formatCurrency(result.installationCommissioningCost, currency)}`);
        lines.push(`- مصاريف تشغيل (${result.overheadPercent}%): ${formatCurrency(result.overheadCost, currency)}`);
        lines.push(`- التكلفة الكلية قبل الربح: ${formatCurrency(result.costBeforeProfit, currency)}`);
        lines.push(`- هامش الربح (${result.profitPercent}%): ${formatCurrency(result.profitAmount, currency)}`);

        lines.push('');
        lines.push(`3) الأسعار النهائية (${currencyLabel}):`);
        lines.push(`- سعر البيع قبل الضريبة: ${formatCurrency(result.totalBeforeVat, currency)}`);
        lines.push(`- سعر البيع قبل الضريبة للمصعد الواحد: ${formatCurrency(result.totalBeforeVatPerLift, currency)}`);
        lines.push(`- قيمة ضريبة القيمة المضافة (${result.vatRate}%): ${formatCurrency(result.vatAmount, currency)}`);
        lines.push(`- الإجمالي ${result.includeVat ? 'شامل' : 'بدون'} ضريبة القيمة المضافة: ${formatCurrency(result.totalWithVat, currency)}.`);

        lines.push('');
        lines.push(`*ملاحظات:*`);
        lines.push(`- بلد المنشأ: ${model.notes || 'حسب عرض المصنع'}.`);
        lines.push(`- نوع الماكينة: ${model.machineType || 'حسب المواصفات'} – نوع الأبواب: ${model.doorType || 'حسب العرض الفني'}.`);
        lines.push(`- الأسعار لا تشمل الأعمال المدنية والكهربائية إلا إذا نُصّ على خلاف ذلك في العرض الفني التفصيلي.`);
        lines.push('');
        lines.push(`هذا العرض مبدئي، ويمكن تعديله بناءً على المخططات النهائية ومتطلبات الاستشاري وشروط المشروع.`);
        lines.push('');
        lines.push(`مع خالص التحية والتقدير،`);
        lines.push(`مؤسسة آر كي ال RKL للمصاعد والسلالم الكهربائية.`);

        document.getElementById('quote_text').value = lines.join('\n');
    }

    async function calculateQuote() {
        const brandKey = document.getElementById('brand').value;
        const capacity = document.getElementById('capacity').value;
        const speed = document.getElementById('speed').value;
        const floors = Number(document.getElementById('floors').value);
        const liftsCount = Number(document.getElementById('lifts_count').value) || 1;
        const currency = document.getElementById('currency').value;
        const vatRate = Number(document.getElementById('vat_rate').value) || 0;
        const includeVat = document.getElementById('include_vat').checked;

        if (!brandKey || !capacity || !speed || !floors || floors < 2 || liftsCount < 1) {
            alert('يرجى اختيار الماركة والسعة والسرعة وإدخال عدد أدوار صحيح (٢ فأكثر) وعدد مصاعد واحد فأكثر.');
            return;
        }

        if (!currentBrandData) {
            await loadBrandData(brandKey);
        }
        if (!currentBrandData) {
            return;
        }

        const model = findModel(capacity, speed);
        if (!model) {
            alert('لم يتم العثور على توليفة مطابقة لهذه السعة والسرعة في ملف الأسعار.');
            return;
        }

        const rate = currentBrandData.exchangeRateToSAR || 1;

        // عدد الأدوار الإضافية عن سعر المصنع
        const extraFloors = Math.max(0, floors - model.baseFloors);

        // 1) سعر المصنع بالدولار + الزيادة لكل دور إضافي
        const factoryUsd = model.basePriceUsd + (model.extraPerFloorUsd * extraFloors);

        // تحويل لسعودي
        const factorySar = factoryUsd * rate;

        // 2) الشحن + التأمين
        const shippingSar = COST_PARAMS.shippingUsdPerLift * rate;
        const insuranceSar = factoryUsd * (COST_PARAMS.insurancePercent / 100) * rate;
        const shippingInsuranceSar = shippingSar + insuranceSar;

        // 3) التخليص + النقل الداخلي
        const clearanceTransportSar = COST_PARAMS.clearanceSar + COST_PARAMS.inlandTransportSar;

        // 4) التركيب + التشغيل
        const installationCommissioningSar = COST_PARAMS.installationSar + COST_PARAMS.commissioningSar;

        // 5) التكلفة المباشرة قبل مصاريف التشغيل
        const directCostSar =
            factorySar +
            shippingInsuranceSar +
            clearanceTransportSar +
            installationCommissioningSar;

        // 6) مصاريف التشغيل
        const overheadSar = directCostSar * (COST_PARAMS.overheadPercent / 100);

        // 7) تكلفة قبل الربح
        const costBeforeProfitSar = directCostSar + overheadSar;

        // 8) هامش الربح
        const profitSar = costBeforeProfitSar * (COST_PARAMS.profitPercent / 100);

        // 9) سعر البيع قبل الضريبة
        const totalBeforeVatSar = costBeforeProfitSar + profitSar;

        // تحويل حسب العملة المختارة (للمصعد الواحد)
        const divisor = (currency === 'USD') ? rate : 1;

        const factoryCostPerLift = factorySar / divisor;
        const shippingInsurancePerLift = shippingInsuranceSar / divisor;
        const clearanceTransportPerLift = clearanceTransportSar / divisor;
        const installationCommissioningPerLift = installationCommissioningSar / divisor;
        const overheadPerLift = overheadSar / divisor;
        const costBeforeProfitPerLift = costBeforeProfitSar / divisor;
        const profitPerLift = profitSar / divisor;
        const totalBeforeVatPerLift = totalBeforeVatSar / divisor;

        const vatAmountPerLift = totalBeforeVatPerLift * (vatRate / 100);
        const totalWithVatPerLift = includeVat
            ? totalBeforeVatPerLift + vatAmountPerLift
            : totalBeforeVatPerLift;

        // مجاميع لعدد المصاعد
        const factoryCostTotal = factoryCostPerLift * liftsCount;
        const shippingInsuranceTotal = shippingInsurancePerLift * liftsCount;
        const clearanceTransportTotal = clearanceTransportPerLift * liftsCount;
        const installationCommissioningTotal = installationCommissioningPerLift * liftsCount;
        const overheadTotal = overheadPerLift * liftsCount;
        const costBeforeProfitTotal = costBeforeProfitPerLift * liftsCount;
        const profitTotal = profitPerLift * liftsCount;
        const totalBeforeVatTotal = totalBeforeVatPerLift * liftsCount;
        const vatAmountTotal = vatAmountPerLift * liftsCount;
        const totalWithVatTotal = totalWithVatPerLift * liftsCount;

        const result = {
            brandKey,
            floors,
            liftsCount,
            // للمصعد الواحد
            factoryCostPerLift,
            shippingInsurancePerLift,
            clearanceTransportPerLift,
            installationCommissioningPerLift,
            overheadPerLift,
            costBeforeProfitPerLift,
            profitPerLift,
            totalBeforeVatPerLift,
            vatAmountPerLift,
            totalWithVatPerLift,
            // الإجمالي لكل المصاعد
            factoryCost: factoryCostTotal,
            shippingInsuranceCost: shippingInsuranceTotal,
            clearanceTransportCost: clearanceTransportTotal,
            installationCommissioningCost: installationCommissioningTotal,
            overheadCost: overheadTotal,
            costBeforeProfit: costBeforeProfitTotal,
            profitAmount: profitTotal,
            totalBeforeVat: totalBeforeVatTotal,
            vatRate,
            vatAmount: vatAmountTotal,
            totalWithVat: totalWithVatTotal,
            includeVat,
            overheadPercent: COST_PARAMS.overheadPercent,
            profitPercent: COST_PARAMS.profitPercent
        };

        generateNumbersView(result, model, currency);
        generateQuoteText(result, model, currency);

                // حفظ لقطة من هذا العرض لاستخدامها عند الضغط على "حفظ عرض السعر"
        const manualCustomerName = document.getElementById('customer_name').value.trim();
        const projectName = document.getElementById('project_name').value.trim();

        const finalCustomerName =
            (selectedCustomer?.customer_name || manualCustomerName || 'العميل الكريم').trim();

        const brandLabel = BRAND_SOURCES[brandKey]?.label || brandKey;

        lastQuoteSnapshot = {
            timestamp: new Date().toISOString(),
            customerName: finalCustomerName,
            projectName: projectName,
            brandKey,
            brandLabel,
            capacity: capacity + ' kg',
            speed: speed + ' m/s',
            floors,
            liftsCount,
            totalWithVat: result.totalWithVat,
            currency,
            vatRate,
            includeVat
        };

    }

    // ========================== تهيئة الأحداث عند تحميل الصفحة ==========================
       // ========================== تهيئة الأحداث عند تحميل الصفحة ==========================
    (function init() {
        // تحميل العملاء من صفحة customer-manager
        populateCustomerDropdown();

        // تحميل عروض الأسعار الموجودة مسبقًا في الجدول
        renderQuotesTable();

        const customerSelect = document.getElementById('customer_select');
        if (customerSelect) {
            customerSelect.addEventListener('change', () => {
                const idx = customerSelect.value;
                if (idx === '') {
                    selectedCustomer = null;
                    return;
                }
                const customers = loadStoredCustomers();
                const customer = customers[Number(idx)];
                if (customer) {
                    applyCustomerToForm(customer);
                }
            });
        }

        document.getElementById("printOfferButton").addEventListener("click", function () {
    // لو حاب تتأكد إنه في عرض مخزَّن قبل الانتقال:
    const saved = JSON.parse(localStorage.getItem(QUOTES_STORAGE_KEY) || "[]");
    if (!saved.length) {
        alert("لا يوجد أي عرض سعر محفوظ في السجل.");
        return;
    }

    // آخر عرض مخزَّن سيكون هو الحالي
    const lastQuote = saved[saved.length - 1];

    // خزّن رقم هذا العرض ليتم اختياره تلقائيًا في صفحة الطباعة
    localStorage.setItem(CURRENT_QUOTE_SELECTION_KEY, lastQuote.quoteNumber);

    // افتح صفحة نموذج عرض السعر الرسمي
    window.open("elevator-quote-offer.html", "_blank");
});


        // رسالة أولية في صندوق الأرقام
        document.getElementById('numbers-wrapper').innerHTML =
            '<div class="hint">ابدأ باختيار الماركة ثم بقية البيانات لحساب عرض السعر.</div>';

        // عند تغيير الماركة: تحميل ملف الأسعار وتجهيز السعات
        document.getElementById('brand').addEventListener('change', async function () {
            const brandKey = this.value;
            document.getElementById('capacity').disabled = true;
            document.getElementById('speed').disabled = true;

            if (!brandKey) {
                currentBrandData = null;
                document.getElementById('numbers-wrapper').innerHTML =
                    '<div class="hint">يرجى اختيار الماركة أولاً.</div>';
                return;
            }

            await loadBrandData(brandKey);
            if (!currentBrandData) return;

            fillCapacityOptions();
            document.getElementById('numbers-wrapper').innerHTML =
                '<div class="hint">اختر السعة والسرعة ثم أدخل عدد الأدوار واضغط "حساب عرض السعر".</div>';
        });

        // عند اختيار السعة: تعبئة السرعات المتاحة
        document.getElementById('capacity').addEventListener('change', fillSpeedOptions);

        // زر حساب عرض السعر
        document.getElementById('calc-btn').addEventListener('click', calculateQuote);

        // زر إعادة التعيين
        document.getElementById('reset-btn').addEventListener('click', function () {
            currentBrandData = null;
            document.getElementById('capacity').innerHTML = '<option value="">اختر السعة...</option>';
            document.getElementById('capacity').disabled = true;
            document.getElementById('speed').innerHTML = '<option value="">اختر السرعة...</option>';
            document.getElementById('speed').disabled = true;
            document.getElementById('numbers-wrapper').innerHTML =
                '<div class="hint">اختر الماركة والسعة والسرعة ثم أدخل عدد الأدوار.</div>';
            document.getElementById('quote_text').value = '';

            // إعادة تحميل قائمة العملاء والجدول
            populateCustomerDropdown();
            renderQuotesTable();

            selectedCustomer = null;
            if (customerSelect) customerSelect.value = '';
        });

        // زر نسخ النص
        document.getElementById('copy-btn').addEventListener('click', function () {
            const textarea = document.getElementById('quote_text');
            if (!textarea.value.trim()) {
                alert('لا يوجد نص لنسخه، قم بحساب عرض السعر أولاً.');
                return;
            }
            textarea.select();
            document.execCommand('copy');
            alert('تم نسخ نص عرض السعر.');
        });

        // زر حفظ عرض السعر الحالي في السجل
        const saveBtn = document.getElementById('save-quote-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                if (!lastQuoteSnapshot) {
                    alert('قم أولاً بحساب عرض السعر قبل حفظه في السجل.');
                    return;
                }

                const quotes = loadStoredQuotes();

                const nextIndex = quotes.length + 1;
                const today = new Date();
                const ymd = today.toISOString().slice(0, 10).replace(/-/g, '');
                const quoteNumber = `Q-${ymd}-${String(nextIndex).padStart(3, '0')}`;

                const entry = {
                    ...lastQuoteSnapshot,
                    quoteNumber
                };

                quotes.push(entry);
                saveQuotesToStorage(quotes);
                renderQuotesTable();
                alert('تم حفظ عرض السعر الحالي في سجل هذا الجهاز.');
            });
        }

        // زر تصدير السجل إلى CSV
        const exportBtn = document.getElementById('export-quotes-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                const quotes = loadStoredQuotes();
                if (!quotes.length) {
                    alert('لا يوجد أي عروض أسعار محفوظة للتصدير.');
                    return;
                }

                const header = [
                    '#',
                    'رقم عرض السعر',
                    'التاريخ',
                    'اسم العميل',
                    'اسم المشروع',
                    'الماركة',
                    'السعة',
                    'السرعة',
                    'عدد المصاعد',
                    'الإجمالي شامل الضريبة',
                    'العملة'
                ];

                const rows = [header.join(',')];

                quotes.forEach((q, index) => {
                    const dateStr = q.timestamp ? q.timestamp.slice(0, 10) : '';
                    const totalStr = (Number(q.totalWithVat) || 0).toFixed(2);

                    rows.push([
                        index + 1,
                        q.quoteNumber || '',
                        dateStr,
                        `"${q.customerName || ''}"`,
                        `"${q.projectName || ''}"`,
                        `"${q.brandLabel || q.brandKey || ''}"`,
                        q.capacity || '',
                        q.speed || '',
                        q.liftsCount || '',
                        totalStr,
                        q.currency || 'SAR'
                    ].join(','));
                });

                const csvContent = '\uFEFF' + rows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'rkl_elevator_quotes.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
    })();

    const CURRENT_QUOTE_SELECTION_KEY = "rkl_current_quote_number";


</script>



</body>
</html>





































